<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Z2B Legacy Builders</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/responsive.css">
    <style>
        :root {
            --navy-blue: #0A2647;
            --medium-blue: #144272;
            --light-blue: #205295;
            --gold: #FFD700;
            --orange: #FF6B35;
            --white: #FFFFFF;
            --success: #4CAF50;
            --danger: #f44336;
            --warning: #ff9800;
            --sidebar-width: 260px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--navy-blue), var(--medium-blue));
            min-height: 100vh;
        }

        /* Login Screen */
        #loginScreen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .login-card {
            background: var(--white);
            padding: 3rem 2rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 100%;
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header i {
            font-size: 4rem;
            color: var(--gold);
            margin-bottom: 1rem;
        }

        .login-header h1 {
            color: var(--navy-blue);
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: var(--medium-blue);
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            color: var(--navy-blue);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--gold);
        }

        .btn-login {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--gold), var(--orange));
            color: var(--navy-blue);
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .btn-login:hover {
            transform: translateY(-2px);
        }

        .error-message {
            background: #ffebee;
            color: var(--danger);
            padding: 0.8rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        /* Admin Dashboard Layout */
        #adminDashboard {
            display: none;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--navy-blue);
            padding: 2rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .sidebar-header h2 {
            color: var(--gold);
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .sidebar-header p {
            color: var(--white);
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 0.5rem;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.8rem 1.5rem;
            color: var(--white);
            text-decoration: none;
            transition: all 0.3s;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: linear-gradient(90deg, var(--gold), transparent);
            color: var(--navy-blue);
        }

        .sidebar-menu a i {
            font-size: 1.2rem;
            width: 24px;
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            flex: 1;
            padding: 2rem;
        }

        .top-bar {
            background: var(--white);
            padding: 1rem 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .top-bar h1 {
            color: var(--navy-blue);
            font-size: 1.8rem;
        }

        .btn-logout {
            padding: 0.6rem 1.2rem;
            background: var(--danger);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Content Sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .card {
            background: var(--white);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .card h2 {
            color: var(--navy-blue);
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--navy-blue), var(--medium-blue));
            padding: 1.5rem;
            border-radius: 15px;
            color: var(--white);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-card i {
            font-size: 3rem;
            opacity: 0.7;
        }

        .stat-info h3 {
            font-size: 2rem;
            margin-bottom: 0.3rem;
        }

        .stat-info p {
            opacity: 0.8;
            font-size: 0.9rem;
        }

        /* Form Elements */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--gold), var(--orange));
            color: var(--navy-blue);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 1.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: var(--navy-blue);
            color: var(--white);
            font-weight: 600;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-success {
            background: #e8f5e9;
            color: var(--success);
        }

        .badge-danger {
            background: #ffebee;
            color: var(--danger);
        }

        .badge-warning {
            background: #fff3e0;
            color: var(--warning);
        }

        /* Success/Error Messages */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .alert-success {
            background: #e8f5e9;
            color: var(--success);
            border-left: 4px solid var(--success);
        }

        .alert-error {
            background: #ffebee;
            color: var(--danger);
            border-left: 4px solid var(--danger);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--navy-blue);
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--gold);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-card">
            <div class="login-header">
                <i class="fas fa-shield-alt"></i>
                <h1>Admin Panel</h1>
                <p>Z2B Legacy Builders</p>
            </div>

            <div class="error-message" id="loginError"></div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn-login">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="admin-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Z2B Admin</h2>
                <p>Control Panel</p>
            </div>

            <ul class="sidebar-menu">
                <li><a href="#" class="menu-link active" data-section="overview"><i class="fas fa-tachometer-alt"></i> Overview</a></li>
                <li><a href="#" class="menu-link" data-section="tiers"><i class="fas fa-layer-group"></i> Tiers & Pricing</a></li>
                <li><a href="#" class="menu-link" data-section="users"><i class="fas fa-users"></i> User Management</a></li>
                <li><a href="#" class="menu-link" data-section="communications"><i class="fas fa-comments"></i> Communications</a></li>
                <li><a href="#" class="menu-link" data-section="content"><i class="fas fa-book"></i> Content Management</a></li>
                <li><a href="#" class="menu-link" data-section="compensation"><i class="fas fa-dollar-sign"></i> Compensation Plan</a></li>
                <li><a href="#" class="menu-link" data-section="branding"><i class="fas fa-palette"></i> Branding</a></li>
                <li><a href="#" class="menu-link" data-section="payment"><i class="fas fa-credit-card"></i> Payment Gateways</a></li>
                <li><a href="#" class="menu-link" data-section="fam"><i class="fas fa-user-clock"></i> FAM Management</a></li>
                <li><a href="#" class="menu-link" data-section="statistics"><i class="fas fa-chart-bar"></i> Statistics</a></li>
            </ul>
        </div>

        <!-- Sidebar Overlay for Mobile -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Main Content -->
        <div class="main-content">
            <div class="top-bar">
                <h1 id="sectionTitle">Dashboard Overview</h1>
                <button class="btn-logout" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>

            <!-- Overview Section -->
            <div id="overview" class="content-section active">
                <div class="stats-grid" id="statsGrid">
                    <!-- Stats will be loaded here -->
                </div>

                <div class="card">
                    <h2>Quick Actions</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <button class="btn btn-primary" onclick="showSection('users')">
                            <i class="fas fa-user-plus"></i> Create User
                        </button>
                        <button class="btn btn-success" onclick="showSection('tiers')">
                            <i class="fas fa-cog"></i> Update Pricing
                        </button>
                        <button class="btn btn-danger" onclick="resetStats()">
                            <i class="fas fa-sync"></i> Reset Statistics
                        </button>
                    </div>
                </div>
            </div>

            <!-- Other sections will be added via JavaScript -->
            <div id="tiers" class="content-section"></div>
            <div id="users" class="content-section"></div>

            <!-- Communications Section -->
            <div id="communications" class="content-section">
                <h2><i class="fas fa-comments"></i> Communications Center</h2>
                <p>Contact your builders via WhatsApp, SMS, or Email</p>

                <!-- Communication Tabs -->
                <div style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 2px solid #e0e0e0;">
                    <button class="comm-tab active" data-tab="whatsapp" style="padding: 1rem 2rem; border: none; background: none; cursor: pointer; border-bottom: 3px solid var(--gold); font-weight: bold; color: var(--navy-blue);">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </button>
                    <button class="comm-tab" data-tab="sms" style="padding: 1rem 2rem; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent; color: #666;">
                        <i class="fas fa-sms"></i> SMS
                    </button>
                    <button class="comm-tab" data-tab="email" style="padding: 1rem 2rem; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent; color: #666;">
                        <i class="fas fa-envelope"></i> Email
                    </button>
                </div>

                <!-- WhatsApp Tab Content -->
                <div id="whatsapp-content" class="comm-content active">
                    <div style="background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        <h3 style="color: #25D366; margin-bottom: 1.5rem;"><i class="fab fa-whatsapp"></i> Send WhatsApp Message</h3>

                        <!-- Recipient Selection -->
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--navy-blue);">Send To:</label>
                            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="whatsapp-recipient" value="all" checked>
                                    <span>All Builders</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="whatsapp-recipient" value="tier">
                                    <span>By Tier</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="whatsapp-recipient" value="individual">
                                    <span>Individual</span>
                                </label>
                            </div>

                            <!-- Tier Selection (hidden by default) -->
                            <div id="whatsapp-tier-select" style="display: none; margin-top: 1rem;">
                                <select id="whatsapp-tier" style="width: 100%; padding: 0.8rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                    <option value="">Select Tier...</option>
                                    <option value="FAM">FAM - Free Affiliate</option>
                                    <option value="BRONZE">Bronze Legacy Builder</option>
                                    <option value="COPPER">Copper Legacy Builder</option>
                                    <option value="SILVER">Silver Legacy Builder</option>
                                    <option value="GOLD">Gold Legacy Builder</option>
                                    <option value="PLATINUM">Platinum Legacy Builder</option>
                                    <option value="LIFETIME">Lifetime Legacy Builder</option>
                                </select>
                            </div>

                            <!-- Individual Selection (hidden by default) -->
                            <div id="whatsapp-individual-select" style="display: none; margin-top: 1rem;">
                                <input type="text" id="whatsapp-phone" placeholder="Enter phone number (e.g., 0774901639)" style="width: 100%; padding: 0.8rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                        </div>

                        <!-- Message -->
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--navy-blue);">Message:</label>
                            <textarea id="whatsapp-message" rows="6" placeholder="Type your message here..." style="width: 100%; padding: 1rem; border: 2px solid #e0e0e0; border-radius: 8px; font-family: inherit; resize: vertical;"></textarea>
                            <small style="color: #666;">Message will be sent via WhatsApp Web or WhatsApp Business API</small>
                        </div>

                        <!-- Send Button -->
                        <button onclick="sendWhatsAppMessage()" style="padding: 1rem 3rem; background: #25D366; color: white; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 1.1rem;">
                            <i class="fab fa-whatsapp"></i> Send WhatsApp Message
                        </button>
                    </div>
                </div>

                <!-- SMS Tab Content -->
                <div id="sms-content" class="comm-content" style="display: none;">
                    <div style="background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        <h3 style="color: #FF6B35; margin-bottom: 1.5rem;"><i class="fas fa-sms"></i> Send SMS</h3>

                        <!-- Recipient Selection -->
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--navy-blue);">Send To:</label>
                            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="sms-recipient" value="all" checked>
                                    <span>All Builders</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="sms-recipient" value="tier">
                                    <span>By Tier</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="sms-recipient" value="individual">
                                    <span>Individual</span>
                                </label>
                            </div>

                            <!-- Tier Selection -->
                            <div id="sms-tier-select" style="display: none; margin-top: 1rem;">
                                <select id="sms-tier" style="width: 100%; padding: 0.8rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                    <option value="">Select Tier...</option>
                                    <option value="FAM">FAM - Free Affiliate</option>
                                    <option value="BRONZE">Bronze Legacy Builder</option>
                                    <option value="COPPER">Copper Legacy Builder</option>
                                    <option value="SILVER">Silver Legacy Builder</option>
                                    <option value="GOLD">Gold Legacy Builder</option>
                                    <option value="PLATINUM">Platinum Legacy Builder</option>
                                    <option value="LIFETIME">Lifetime Legacy Builder</option>
                                </select>
                            </div>

                            <!-- Individual Selection -->
                            <div id="sms-individual-select" style="display: none; margin-top: 1rem;">
                                <input type="text" id="sms-phone" placeholder="Enter phone number (e.g., 0774901639)" style="width: 100%; padding: 0.8rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                        </div>

                        <!-- Message -->
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--navy-blue);">Message:</label>
                            <textarea id="sms-message" rows="4" placeholder="Type your SMS message here... (Max 160 characters recommended)" maxlength="160" style="width: 100%; padding: 1rem; border: 2px solid #e0e0e0; border-radius: 8px; font-family: inherit; resize: vertical;"></textarea>
                            <small style="color: #666;"><span id="sms-char-count">0</span>/160 characters</small>
                        </div>

                        <!-- Send Button -->
                        <button onclick="sendSMS()" style="padding: 1rem 3rem; background: linear-gradient(135deg, var(--gold), var(--orange)); color: var(--navy-blue); border: none; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 1.1rem;">
                            <i class="fas fa-sms"></i> Send SMS
                        </button>
                    </div>
                </div>

                <!-- Email Tab Content -->
                <div id="email-content" class="comm-content" style="display: none;">
                    <div style="background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        <h3 style="color: var(--navy-blue); margin-bottom: 1.5rem;"><i class="fas fa-envelope"></i> Send Email</h3>

                        <!-- Recipient Selection -->
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--navy-blue);">Send To:</label>
                            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="email-recipient" value="all" checked>
                                    <span>All Builders</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="email-recipient" value="tier">
                                    <span>By Tier</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="email-recipient" value="individual">
                                    <span>Individual</span>
                                </label>
                            </div>

                            <!-- Tier Selection -->
                            <div id="email-tier-select" style="display: none; margin-top: 1rem;">
                                <select id="email-tier" style="width: 100%; padding: 0.8rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                                    <option value="">Select Tier...</option>
                                    <option value="FAM">FAM - Free Affiliate</option>
                                    <option value="BRONZE">Bronze Legacy Builder</option>
                                    <option value="COPPER">Copper Legacy Builder</option>
                                    <option value="SILVER">Silver Legacy Builder</option>
                                    <option value="GOLD">Gold Legacy Builder</option>
                                    <option value="PLATINUM">Platinum Legacy Builder</option>
                                    <option value="LIFETIME">Lifetime Legacy Builder</option>
                                </select>
                            </div>

                            <!-- Individual Selection -->
                            <div id="email-individual-select" style="display: none; margin-top: 1rem;">
                                <input type="text" id="email-address" placeholder="Enter email address" style="width: 100%; padding: 0.8rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                        </div>

                        <!-- Subject -->
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--navy-blue);">Subject:</label>
                            <input type="text" id="email-subject" placeholder="Email subject" style="width: 100%; padding: 0.8rem; border: 2px solid #e0e0e0; border-radius: 8px;">
                        </div>

                        <!-- Message -->
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--navy-blue);">Message:</label>
                            <textarea id="email-message" rows="8" placeholder="Type your email message here..." style="width: 100%; padding: 1rem; border: 2px solid #e0e0e0; border-radius: 8px; font-family: inherit; resize: vertical;"></textarea>
                        </div>

                        <!-- Send Button -->
                        <button onclick="sendEmail()" style="padding: 1rem 3rem; background: var(--navy-blue); color: var(--gold); border: none; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 1.1rem;">
                            <i class="fas fa-envelope"></i> Send Email
                        </button>
                    </div>
                </div>
            </div>

            <div id="content" class="content-section"></div>
            <div id="compensation" class="content-section"></div>
            <div id="branding" class="content-section"></div>
            <div id="payment" class="content-section"></div>

            <!-- FAM Management Section -->
            <div id="fam" class="content-section">
                <h2>FAM Tier Management</h2>
                <p>Manage Free Access Members (FAM) - 30 Day Trial with 5 Credits/Week</p>

                <!-- FAM Statistics Cards -->
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card">
                        <i class="fas fa-users stat-icon" style="color: var(--success);"></i>
                        <div class="stat-info">
                            <h3 id="famTotalCount">0</h3>
                            <p>Total FAM Users</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-user-check stat-icon" style="color: var(--success);"></i>
                        <div class="stat-info">
                            <h3 id="famActiveCount">0</h3>
                            <p>Active FAM (Within 3 Months)</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-user-times stat-icon" style="color: var(--danger);"></i>
                        <div class="stat-info">
                            <h3 id="famExpiredCount">0</h3>
                            <p>Expired FAM (Need Upgrade)</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-exclamation-triangle stat-icon" style="color: var(--warning);"></i>
                        <div class="stat-info">
                            <h3 id="famExpiringSoonCount">0</h3>
                            <p>Expiring Within 7 Days</p>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
                    <button onclick="refreshFAMCredits()" class="primary-btn" style="background: var(--success);">
                        <i class="fas fa-sync"></i> Refresh FAM Credits (Monthly)
                    </button>
                    <button onclick="checkFAMExpiry()" class="primary-btn" style="background: var(--warning);">
                        <i class="fas fa-clock"></i> Check FAM Expiry (Daily)
                    </button>
                    <button onclick="loadFAMStats()" class="secondary-btn">
                        <i class="fas fa-chart-line"></i> Reload Statistics
                    </button>
                </div>

                <!-- FAM Members Expiring Soon -->
                <div id="famExpiringSoonSection" style="display: none; margin-top: 2rem;">
                    <h3>FAM Members Expiring Within 7 Days</h3>
                    <div id="famExpiringSoonList" style="background: white; padding: 1rem; border-radius: 10px; margin-top: 1rem;">
                        <!-- Expiring members list will be populated here -->
                    </div>
                </div>

                <!-- Last Action Result -->
                <div id="famActionResult" style="display: none; margin-top: 2rem; padding: 1rem; border-radius: 10px; background: white;">
                    <!-- Action results will be shown here -->
                </div>
            </div>

            <div id="statistics" class="content-section"></div>
        </div>
    </div>

    <script>
        // Mobile Sidebar Toggle Function
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const menuBtn = document.getElementById('mobileMenuBtn');

            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');

            // Change icon based on sidebar state
            if (sidebar.classList.contains('active')) {
                menuBtn.innerHTML = '<i class="fas fa-times"></i>';
            } else {
                menuBtn.innerHTML = '<i class="fas fa-bars"></i>';
            }
        }

        // API Configuration
        const API_URL = 'https://z2b-production-3cd3.up.railway.app/api'; // Production backend
        let authToken = localStorage.getItem('admin_token');

        // Login Form Handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (data.success) {
                    authToken = data.token;
                    localStorage.setItem('admin_token', authToken);
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('adminDashboard').style.display = 'flex';
                    loadDashboard();
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('Connection error. Please ensure the backend server is running.');
            }
        });

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function logout() {
            localStorage.removeItem('admin_token');
            location.reload();
        }

        // ========== COMMUNICATIONS FUNCTIONS ==========

        // Tab Switching
        document.addEventListener('DOMContentLoaded', function() {
            const commTabs = document.querySelectorAll('.comm-tab');
            commTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');

                    // Remove active class from all tabs
                    commTabs.forEach(t => {
                        t.classList.remove('active');
                        t.style.borderBottom = '3px solid transparent';
                        t.style.fontWeight = 'normal';
                        t.style.color = '#666';
                    });

                    // Add active class to clicked tab
                    this.classList.add('active');
                    this.style.borderBottom = '3px solid var(--gold)';
                    this.style.fontWeight = 'bold';
                    this.style.color = 'var(--navy-blue)';

                    // Hide all content
                    document.querySelectorAll('.comm-content').forEach(content => {
                        content.style.display = 'none';
                    });

                    // Show selected content
                    document.getElementById(tabName + '-content').style.display = 'block';
                });
            });

            // WhatsApp recipient change listeners
            const whatsappRecipients = document.querySelectorAll('input[name="whatsapp-recipient"]');
            whatsappRecipients.forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('whatsapp-tier-select').style.display = this.value === 'tier' ? 'block' : 'none';
                    document.getElementById('whatsapp-individual-select').style.display = this.value === 'individual' ? 'block' : 'none';
                });
            });

            // SMS recipient change listeners
            const smsRecipients = document.querySelectorAll('input[name="sms-recipient"]');
            smsRecipients.forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('sms-tier-select').style.display = this.value === 'tier' ? 'block' : 'none';
                    document.getElementById('sms-individual-select').style.display = this.value === 'individual' ? 'block' : 'none';
                });
            });

            // Email recipient change listeners
            const emailRecipients = document.querySelectorAll('input[name="email-recipient"]');
            emailRecipients.forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('email-tier-select').style.display = this.value === 'tier' ? 'block' : 'none';
                    document.getElementById('email-individual-select').style.display = this.value === 'individual' ? 'block' : 'none';
                });
            });

            // SMS character counter
            const smsTextarea = document.getElementById('sms-message');
            if (smsTextarea) {
                smsTextarea.addEventListener('input', function() {
                    document.getElementById('sms-char-count').textContent = this.value.length;
                });
            }
        });

        // Send WhatsApp Message
        async function sendWhatsAppMessage() {
            const recipientType = document.querySelector('input[name="whatsapp-recipient"]:checked').value;
            const message = document.getElementById('whatsapp-message').value.trim();

            if (!message) {
                alert('Please enter a message');
                return;
            }

            let recipients = [];
            let phoneNumbers = [];

            try {
                if (recipientType === 'all') {
                    // Get all users
                    const response = await fetch(`${API_URL}/users?limit=10000`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const data = await response.json();
                    if (data.success && data.data) {
                        phoneNumbers = data.data.map(user => user.phone).filter(p => p);
                        recipients = data.data.map(user => `${user.firstName} ${user.lastName}`);
                    }
                } else if (recipientType === 'tier') {
                    const tier = document.getElementById('whatsapp-tier').value;
                    if (!tier) {
                        alert('Please select a tier');
                        return;
                    }
                    // Get users by tier
                    const response = await fetch(`${API_URL}/users?tier=${tier}&limit=10000`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const data = await response.json();
                    if (data.success && data.data) {
                        phoneNumbers = data.data.map(user => user.phone).filter(p => p);
                        recipients = data.data.map(user => `${user.firstName} ${user.lastName}`);
                    }
                } else if (recipientType === 'individual') {
                    const phone = document.getElementById('whatsapp-phone').value.trim();
                    if (!phone) {
                        alert('Please enter a phone number');
                        return;
                    }
                    phoneNumbers = [phone];
                }

                if (phoneNumbers.length === 0) {
                    alert('No phone numbers found for selected recipients');
                    return;
                }

                // Open WhatsApp Web for each number
                const encodedMessage = encodeURIComponent(message);

                if (confirm(`Send WhatsApp message to ${phoneNumbers.length} recipient(s)?`)) {
                    phoneNumbers.forEach((phone, index) => {
                        setTimeout(() => {
                            // Format phone number (remove leading 0, add country code)
                            let formattedPhone = phone.replace(/^0/, '27'); // Assuming South Africa
                            window.open(`https://wa.me/${formattedPhone}?text=${encodedMessage}`, '_blank');
                        }, index * 2000); // 2 second delay between each
                    });

                    alert(`Opening WhatsApp for ${phoneNumbers.length} recipient(s). Each will open in a new tab with 2-second delays.`);
                }
            } catch (error) {
                console.error('WhatsApp send error:', error);
                alert('Error sending WhatsApp message: ' + error.message);
            }
        }

        // Send SMS
        async function sendSMS() {
            const recipientType = document.querySelector('input[name="sms-recipient"]:checked').value;
            const message = document.getElementById('sms-message').value.trim();

            if (!message) {
                alert('Please enter a message');
                return;
            }

            if (message.length > 160) {
                if (!confirm('Message is longer than 160 characters and may be sent as multiple SMS. Continue?')) {
                    return;
                }
            }

            let phoneNumbers = [];

            try {
                if (recipientType === 'all') {
                    const response = await fetch(`${API_URL}/users?limit=10000`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const data = await response.json();
                    if (data.success && data.data) {
                        phoneNumbers = data.data.map(user => user.phone).filter(p => p);
                    }
                } else if (recipientType === 'tier') {
                    const tier = document.getElementById('sms-tier').value;
                    if (!tier) {
                        alert('Please select a tier');
                        return;
                    }
                    const response = await fetch(`${API_URL}/users?tier=${tier}&limit=10000`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const data = await response.json();
                    if (data.success && data.data) {
                        phoneNumbers = data.data.map(user => user.phone).filter(p => p);
                    }
                } else if (recipientType === 'individual') {
                    const phone = document.getElementById('sms-phone').value.trim();
                    if (!phone) {
                        alert('Please enter a phone number');
                        return;
                    }
                    phoneNumbers = [phone];
                }

                if (phoneNumbers.length === 0) {
                    alert('No phone numbers found for selected recipients');
                    return;
                }

                // Send SMS via backend
                const response = await fetch(`${API_URL}/communications/sms`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        recipients: phoneNumbers,
                        message: message
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert(`SMS sent successfully to ${phoneNumbers.length} recipient(s)!`);
                    document.getElementById('sms-message').value = '';
                } else {
                    alert('SMS sending failed: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('SMS send error:', error);
                alert('Error sending SMS. Please check your SMS gateway configuration.');
            }
        }

        // Send Email
        async function sendEmail() {
            const recipientType = document.querySelector('input[name="email-recipient"]:checked').value;
            const subject = document.getElementById('email-subject').value.trim();
            const message = document.getElementById('email-message').value.trim();

            if (!subject) {
                alert('Please enter an email subject');
                return;
            }

            if (!message) {
                alert('Please enter a message');
                return;
            }

            let emails = [];

            try {
                if (recipientType === 'all') {
                    const response = await fetch(`${API_URL}/users?limit=10000`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const data = await response.json();
                    if (data.success && data.data) {
                        emails = data.data.map(user => user.email).filter(e => e);
                    }
                } else if (recipientType === 'tier') {
                    const tier = document.getElementById('email-tier').value;
                    if (!tier) {
                        alert('Please select a tier');
                        return;
                    }
                    const response = await fetch(`${API_URL}/users?tier=${tier}&limit=10000`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const data = await response.json();
                    if (data.success && data.data) {
                        emails = data.data.map(user => user.email).filter(e => e);
                    }
                } else if (recipientType === 'individual') {
                    const email = document.getElementById('email-address').value.trim();
                    if (!email) {
                        alert('Please enter an email address');
                        return;
                    }
                    emails = [email];
                }

                if (emails.length === 0) {
                    alert('No email addresses found for selected recipients');
                    return;
                }

                // Send email via backend
                const response = await fetch(`${API_URL}/communications/email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        recipients: emails,
                        subject: subject,
                        message: message
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert(`Email sent successfully to ${emails.length} recipient(s)!`);
                    document.getElementById('email-subject').value = '';
                    document.getElementById('email-message').value = '';
                } else {
                    alert('Email sending failed: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Email send error:', error);
                alert('Error sending email. Please check your email service configuration.');
            }
        }

        // ========== END COMMUNICATIONS FUNCTIONS ==========

        // ========== USER MANAGEMENT COMMUNICATIONS ==========

        // Update selected count
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.user-checkbox:checked');
            const count = checkboxes.length;
            const countElement = document.getElementById('selectedCount');
            if (countElement) {
                countElement.textContent = count;
            }
        }

        // Select all users
        function selectAllUsers() {
            const checkboxes = document.querySelectorAll('.user-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) selectAllCheckbox.checked = true;
            updateSelectedCount();
        }

        // Deselect all users
        function deselectAllUsers() {
            const checkboxes = document.querySelectorAll('.user-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
            updateSelectedCount();
        }

        // Toggle all users
        function toggleAllUsers(checked) {
            const checkboxes = document.querySelectorAll('.user-checkbox');
            checkboxes.forEach(cb => cb.checked = checked);
            updateSelectedCount();
        }

        // Get selected users
        function getSelectedUsers() {
            const checkboxes = document.querySelectorAll('.user-checkbox:checked');
            const users = [];
            checkboxes.forEach(cb => {
                try {
                    const userData = cb.getAttribute('data-user');
                    const user = JSON.parse(userData.replace(/&#39;/g, "'"));
                    users.push(user);
                } catch (e) {
                    console.error('Error parsing user data:', e);
                }
            });
            return users;
        }

        // Send to selected users
        function sendToSelected(channel) {
            const users = getSelectedUsers();

            if (users.length === 0) {
                alert('Please select at least one builder');
                return;
            }

            // Switch to communications section
            const commLink = document.querySelector('[data-section="communications"]');
            if (commLink) {
                commLink.click();
            }

            // Wait for section to load, then pre-fill data
            setTimeout(() => {
                if (channel === 'whatsapp') {
                    // Open WhatsApp for each selected user
                    const phoneNumbers = users.map(u => u.phone).filter(p => p);
                    if (phoneNumbers.length === 0) {
                        alert('No phone numbers found for selected builders');
                        return;
                    }

                    // Show template selector
                    showMessageTemplateModal(users, channel);
                } else if (channel === 'sms') {
                    // Show SMS tab and pre-fill
                    const smsTab = document.querySelector('[data-tab="sms"]');
                    if (smsTab) smsTab.click();

                    showMessageTemplateModal(users, channel);
                } else if (channel === 'email') {
                    // Show email tab and pre-fill
                    const emailTab = document.querySelector('[data-tab="email"]');
                    if (emailTab) emailTab.click();

                    showMessageTemplateModal(users, channel);
                }
            }, 300);
        }

        // Send to individual user
        function sendToUser(user, channel) {
            // Validate user has contact info
            if (channel === 'whatsapp' && !user.phone) {
                alert('No phone number found for this user');
                return;
            }
            if (channel === 'sms' && !user.phone) {
                alert('No phone number found for this user');
                return;
            }
            if (channel === 'email' && !user.email) {
                alert('No email address found for this user');
                return;
            }

            // Store user for template modal
            window.currentCommunicationUser = user;
            window.currentCommunicationChannel = channel;

            // Show template modal for selection
            showMessageTemplateModal([user], channel);
        }

        // View user details modal
        function viewUserDetails(user) {
            const referralLink = `${window.location.origin}/register.html?ref=${user.referralCode}`;

            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 2rem;';

            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 15px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0; color: var(--navy-blue);">
                            <i class="fas fa-user-circle"></i> Builder Details
                        </h2>
                        <button onclick="this.closest('div').closest('div').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div style="background: linear-gradient(135deg, var(--navy-blue), var(--medium-blue)); color: white; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0 0 0.5rem 0;">${user.firstName} ${user.lastName}</h3>
                        <p style="margin: 0; opacity: 0.9;">${user.tier || 'FAM'} Legacy Builder</p>
                    </div>

                    <div style="display: grid; gap: 1rem;">
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                            <label style="font-weight: bold; color: var(--navy-blue); font-size: 0.85rem;">Z2B MEMBER ID</label>
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                                <span style="background: #e8f5e9; color: #28a745; padding: 0.5rem 1rem; border-radius: 5px; font-weight: bold; font-family: monospace; flex: 1;">${user.referralCode || 'N/A'}</span>
                                <button onclick="navigator.clipboard.writeText('${user.referralCode}')" style="padding: 0.5rem 1rem; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>

                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                            <label style="font-weight: bold; color: var(--navy-blue); font-size: 0.85rem;">EMAIL</label>
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                                <span style="flex: 1; font-family: monospace;">${user.email || 'N/A'}</span>
                                <button onclick="navigator.clipboard.writeText('${user.email || ''}')" style="padding: 0.5rem 1rem; background: var(--navy-blue); color: var(--gold); border: none; border-radius: 5px; cursor: pointer;">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>

                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                            <label style="font-weight: bold; color: var(--navy-blue); font-size: 0.85rem;">PHONE / WHATSAPP</label>
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                                <span style="flex: 1; font-family: monospace;">${user.phone || 'N/A'}</span>
                                <button onclick="navigator.clipboard.writeText('${user.phone || ''}')" style="padding: 0.5rem 1rem; background: #25D366; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>

                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                            <label style="font-weight: bold; color: var(--navy-blue); font-size: 0.85rem;">REFERRAL LINK</label>
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                                <input type="text" value="${referralLink}" readonly style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px; font-size: 0.85rem; font-family: monospace;">
                                <button onclick="navigator.clipboard.writeText('${referralLink}'); alert('Link copied!')" style="padding: 0.5rem 1rem; background: var(--gold); color: var(--navy-blue); border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button onclick='sendToUser(${JSON.stringify(user).replace(/'/g, "&#39;")}, "whatsapp"); this.closest("div").closest("div").remove();' style="flex: 1; padding: 0.8rem; background: #25D366; color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold;">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                        </button>
                        <button onclick='sendToUser(${JSON.stringify(user).replace(/'/g, "&#39;")}, "sms"); this.closest("div").closest("div").remove();' style="flex: 1; padding: 0.8rem; background: var(--orange); color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold;">
                            <i class="fas fa-sms"></i> SMS
                        </button>
                        <button onclick='sendToUser(${JSON.stringify(user).replace(/'/g, "&#39;")}, "email"); this.closest("div").closest("div").remove();' style="flex: 1; padding: 0.8rem; background: var(--navy-blue); color: var(--gold); border: none; border-radius: 50px; cursor: pointer; font-weight: bold;">
                            <i class="fas fa-envelope"></i> Email
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Message template modal
        function showMessageTemplateModal(users, channel) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 2rem;';

            // Get first user for template preview
            const firstUser = users[0];
            const tier = firstUser?.tier || 'FAM';
            const nextTier = tier === 'FAM' ? 'Bronze' : tier === 'Bronze' ? 'Copper' : tier === 'Copper' ? 'Silver' : tier === 'Silver' ? 'Gold' : tier === 'Gold' ? 'Platinum' : 'Lifetime';

            const templates = {
                welcome: `Hi {name},\n\nWelcome to Z2B Legacy Builders! \n\nYour Details:\n Name: {name}\n Z2B Member ID: {z2bId}\n Tier: {tier}\n Your Referral Link: {referralLink}\n\nYour journey to financial freedom starts now! Check your dashboard for resources and start building your legacy today! \n\nLet's build wealth together!\nCoach ManLaw`,
                upgrade: `Hi {name},\n\nReady to unlock the full Z2B experience? \n\nYour Current Details:\n Name: {name}\n Z2B Member ID: {z2bId}\n Current Tier: {tier}\n Your Referral Link: {referralLink}\n\nUpgrade from ${tier} to ${nextTier} today and get:\n Instant access to all apps\n Bonus AI credits\n Higher commission rates\n More earning potential\n\nLimited time: 50% off beta pricing!\n\nReady to level up?\nCoach ManLaw`,
                followup: `Hi {name},\n\nI noticed you haven't logged in recently. \n\nYour Account:\n Name: {name}\n Z2B Member ID: {z2bId}\n Tier: {tier}\n Your Referral Link: {referralLink}\n\nNeed any help getting started? I'm here to support your success!\n\nRemember, your referral link is ready to share - start building your team today!\n\nLet's build your legacy together. \nCoach ManLaw`,
                announcement: `Hi {name},\n\nExciting news! \n\nYour Details:\n Name: {name}\n Z2B Member ID: {z2bId}\n Tier: {tier}\n Your Referral Link: {referralLink}\n\nWe've just launched new features on Z2B! Login to your dashboard to explore them.\n\nYour success is our priority! \n\nCoach ManLaw`,
                custom: `Hi {name},\n\nYour Details:\n Name: {name}\n Z2B Member ID: {z2bId}\n Tier: {tier}\n Your Referral Link: {referralLink}\n\n`
            };

            // Load custom saved templates from localStorage
            const savedTemplates = JSON.parse(localStorage.getItem('z2b_custom_templates') || '{}');

            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 15px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <h2 style="margin: 0 0 1rem 0; color: var(--navy-blue);">
                        <i class="fas fa-envelope-open-text"></i> Choose Message Template
                    </h2>
                    <p style="color: #666; margin-bottom: 1.5rem;">Sending to ${users.length} builder(s) via ${channel}</p>

                    <div style="display: grid; gap: 1rem; margin-bottom: 1.5rem;">
                        ${Object.keys(templates).map(key => `
                            <button onclick="selectTemplate('${key}', '${channel}', this)" style="text-align: left; padding: 1rem; background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; transition: all 0.3s;">
                                <strong style="color: var(--navy-blue); display: block; margin-bottom: 0.5rem; text-transform: capitalize;">${key} Message</strong>
                                <small style="color: #666; white-space: pre-wrap;">${templates[key].substring(0, 100)}...</small>
                            </button>
                        `).join('')}

                        ${Object.keys(savedTemplates).map(key => `
                            <button onclick="selectTemplate('saved_${key}', '${channel}', this)" style="text-align: left; padding: 1rem; background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; cursor: pointer; transition: all 0.3s; position: relative;">
                                <button onclick="event.stopPropagation(); deleteCustomTemplate('${key}')" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #dc3545; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <strong style="color: #856404; display: block; margin-bottom: 0.5rem;"> ${key}</strong>
                                <small style="color: #856404; white-space: pre-wrap;">${savedTemplates[key].substring(0, 100)}...</small>
                            </button>
                        `).join('')}

                        <button onclick="draftNewMessage('${channel}')" style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, var(--navy-blue), var(--medium-blue)); color: var(--gold); border: 2px solid var(--gold); border-radius: 10px; cursor: pointer; transition: all 0.3s; font-weight: bold;">
                            <i class="fas fa-plus-circle"></i> Draft New Message
                        </button>
                    </div>

                    <button onclick="this.closest('div').closest('div').remove()" style="width: 100%; padding: 1rem; background: #6c757d; color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold;">
                        Cancel
                    </button>
                </div>
            `;

            document.body.appendChild(modal);

            // Store users, channel, and templates for access in selectTemplate
            window.currentTemplateUsers = users;
            window.currentCommunicationChannel = channel;
            window.currentTemplates = {...templates, ...Object.fromEntries(Object.entries(savedTemplates).map(([k, v]) => [`saved_${k}`, v]))};

            window.selectTemplate = function(templateKey, channel, button) {
                const users = window.currentTemplateUsers || [];
                const template = window.currentTemplates[templateKey];

                // Function to replace all template variables with user data
                function fillTemplate(template, user) {
                    const referralLink = `${window.location.origin}/register.html?ref=${user.referralCode || 'N/A'}`;
                    return template
                        .replace(/{name}/g, user.firstName || 'Builder')
                        .replace(/{z2bId}/g, user.referralCode || 'N/A')
                        .replace(/{tier}/g, user.tier || 'FAM')
                        .replace(/{referralLink}/g, referralLink);
                }

                // Close template modal
                modal.remove();

                if (channel === 'whatsapp') {
                    // Show editable message modal before opening WhatsApp
                    showEditMessageModal(users, channel, template, fillTemplate);
                } else if (channel === 'sms') {
                    const smsTab = document.querySelector('[data-tab="sms"]');
                    if (smsTab) smsTab.click();
                    setTimeout(() => {
                        // Set to individual or all based on count
                        if (users.length === 1) {
                            document.querySelector('input[name="sms-recipient"][value="individual"]').checked = true;
                            document.querySelector('input[name="sms-recipient"][value="individual"]').dispatchEvent(new Event('change'));
                            document.getElementById('sms-phone').value = users[0].phone;
                            document.getElementById('sms-message').value = fillTemplate(template, users[0]);
                        } else {
                            // For multiple, use first name as placeholder
                            document.getElementById('sms-message').value = template;
                            alert('Template loaded! The system will automatically personalize each message with member details when sending.');
                        }
                    }, 100);
                } else if (channel === 'email') {
                    const emailTab = document.querySelector('[data-tab="email"]');
                    if (emailTab) emailTab.click();
                    setTimeout(() => {
                        if (users.length === 1) {
                            document.querySelector('input[name="email-recipient"][value="individual"]').checked = true;
                            document.querySelector('input[name="email-recipient"][value="individual"]').dispatchEvent(new Event('change'));
                            document.getElementById('email-address').value = users[0].email;
                            document.getElementById('email-subject').value = templateKey.charAt(0).toUpperCase() + templateKey.slice(1);
                            document.getElementById('email-message').value = fillTemplate(template, users[0]);
                        } else {
                            document.getElementById('email-subject').value = templateKey.charAt(0).toUpperCase() + templateKey.slice(1);
                            document.getElementById('email-message').value = template;
                            alert('Template loaded! The system will automatically personalize each email with member details when sending.');
                        }
                    }, 100);
                }
            };
        }

        // Edit message modal for WhatsApp (allows editing before sending)
        function showEditMessageModal(users, channel, template, fillTemplate) {
            const editModal = document.createElement('div');
            editModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 2rem;';

            // If single user, fill template immediately. If multiple, show first user's data as example
            const previewUser = users[0];
            const prefilledMessage = fillTemplate(template, previewUser);

            editModal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 15px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0; color: var(--navy-blue);">
                            <i class="fab fa-whatsapp" style="color: #25D366;"></i> Edit WhatsApp Message
                        </h2>
                        <button onclick="this.closest('div').closest('div').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div style="background: #e8f5e9; border-left: 4px solid #25D366; padding: 1rem; border-radius: 5px; margin-bottom: 1.5rem;">
                        <p style="margin: 0; color: #2e7d32; font-size: 0.9rem;">
                            <i class="fas fa-info-circle"></i>
                            ${users.length === 1
                                ? `Sending to: <strong>${users[0].firstName} ${users[0].lastName}</strong> (${users[0].phone})`
                                : `Sending to <strong>${users.length} builders</strong>. Each message will be personalized with their details.`
                            }
                        </p>
                    </div>

                    ${users.length === 1 ? `
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <strong style="color: var(--navy-blue); display: block; margin-bottom: 0.5rem;">Member Details:</strong>
                            <div style="font-size: 0.9rem; color: #666; display: grid; gap: 0.3rem;">
                                <div> Name: <strong>${users[0].firstName} ${users[0].lastName}</strong></div>
                                <div> Z2B ID: <strong>${users[0].referralCode || 'N/A'}</strong></div>
                                <div> Tier: <strong>${users[0].tier || 'FAM'}</strong></div>
                                <div> Phone: <strong>${users[0].phone || 'N/A'}</strong></div>
                            </div>
                        </div>
                    ` : ''}

                    <label style="font-weight: bold; color: var(--navy-blue); display: block; margin-bottom: 0.5rem;">
                        Message Preview & Edit:
                    </label>
                    <textarea id="whatsappMessageEditor" style="width: 100%; min-height: 300px; padding: 1rem; border: 2px solid #e0e0e0; border-radius: 10px; font-family: inherit; font-size: 0.95rem; resize: vertical; margin-bottom: 1rem;">${prefilledMessage}</textarea>

                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 1.5rem;">
                        <i class="fas fa-lightbulb"></i> You can edit the message above before sending. ${users.length > 1 ? 'Each builder will receive a personalized version.' : ''}
                    </div>

                    <div style="display: flex; gap: 1rem;">
                        <button onclick="this.closest('div').closest('div').remove()" style="flex: 1; padding: 1rem; background: #6c757d; color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button id="sendWhatsAppBtn" style="flex: 2; padding: 1rem; background: #25D366; color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; font-size: 1rem;">
                            <i class="fab fa-whatsapp"></i> Send via WhatsApp
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(editModal);

            // Handle send button click
            document.getElementById('sendWhatsAppBtn').addEventListener('click', function() {
                const editedMessage = document.getElementById('whatsappMessageEditor').value;

                if (!editedMessage.trim()) {
                    alert('Message cannot be empty!');
                    return;
                }

                // Close modal
                editModal.remove();

                // Send to each user
                users.forEach((user, index) => {
                    if (!user.phone) {
                        console.log('No phone for user:', user);
                        return;
                    }

                    // For multiple users, personalize the edited message
                    let personalizedMessage = editedMessage;
                    if (users.length > 1) {
                        personalizedMessage = fillTemplate(editedMessage, user);
                    }

                    const formattedPhone = user.phone.replace(/^0/, '27');
                    setTimeout(() => {
                        window.open(`https://wa.me/${formattedPhone}?text=${encodeURIComponent(personalizedMessage)}`, '_blank');
                    }, index * 2000);
                });

                alert(`Opening WhatsApp for ${users.length} builder(s). Each will open in a new tab with 2-second delays. Please click Send in each WhatsApp window.`);
            });

            // Close on outside click
            editModal.addEventListener('click', (e) => {
                if (e.target === editModal) {
                    editModal.remove();
                }
            });
        }

        // Draft new custom message
        function draftNewMessage(channel) {
            // Close the template selection modal
            document.querySelectorAll('body > div').forEach(div => {
                if (div.style.cssText.includes('rgba(0,0,0,0.7)')) {
                    div.remove();
                }
            });

            const users = window.currentTemplateUsers || [];
            const draftModal = document.createElement('div');
            draftModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 2rem;';

            draftModal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 15px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="margin: 0; color: var(--navy-blue);">
                            <i class="fas fa-edit"></i> Draft New Message
                        </h2>
                        <button onclick="this.closest('div').closest('div').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div style="background: #e3f2fd; border-left: 4px solid #2196F3; padding: 1rem; border-radius: 5px; margin-bottom: 1.5rem;">
                        <p style="margin: 0; color: #1565c0; font-size: 0.9rem;">
                            <i class="fas fa-info-circle"></i>
                            Sending to <strong>${users.length} builder(s)</strong> via ${channel}. Use placeholders: <code>{name}</code>, <code>{z2bId}</code>, <code>{tier}</code>, <code>{referralLink}</code>
                        </p>
                    </div>

                    ${users.length === 1 ? `
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <strong style="color: var(--navy-blue); display: block; margin-bottom: 0.5rem;">Member Details (for reference):</strong>
                            <div style="font-size: 0.9rem; color: #666; display: grid; gap: 0.3rem;">
                                <div> Name: <strong>${users[0].firstName} ${users[0].lastName}</strong></div>
                                <div> Z2B ID: <strong>${users[0].referralCode || 'N/A'}</strong></div>
                                <div> Tier: <strong>${users[0].tier || 'FAM'}</strong></div>
                                <div> Link: <strong>${window.location.origin}/register.html?ref=${users[0].referralCode || 'N/A'}</strong></div>
                            </div>
                        </div>
                    ` : ''}

                    <label style="font-weight: bold; color: var(--navy-blue); display: block; margin-bottom: 0.5rem;">
                        Your Message:
                    </label>
                    <textarea id="customMessageDraft" placeholder="Hi {name},

Your Details:
 Name: {name}
 Z2B Member ID: {z2bId}
 Tier: {tier}
 Your Referral Link: {referralLink}

Write your message here..." style="width: 100%; min-height: 300px; padding: 1rem; border: 2px solid #e0e0e0; border-radius: 10px; font-family: inherit; font-size: 0.95rem; resize: vertical; margin-bottom: 1rem;"></textarea>

                    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 1rem; border-radius: 5px; margin-bottom: 1.5rem;">
                        <label style="font-weight: bold; color: #856404; display: block; margin-bottom: 0.5rem;">
                             Save this message as template? (Optional)
                        </label>
                        <input type="text" id="templateName" placeholder="e.g., Payment Reminder, Team Celebration, etc." style="width: 100%; padding: 0.75rem; border: 2px solid #ffc107; border-radius: 8px; font-size: 0.95rem;">
                        <small style="color: #856404; display: block; margin-top: 0.5rem;">Leave empty to use once without saving</small>
                    </div>

                    <div style="display: flex; gap: 1rem;">
                        <button onclick="this.closest('div').closest('div').remove()" style="flex: 1; padding: 1rem; background: #6c757d; color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button id="useCustomMessage" style="flex: 2; padding: 1rem; background: #28a745; color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; font-size: 1rem;">
                            <i class="fas fa-paper-plane"></i> Use This Message
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(draftModal);

            // Handle use message button
            document.getElementById('useCustomMessage').addEventListener('click', function() {
                const customMessage = document.getElementById('customMessageDraft').value.trim();
                const templateName = document.getElementById('templateName').value.trim();

                if (!customMessage) {
                    alert('Please write a message before continuing!');
                    return;
                }

                // Save as template if name provided
                if (templateName) {
                    const savedTemplates = JSON.parse(localStorage.getItem('z2b_custom_templates') || '{}');
                    savedTemplates[templateName] = customMessage;
                    localStorage.setItem('z2b_custom_templates', JSON.stringify(savedTemplates));
                    alert(` Template "${templateName}" saved successfully! You can use it anytime.`);
                }

                // Close draft modal
                draftModal.remove();

                // Function to replace template variables
                function fillTemplate(template, user) {
                    const referralLink = `${window.location.origin}/register.html?ref=${user.referralCode || 'N/A'}`;
                    return template
                        .replace(/{name}/g, user.firstName || 'Builder')
                        .replace(/{z2bId}/g, user.referralCode || 'N/A')
                        .replace(/{tier}/g, user.tier || 'FAM')
                        .replace(/{referralLink}/g, referralLink);
                }

                // Show edit message modal or send directly based on channel
                if (channel === 'whatsapp') {
                    showEditMessageModal(users, channel, customMessage, fillTemplate);
                } else if (channel === 'sms') {
                    const smsTab = document.querySelector('[data-tab="sms"]');
                    if (smsTab) smsTab.click();
                    setTimeout(() => {
                        if (users.length === 1) {
                            document.querySelector('input[name="sms-recipient"][value="individual"]').checked = true;
                            document.querySelector('input[name="sms-recipient"][value="individual"]').dispatchEvent(new Event('change'));
                            document.getElementById('sms-phone').value = users[0].phone;
                            document.getElementById('sms-message').value = fillTemplate(customMessage, users[0]);
                        } else {
                            document.getElementById('sms-message').value = customMessage;
                            alert('Template loaded! The system will automatically personalize each message with member details when sending.');
                        }
                    }, 100);
                } else if (channel === 'email') {
                    const emailTab = document.querySelector('[data-tab="email"]');
                    if (emailTab) emailTab.click();
                    setTimeout(() => {
                        if (users.length === 1) {
                            document.querySelector('input[name="email-recipient"][value="individual"]').checked = true;
                            document.querySelector('input[name="email-recipient"][value="individual"]').dispatchEvent(new Event('change'));
                            document.getElementById('email-address').value = users[0].email;
                            document.getElementById('email-subject').value = 'Message from Z2B';
                            document.getElementById('email-message').value = fillTemplate(customMessage, users[0]);
                        } else {
                            document.getElementById('email-subject').value = 'Message from Z2B';
                            document.getElementById('email-message').value = customMessage;
                            alert('Template loaded! The system will automatically personalize each email with member details when sending.');
                        }
                    }, 100);
                }
            });

            // Close on outside click
            draftModal.addEventListener('click', (e) => {
                if (e.target === draftModal) {
                    draftModal.remove();
                }
            });
        }

        // Delete custom template
        function deleteCustomTemplate(templateName) {
            if (confirm(`Are you sure you want to delete the template "${templateName}"?`)) {
                const savedTemplates = JSON.parse(localStorage.getItem('z2b_custom_templates') || '{}');
                delete savedTemplates[templateName];
                localStorage.setItem('z2b_custom_templates', JSON.stringify(savedTemplates));
                alert(`Template "${templateName}" deleted successfully!`);

                // Refresh the template modal
                document.querySelectorAll('body > div').forEach(div => {
                    if (div.style.cssText.includes('rgba(0,0,0,0.7)')) {
                        div.remove();
                    }
                });

                // Reopen with updated templates
                const users = window.currentTemplateUsers;
                const channel = window.currentCommunicationChannel;
                if (users && channel) {
                    showMessageTemplateModal(users, channel);
                }
            }
        }

        // ========== END USER MANAGEMENT COMMUNICATIONS ==========

        // Check if already logged in
        if (authToken) {
            verifyToken();
        }

        async function verifyToken() {
            try {
                const response = await fetch(`${API_URL}/auth/verify`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('adminDashboard').style.display = 'flex';
                    loadDashboard();
                } else {
                    localStorage.removeItem('admin_token');
                }
            } catch (error) {
                console.error('Token verification failed:', error);
            }
        }

        // Menu Navigation
        document.querySelectorAll('.menu-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = link.dataset.section;
                showSection(section);

                // Update active state
                document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
            });
        });

        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(section).classList.add('active');

            // Update title
            const titles = {
                'overview': 'Dashboard Overview',
                'tiers': 'Tiers & Pricing Management',
                'users': 'User Management',
                'content': 'Content Management',
                'compensation': 'Compensation Plan',
                'branding': 'Branding Settings',
                'payment': 'Payment Gateway Configuration',
                'fam': 'FAM Tier Management',
                'statistics': 'Platform Statistics'
            };
            document.getElementById('sectionTitle').textContent = titles[section];

            // Load section data
            loadSectionData(section);
        }

        async function loadDashboard() {
            await loadStatistics();
            await loadAllSettings();
        }

        async function loadStatistics() {
            try {
                const response = await fetch(`${API_URL}/stats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const result = await response.json();
                if (result.success) {
                    displayStats(result.data);
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        function displayStats(stats) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-info">
                        <h3>${stats.totalUsers || 0}</h3>
                        <p>Total Users</p>
                    </div>
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-info">
                        <h3>${stats.totalBetaTesters || 0}</h3>
                        <p>Beta Testers</p>
                    </div>
                    <i class="fas fa-star"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-info">
                        <h3>${stats.activeUsers || 0}</h3>
                        <p>Active Users</p>
                    </div>
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-info">
                        <h3>R${(stats.totalRevenue || 0).toLocaleString()}</h3>
                        <p>Total Revenue</p>
                    </div>
                    <i class="fas fa-money-bill-wave"></i>
                </div>
            `;
        }

        // Load section-specific data
        async function loadSectionData(section) {
            try {
                const response = await fetch(`${API_URL}/settings`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const result = await response.json();

                if (!result.success) {
                    console.error('Error loading settings');
                    return;
                }

                const settings = result.data;

                switch(section) {
                    case 'tiers':
                        displayTiersSection(settings.tiers);
                        break;
                    case 'compensation':
                        displayCompensationSection(settings.compensation);
                        break;
                    case 'branding':
                        displayBrandingSection(settings.branding);
                        break;
                    case 'users':
                        displayUsersSection();
                        break;
                    case 'content':
                        displayContentSection();
                        break;
                    case 'payment':
                        displayPaymentSection();
                        break;
                    case 'fam':
                        loadFAMStats();
                        break;
                    case 'stats':
                        displayStatsSection();
                        break;
                }
            } catch (error) {
                console.error('Error loading section:', error);
            }
        }

        async function loadAllSettings() {
            // Load initial overview
            await loadStatistics();
        }

        function displayTiersSection(tiers) {
            const contentDiv = document.getElementById('tiers');
            contentDiv.innerHTML = `
                <h2>Tiers & Pricing Management</h2>
                <p style="margin-bottom: 2rem; color: #666;">Edit pricing, PV points, and commission rates for each membership tier.</p>
                <div style="display: grid; gap: 1.5rem;">
                    ${Object.entries(tiers).map(([key, tier]) => `
                        <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h3 style="color: var(--navy-blue); margin-bottom: 1.5rem;">${tier.name}</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Price (R)</label>
                                    <input type="number" id="tier_${key}_price" value="${tier.price}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Beta Price (R)</label>
                                    <input type="number" id="tier_${key}_betaPrice" value="${tier.betaPrice}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">PV Points</label>
                                    <input type="number" id="tier_${key}_pvPoints" value="${tier.pvPoints}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">ISP Commission (%)</label>
                                    <input type="number" id="tier_${key}_ispCommission" value="${tier.ispCommission}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                                </div>
                            </div>
                            <div style="margin-top: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Description</label>
                                <input type="text" id="tier_${key}_description" value="${tier.description}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                        </div>
                    `).join('')}
                </div>
                <button onclick="saveTiers()" style="margin-top: 2rem; padding: 1rem 2rem; background: var(--gold); color: var(--navy-blue); border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);">
                    <i class="fas fa-save"></i> Save All Changes
                </button>
            `;
        }

        async function saveTiers() {
            const tiers = {};
            ['FAM', 'BRONZE', 'COPPER', 'SILVER', 'GOLD', 'PLATINUM'].forEach(key => {
                tiers[key] = {
                    price: parseInt(document.getElementById(`tier_${key}_price`).value),
                    betaPrice: parseInt(document.getElementById(`tier_${key}_betaPrice`).value),
                    pvPoints: parseInt(document.getElementById(`tier_${key}_pvPoints`).value),
                    ispCommission: parseInt(document.getElementById(`tier_${key}_ispCommission`).value),
                    description: document.getElementById(`tier_${key}_description`).value
                };
            });

            try {
                const response = await fetch(`${API_URL}/settings/tiers`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tiers })
                });

                const result = await response.json();
                if (result.success) {
                    alert(' Tier settings saved successfully!');
                } else {
                    alert(' Error saving settings: ' + result.message);
                }
            } catch (error) {
                alert(' Error saving settings. Please try again.');
                console.error(error);
            }
        }

        async function saveCompensation() {
            const compensation = {
                // QPB
                qpbFirstThree: parseFloat(document.getElementById('comp_qpbFirstThree').value),
                qpbSubsequent: parseFloat(document.getElementById('comp_qpbSubsequent').value),

                // TSC
                tscG1: parseInt(document.getElementById('comp_tscG1').value),
                tscG2: parseInt(document.getElementById('comp_tscG2').value),
                tscG3: parseInt(document.getElementById('comp_tscG3').value),
                tscG4: parseInt(document.getElementById('comp_tscG4').value),
                tscG5to10: parseInt(document.getElementById('comp_tscG5to10').value),
                tscMaxLevels: parseInt(document.getElementById('comp_tscMaxLevels').value),

                // TPB
                tpbMaxPercentage: parseInt(document.getElementById('comp_tpbMaxPercentage').value),
                tpbMinActiveBuilders: parseInt(document.getElementById('comp_tpbMinActiveBuilders').value),

                // TLI
                tliPoolPercentage: parseInt(document.getElementById('comp_tliPoolPercentage').value),
                tliMinRange: parseInt(document.getElementById('comp_tliMinRange').value),
                tliMaxRange: parseInt(document.getElementById('comp_tliMaxRange').value),
                tliMinimumTier: document.getElementById('comp_tliMinimumTier').value,
                tliMinPV: parseInt(document.getElementById('comp_tliMinPV').value),
                tliConsecutiveMonths: parseInt(document.getElementById('comp_tliConsecutiveMonths').value),

                // CEO
                ceoAwardsEnabled: document.getElementById('comp_ceoAwardsEnabled').checked,
                ceoQuarterlyCompetitions: document.getElementById('comp_ceoQuarterlyCompetitions').checked,

                // MKT
                mktSellerKeepPercentage: parseInt(document.getElementById('comp_mktSellerKeepPercentage').value),
                mktPlatformFee: parseInt(document.getElementById('comp_mktPlatformFee').value),

                // General
                betaTesterLimit: parseInt(document.getElementById('comp_betaTesterLimit').value),
                betaTesterDiscount: parseInt(document.getElementById('comp_betaTesterDiscount').value)
            };

            try {
                const response = await fetch(`${API_URL}/settings/compensation`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ compensation })
                });

                const result = await response.json();
                if (result.success) {
                    alert(' Compensation plan settings saved successfully!');
                } else {
                    alert(' Error saving settings: ' + result.message);
                }
            } catch (error) {
                alert(' Error saving settings. Please try again.');
                console.error(error);
            }
        }

        function displayCompensationSection(comp) {
            const contentDiv = document.getElementById('compensation');
            contentDiv.innerHTML = `
                <h2>Compensation Plan - 7 Income Streams</h2>
                <p style="margin-bottom: 2rem; color: #666;">Configure all commission percentages, bonuses, and payment rules for the 7 income streams.</p>

                <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 1.5rem;">
                    <h3 style="color: var(--navy-blue); margin-bottom: 1rem;">1. ISP (Individual Sales Profit) - Monthly</h3>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;"><em>Defined in tier percentages (Tiers section): 20%-45% based on membership tier</em></p>
                </div>

                <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 1.5rem;">
                    <h3 style="color: var(--navy-blue); margin-bottom: 1rem;">2. QPB (Quick Pathfinder Bonus) - Monthly</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">First 3 Builders (%)</label>
                            <input type="number" step="0.1" id="comp_qpbFirstThree" value="${comp.qpbFirstThree || 7.5}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Subsequent Sets (%)</label>
                            <input type="number" step="0.1" id="comp_qpbSubsequent" value="${comp.qpbSubsequent || 10}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                    </div>
                </div>

                <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 1.5rem;">
                    <h3 style="color: var(--navy-blue); margin-bottom: 1rem;">3. TSC (Team Sales Commission) - Monthly</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Generation 1 (%)</label>
                            <input type="number" id="comp_tscG1" value="${comp.tscG1 || 10}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Generation 2 (%)</label>
                            <input type="number" id="comp_tscG2" value="${comp.tscG2 || 5}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Generation 3 (%)</label>
                            <input type="number" id="comp_tscG3" value="${comp.tscG3 || 3}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Generation 4 (%)</label>
                            <input type="number" id="comp_tscG4" value="${comp.tscG4 || 2}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Generations 5-10 (% each)</label>
                            <input type="number" id="comp_tscG5to10" value="${comp.tscG5to10 || 1}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Max Levels</label>
                            <input type="number" id="comp_tscMaxLevels" value="${comp.tscMaxLevels || 10}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                    </div>
                </div>

                <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 1.5rem;">
                    <h3 style="color: var(--navy-blue); margin-bottom: 1rem;">4. TPB (Team Performance Bonus) - Quarterly</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Max Percentage (% subject to tier)</label>
                            <input type="number" id="comp_tpbMaxPercentage" value="${comp.tpbMaxPercentage || 10}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Min Active Builders Required</label>
                            <input type="number" id="comp_tpbMinActiveBuilders" value="${comp.tpbMinActiveBuilders || 2}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                    </div>
                </div>

                <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 1.5rem;">
                    <h3 style="color: var(--navy-blue); margin-bottom: 1rem;">5. TLI (Team Leadership Incentive) - Quarterly (CEO Approved)</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Pool (% of Total TeamPV)</label>
                            <input type="number" id="comp_tliPoolPercentage" value="${comp.tliPoolPercentage || 10}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Min Range (R)</label>
                            <input type="number" id="comp_tliMinRange" value="${comp.tliMinRange || 2500}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Max Range (R)</label>
                            <input type="number" id="comp_tliMaxRange" value="${comp.tliMaxRange || 5000000}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Minimum Tier</label>
                            <select id="comp_tliMinimumTier" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="FAM" ${(comp.tliMinimumTier || 'SILVER') === 'FAM' ? 'selected' : ''}>FAM</option>
                                <option value="BRONZE" ${(comp.tliMinimumTier || 'SILVER') === 'BRONZE' ? 'selected' : ''}>BRONZE</option>
                                <option value="COPPER" ${(comp.tliMinimumTier || 'SILVER') === 'COPPER' ? 'selected' : ''}>COPPER</option>
                                <option value="SILVER" ${(comp.tliMinimumTier || 'SILVER') === 'SILVER' ? 'selected' : ''}>SILVER</option>
                                <option value="GOLD" ${(comp.tliMinimumTier || 'SILVER') === 'GOLD' ? 'selected' : ''}>GOLD</option>
                                <option value="PLATINUM" ${(comp.tliMinimumTier || 'SILVER') === 'PLATINUM' ? 'selected' : ''}>PLATINUM</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Min PV Required</label>
                            <input type="number" id="comp_tliMinPV" value="${comp.tliMinPV || 600}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Consecutive Months</label>
                            <input type="number" id="comp_tliConsecutiveMonths" value="${comp.tliConsecutiveMonths || 3}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                    </div>
                </div>

                <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 1.5rem;">
                    <h3 style="color: var(--navy-blue); margin-bottom: 1rem;">6. CEO (CEO Awards & Competitions) - Quarterly</h3>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;"><em>Variable rewards: luxury trips, cash bonuses, recognition</em></p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <div>
                            <label style="display: flex; align-items: center; font-weight: 600; color: #555; cursor: pointer;">
                                <input type="checkbox" id="comp_ceoAwardsEnabled" ${comp.ceoAwardsEnabled ? 'checked' : ''} style="margin-right: 0.5rem; width: 20px; height: 20px; cursor: pointer;">
                                CEO Awards Enabled
                            </label>
                        </div>
                        <div>
                            <label style="display: flex; align-items: center; font-weight: 600; color: #555; cursor: pointer;">
                                <input type="checkbox" id="comp_ceoQuarterlyCompetitions" ${comp.ceoQuarterlyCompetitions ? 'checked' : ''} style="margin-right: 0.5rem; width: 20px; height: 20px; cursor: pointer;">
                                Quarterly Competitions Enabled
                            </label>
                        </div>
                    </div>
                </div>

                <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 1.5rem;">
                    <h3 style="color: var(--navy-blue); margin-bottom: 1rem;">7. MKT (Marketplace Sales) - Monthly</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Seller Keeps (%)</label>
                            <input type="number" id="comp_mktSellerKeepPercentage" value="${comp.mktSellerKeepPercentage || 95}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Platform Fee (%)</label>
                            <input type="number" id="comp_mktPlatformFee" value="${comp.mktPlatformFee || 5}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                    </div>
                </div>

                <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 1.5rem;">
                    <h3 style="color: var(--navy-blue); margin-bottom: 1rem;">General Settings</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Beta Tester Limit (members)</label>
                            <input type="number" id="comp_betaTesterLimit" value="${comp.betaTesterLimit || 100}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Beta Discount (%)</label>
                            <input type="number" id="comp_betaTesterDiscount" value="${comp.betaTesterDiscount || 50}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                    </div>
                </div>

                <button onclick="saveCompensation()" style="margin-top: 1rem; padding: 1rem 2rem; background: var(--gold); color: var(--navy-blue); border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);">
                    <i class="fas fa-save"></i> Save All Compensation Settings
                </button>
            `;
        }

        function displayBrandingSection(branding) {
            const contentDiv = document.getElementById('branding');
            contentDiv.innerHTML = `
                <h2>Branding Settings</h2>
                <p style="margin-bottom: 2rem; color: #666;">Configure your platform's visual identity including colors, fonts, and company information.</p>

                <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h3 style="color: var(--navy-blue); margin-bottom: 1.5rem;">Company Information</h3>
                    <div style="display: grid; gap: 1rem; margin-bottom: 2rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Company Name</label>
                            <input type="text" id="brand_companyName" value="${branding.companyName}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Tagline</label>
                            <input type="text" id="brand_tagline" value="${branding.tagline}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                    </div>

                    <h3 style="color: var(--navy-blue); margin-bottom: 1.5rem;">Brand Colors</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Primary Color (Navy Blue)</label>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="color" id="brand_primaryColor" value="${branding.primaryColor}" style="width: 60px; height: 40px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">
                                <input type="text" id="brand_primaryColor_text" value="${branding.primaryColor}" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;" onchange="document.getElementById('brand_primaryColor').value = this.value">
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Secondary Color</label>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="color" id="brand_secondaryColor" value="${branding.secondaryColor}" style="width: 60px; height: 40px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">
                                <input type="text" id="brand_secondaryColor_text" value="${branding.secondaryColor}" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;" onchange="document.getElementById('brand_secondaryColor').value = this.value">
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Accent Color</label>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="color" id="brand_accentColor" value="${branding.accentColor}" style="width: 60px; height: 40px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">
                                <input type="text" id="brand_accentColor_text" value="${branding.accentColor}" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;" onchange="document.getElementById('brand_accentColor').value = this.value">
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Gold Color</label>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="color" id="brand_goldColor" value="${branding.goldColor}" style="width: 60px; height: 40px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">
                                <input type="text" id="brand_goldColor_text" value="${branding.goldColor}" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;" onchange="document.getElementById('brand_goldColor').value = this.value">
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Orange Color</label>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="color" id="brand_orangeColor" value="${branding.orangeColor}" style="width: 60px; height: 40px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">
                                <input type="text" id="brand_orangeColor_text" value="${branding.orangeColor}" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;" onchange="document.getElementById('brand_orangeColor').value = this.value">
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">White Color</label>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="color" id="brand_whiteColor" value="${branding.whiteColor}" style="width: 60px; height: 40px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">
                                <input type="text" id="brand_whiteColor_text" value="${branding.whiteColor}" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;" onchange="document.getElementById('brand_whiteColor').value = this.value">
                            </div>
                        </div>
                    </div>

                    <h3 style="color: var(--navy-blue); margin-bottom: 1.5rem;">Typography</h3>
                    <div style="margin-bottom: 2rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Font Family</label>
                        <input type="text" id="brand_fontFamily" value="${branding.fontFamily}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;" placeholder="e.g., 'Poppins', sans-serif">
                    </div>

                    <button onclick="saveBranding()" style="padding: 1rem 2rem; background: var(--gold); color: var(--navy-blue); border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);">
                        <i class="fas fa-save"></i> Save Branding Settings
                    </button>
                </div>
            `;

            // Sync color picker with text input
            ['primaryColor', 'secondaryColor', 'accentColor', 'goldColor', 'orangeColor', 'whiteColor'].forEach(colorName => {
                const colorPicker = document.getElementById(`brand_${colorName}`);
                const textInput = document.getElementById(`brand_${colorName}_text`);

                if (colorPicker) {
                    colorPicker.addEventListener('input', function() {
                        textInput.value = this.value.toUpperCase();
                    });
                }
            });
        }

        async function saveBranding() {
            const branding = {
                companyName: document.getElementById('brand_companyName').value,
                tagline: document.getElementById('brand_tagline').value,
                primaryColor: document.getElementById('brand_primaryColor').value,
                secondaryColor: document.getElementById('brand_secondaryColor').value,
                accentColor: document.getElementById('brand_accentColor').value,
                goldColor: document.getElementById('brand_goldColor').value,
                orangeColor: document.getElementById('brand_orangeColor').value,
                whiteColor: document.getElementById('brand_whiteColor').value,
                fontFamily: document.getElementById('brand_fontFamily').value
            };

            try {
                const response = await fetch(`${API_URL}/settings/branding`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ branding })
                });

                const result = await response.json();
                if (result.success) {
                    alert(' Branding settings saved successfully!');
                } else {
                    alert(' Error saving settings: ' + result.message);
                }
            } catch (error) {
                alert(' Error saving settings. Please try again.');
                console.error(error);
            }
        }

        async function displayUsersSection() {
            const contentDiv = document.getElementById('users');
            contentDiv.innerHTML = `
                <h2>User Management</h2>
                <p style="margin-bottom: 2rem; color: #666;">Create users, manage tiers, grant manual access (cash/in-kind payments), and view all member details.</p>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
                    <button onclick="showCreateUserModal()" style="padding: 0.8rem 1.5rem; background: var(--gold); color: var(--navy-blue); border: none; border-radius: 8px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);">
                        <i class="fas fa-user-plus"></i> Create New User
                    </button>
                    <button onclick="showGrantManualAccessModal()" style="padding: 0.8rem 1.5rem; background: #28a745; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);">
                        <i class="fas fa-hand-holding-usd"></i> Grant Manual Access
                    </button>
                    <button onclick="loadUsersData()" style="padding: 0.8rem 1.5rem; background: var(--navy-blue); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button onclick="clearAllDemoUsers()" style="padding: 0.8rem 1.5rem; background: #dc3545; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);">
                        <i class="fas fa-trash-alt"></i> Clear All Demo Users
                    </button>
                </div>

                <!-- Search and Filter -->
                <div style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 200px; gap: 1rem; align-items: end;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Search Users</label>
                            <input type="text" id="userSearch" placeholder="Search by name, email, or ID..." style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 5px;" oninput="filterUsers()">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Filter by Tier</label>
                            <select id="tierFilter" style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 5px;" onchange="filterUsers()">
                                <option value="">All Tiers</option>
                                <option value="FAM">FAM - Free Affiliate</option>
                                <option value="BRONZE">Bronze</option>
                                <option value="COPPER">Copper</option>
                                <option value="SILVER">Silver</option>
                                <option value="GOLD">Gold</option>
                                <option value="PLATINUM">Platinum</option>
                            </select>
                        </div>
                        <div>
                            <button onclick="clearFilters()" style="width: 100%; padding: 0.7rem; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                Clear Filters
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Users Table -->
                <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow-x: auto;">
                    <div id="usersTableContainer">
                        <p style="text-align: center; color: #666;">Loading users...</p>
                    </div>
                </div>

                <!-- Create User Modal -->
                <div id="createUserModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 2rem; border-radius: 15px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <h3 style="color: var(--navy-blue); margin-bottom: 1.5rem;">Create New User</h3>

                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Full Name *</label>
                            <input type="text" id="newUserName" style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 5px;" placeholder="John Doe">
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Email Address *</label>
                            <input type="email" id="newUserEmail" style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 5px;" placeholder="john@example.com">
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Phone Number</label>
                            <input type="tel" id="newUserPhone" style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 5px;" placeholder="+27 123 456 789">
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Membership Tier *</label>
                            <select id="newUserTier" style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="FAM">FAM - Free Affiliate</option>
                                <option value="BRONZE">Bronze Legacy Builder</option>
                                <option value="COPPER">Copper Legacy Builder</option>
                                <option value="SILVER">Silver Legacy Builder</option>
                                <option value="GOLD">Gold Legacy Builder</option>
                                <option value="PLATINUM">Platinum Legacy Builder</option>
                            </select>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Password *</label>
                            <input type="password" id="newUserPassword" style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 5px;" placeholder="Min 8 characters">
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: flex; align-items: center; font-weight: 600; color: #555; cursor: pointer;">
                                <input type="checkbox" id="newUserFreeAccess" style="margin-right: 0.5rem; width: 20px; height: 20px; cursor: pointer;">
                                Grant Manual Access (Cash/In-Kind Payment)
                            </label>
                        </div>

                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button onclick="hideCreateUserModal()" style="padding: 0.8rem 1.5rem; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Cancel
                            </button>
                            <button onclick="createUser()" style="padding: 0.8rem 1.5rem; background: var(--gold); color: var(--navy-blue); border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                                <i class="fas fa-save"></i> Create User
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Grant Manual Access Modal -->
                <div id="grantManualAccessModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; overflow-y: auto;">
                    <div style="background: white; padding: 2rem; border-radius: 15px; max-width: 700px; width: 90%; margin: 2rem auto; max-height: 90vh; overflow-y: auto;">
                        <h3 style="color: var(--navy-blue); margin-bottom: 0.5rem;">Register New Member - Manual Access</h3>
                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 1.5rem;">For members who paid via cash, in-kind, or alternative payment methods.</p>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Full Name *</label>
                                <input type="text" id="manualAccessName" style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 5px;" placeholder="John Doe">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Email Address *</label>
                                <input type="email" id="manualAccessEmail" style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 5px;" placeholder="john@example.com">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Phone Number *</label>
                                <input type="tel" id="manualAccessPhone" style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 5px;" placeholder="+27 123 456 789">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">ID Number</label>
                                <input type="text" id="manualAccessIdNumber" style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 5px;" placeholder="Optional">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Membership Tier *</label>
                                <select id="manualAccessTier" style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 5px;">
                                    <option value="FAM">FAM - Free Affiliate</option>
                                    <option value="BRONZE" selected>Bronze Legacy Builder</option>
                                    <option value="COPPER">Copper Legacy Builder</option>
                                    <option value="SILVER">Silver Legacy Builder</option>
                                    <option value="GOLD">Gold Legacy Builder</option>
                                    <option value="PLATINUM">Platinum Legacy Builder</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Sponsor Code</label>
                                <input type="text" id="manualAccessSponsorCode" style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 5px;" placeholder="Optional">
                            </div>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555;">Password *</label>
                            <input type="password" id="manualAccessPassword" style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 5px;" placeholder="Min 8 characters" value="Welcome@123">
                        </div>

                        <div style="background: #e8f5e9; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #28a745;">
                            <p style="margin: 0; color: #2e7d32; font-size: 0.9rem;">
                                <i class="fas fa-hand-holding-usd"></i> This registration is marked as <strong>Manual Access</strong> (cash/in-kind payment received)
                            </p>
                        </div>

                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button onclick="hideGrantManualAccessModal()" style="padding: 0.8rem 1.5rem; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Cancel
                            </button>
                            <button onclick="grantManualAccess()" style="padding: 0.8rem 1.5rem; background: #28a745; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                                <i class="fas fa-user-plus"></i> Register Member
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Success Modal for Manual Access -->
                <div id="manualAccessSuccessModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 2rem; border-radius: 15px; max-width: 600px; width: 90%;">
                        <div style="text-align: center; margin-bottom: 1.5rem;">
                            <i class="fas fa-check-circle" style="font-size: 4rem; color: #28a745;"></i>
                            <h3 style="color: var(--navy-blue); margin-top: 1rem;">Member Registered Successfully!</h3>
                        </div>

                        <div id="manualAccessSuccessDetails" style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <!-- Details will be populated by JavaScript -->
                        </div>

                        <button onclick="closeManualAccessSuccessModal()" style="width: 100%; padding: 1rem; background: var(--navy-blue); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                            Close
                        </button>
                    </div>
                </div>
            `;

            // Load users data
            await loadUsersData();
        }

        function displayContentSection() {
            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = `
                <h2>Content Management</h2>
                <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <p>Content management functionality will be implemented here.</p>
                    <p>Features: Update 90-day lessons, manage course materials, edit content.</p>
                </div>
            `;
        }

        function displayPaymentSection() {
            const contentDiv = document.getElementById('payment');
            contentDiv.innerHTML = `
                <h2>Payment Gateways</h2>
                <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <p>Payment gateway management functionality will be implemented here.</p>
                    <p>Gateways: Yoco, Payfast, CoinPayments, Bank Transfer</p>
                </div>
            `;
        }

        function displayStatsSection() {
            const contentDiv = document.getElementById('statistics');
            contentDiv.innerHTML = `
                <h2>Statistics</h2>
                <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <p>Statistics and analytics will be displayed here.</p>
                </div>
            `;
        }

        async function resetStats() {
            if (!confirm('Are you sure you want to reset all statistics? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/stats/reset`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason: 'Manual admin reset' })
                });

                const result = await response.json();
                if (result.success) {
                    alert('Statistics reset successfully!');
                    loadStatistics();
                }
            } catch (error) {
                alert('Error resetting statistics');
            }
        }

        // ==================== USER MANAGEMENT FUNCTIONS ====================

        let allUsers = []; // Store all users for filtering

        // Clear All Demo Users - Start Fresh for Real Beta Testers
        async function clearAllDemoUsers() {
            const confirmation = prompt(' WARNING: This will DELETE ALL USERS from the database!\n\nThis action CANNOT be undone and will permanently remove all user data.\n\nType "DELETE ALL USERS" to confirm:', '');

            if (confirmation !== 'DELETE ALL USERS') {
                alert('Action cancelled. Users were not deleted.');
                return;
            }

            const doubleConfirm = confirm('Are you ABSOLUTELY SURE? This will delete ALL users including admins!\n\nClick OK to proceed with deletion.');

            if (!doubleConfirm) {
                alert('Action cancelled. Users were not deleted.');
                return;
            }

            try {
                // Get all users first
                const response = await fetch(`${API_URL}/users?limit=10000`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                if (!result.success || !result.data) {
                    alert('Error fetching users to delete');
                    return;
                }

                const users = result.data;
                let deletedCount = 0;
                let failedCount = 0;

                // Show progress
                const progressDiv = document.createElement('div');
                progressDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 10px 50px rgba(0,0,0,0.3); z-index: 10000; min-width: 300px; text-align: center;';
                progressDiv.innerHTML = `
                    <h3 style="color: var(--navy-blue); margin-bottom: 1rem;">Deleting Users...</h3>
                    <p id="deleteProgress">Deleting 0 of ${users.length} users...</p>
                `;
                document.body.appendChild(progressDiv);

                // Delete each user
                for (let i = 0; i < users.length; i++) {
                    const user = users[i];
                    document.getElementById('deleteProgress').textContent = `Deleting ${i + 1} of ${users.length} users...`;

                    try {
                        const deleteResponse = await fetch(`${API_URL}/users/${user._id}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${authToken}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (deleteResponse.ok) {
                            deletedCount++;
                        } else {
                            failedCount++;
                        }
                    } catch (error) {
                        failedCount++;
                        console.error(`Failed to delete user ${user.email}:`, error);
                    }
                }

                document.body.removeChild(progressDiv);

                alert(` Deletion Complete!\n\nDeleted: ${deletedCount} users\nFailed: ${failedCount} users\n\nYou can now start fresh with your first 100 real beta testers!`);

                // Reload the users table
                loadUsersData();

            } catch (error) {
                console.error('Error clearing demo users:', error);
                alert(' Error clearing demo users. Please try again.');
            }
        }

        async function loadUsersData() {
            try {
                const response = await fetch(`${API_URL}/users`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                if (result.success) {
                    allUsers = result.data || result.users || [];
                    renderUsersTable(allUsers);
                } else {
                    document.getElementById('usersTableContainer').innerHTML = `
                        <p style="text-align: center; color: #dc3545;">Error loading users: ${result.message}</p>
                    `;
                }
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersTableContainer').innerHTML = `
                    <p style="text-align: center; color: #dc3545;">Error loading users. Please check if the backend server is running.</p>
                `;
            }
        }

        function renderUsersTable(users) {
            const container = document.getElementById('usersTableContainer');

            if (!users || users.length === 0) {
                container.innerHTML = `
                    <p style="text-align: center; color: #666; padding: 2rem;">No users found. Create your first user to get started!</p>
                `;
                return;
            }

            // Communication Action Buttons
            const actionButtonsHTML = `
                <div style="background: white; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h4 style="margin: 0 0 0.5rem 0; color: var(--navy-blue);">
                                <span id="selectedCount">0</span> Builder(s) Selected
                            </h4>
                            <button onclick="selectAllUsers()" style="padding: 0.5rem 1rem; background: var(--navy-blue); color: var(--gold); border: none; border-radius: 5px; cursor: pointer; font-size: 0.85rem; margin-right: 0.5rem;">
                                <i class="fas fa-check-square"></i> Select All
                            </button>
                            <button onclick="deselectAllUsers()" style="padding: 0.5rem 1rem; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85rem;">
                                <i class="fas fa-square"></i> Deselect All
                            </button>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button onclick="sendToSelected('whatsapp')" style="padding: 0.7rem 1.5rem; background: #25D366; color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; font-size: 0.9rem;">
                                <i class="fab fa-whatsapp"></i> WhatsApp Selected
                            </button>
                            <button onclick="sendToSelected('sms')" style="padding: 0.7rem 1.5rem; background: linear-gradient(135deg, var(--gold), var(--orange)); color: var(--navy-blue); border: none; border-radius: 50px; cursor: pointer; font-weight: bold; font-size: 0.9rem;">
                                <i class="fas fa-sms"></i> SMS Selected
                            </button>
                            <button onclick="sendToSelected('email')" style="padding: 0.7rem 1.5rem; background: var(--navy-blue); color: var(--gold); border: none; border-radius: 50px; cursor: pointer; font-weight: bold; font-size: 0.9rem;">
                                <i class="fas fa-envelope"></i> Email Selected
                            </button>
                        </div>
                    </div>
                </div>
            `;

            const tableHTML = `
                ${actionButtonsHTML}
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--navy-blue); color: white;">
                            <th style="padding: 1rem; text-align: center; border-bottom: 2px solid #ddd; width: 50px;">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleAllUsers(this.checked)" style="width: 18px; height: 18px; cursor: pointer;">
                            </th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #ddd;">Name</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #ddd;">Email</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #ddd;">Member #</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #ddd;">Phone</th>
                            <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #ddd;">Tier</th>
                            <th style="padding: 1rem; text-align: center; border-bottom: 2px solid #ddd;">Quick Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map((user, index) => `
                            <tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'}; border-bottom: 1px solid #eee;" class="user-row">
                                <td style="padding: 1rem; text-align: center;">
                                    <input type="checkbox" class="user-checkbox" data-user='${JSON.stringify(user).replace(/'/g, "&#39;")}' onchange="updateSelectedCount()" style="width: 18px; height: 18px; cursor: pointer;">
                                </td>
                                <td style="padding: 1rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <strong>${user.firstName} ${user.lastName}</strong>
                                        <button onclick='viewUserDetails(${JSON.stringify(user).replace(/'/g, "&#39;")})' style="padding: 0.2rem 0.5rem; background: #17a2b8; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.75rem;">
                                            <i class="fas fa-info-circle"></i> View
                                        </button>
                                    </div>
                                </td>
                                <td style="padding: 1rem;">${user.email || 'N/A'}</td>
                                <td style="padding: 1rem;">
                                    <span style="background: #e8f5e9; color: #28a745; padding: 0.3rem 0.8rem; border-radius: 5px; font-size: 0.85rem; font-weight: bold; font-family: monospace;">
                                        ${user.referralCode || 'N/A'}
                                    </span>
                                </td>
                                <td style="padding: 1rem;">${user.phone || 'N/A'}</td>
                                <td style="padding: 1rem;">
                                    <span style="background: var(--gold); color: var(--navy-blue); padding: 0.3rem 0.8rem; border-radius: 5px; font-size: 0.85rem; font-weight: bold;">
                                        ${user.tier || 'FAM'}
                                    </span>
                                </td>
                                <td style="padding: 1rem; text-align: center;">
                                    <div style="display: flex; gap: 0.3rem; justify-content: center; flex-wrap: wrap;">
                                        <button onclick='sendToUser(${JSON.stringify(user).replace(/'/g, "&#39;")}, "whatsapp")' title="Send WhatsApp" style="padding: 0.4rem 0.7rem; background: #25D366; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85rem;">
                                            <i class="fab fa-whatsapp"></i>
                                        </button>
                                        <button onclick='sendToUser(${JSON.stringify(user).replace(/'/g, "&#39;")}, "sms")' title="Send SMS" style="padding: 0.4rem 0.7rem; background: var(--orange); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85rem;">
                                            <i class="fas fa-sms"></i>
                                        </button>
                                        <button onclick='sendToUser(${JSON.stringify(user).replace(/'/g, "&#39;")}, "email")' title="Send Email" style="padding: 0.4rem 0.7rem; background: var(--navy-blue); color: var(--gold); border: none; border-radius: 5px; cursor: pointer; font-size: 0.85rem;">
                                            <i class="fas fa-envelope"></i>
                                        </button>
                                        <button onclick='editUser(${JSON.stringify(user).replace(/'/g, "&#39;")})' title="Edit User" style="padding: 0.4rem 0.7rem; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85rem;">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteUser('${user._id}')" title="Delete User" style="padding: 0.4rem 0.7rem; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85rem;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <p style="margin-top: 1rem; color: #666; font-size: 0.9rem;">Total Users: ${users.length}</p>
            `;

            container.innerHTML = tableHTML;
        }

        function filterUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const tierFilter = document.getElementById('tierFilter').value;

            let filtered = allUsers;

            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(user =>
                    (user.name && user.name.toLowerCase().includes(searchTerm)) ||
                    (user.email && user.email.toLowerCase().includes(searchTerm)) ||
                    (user._id && user._id.toLowerCase().includes(searchTerm))
                );
            }

            // Apply tier filter
            if (tierFilter) {
                filtered = filtered.filter(user => user.tier === tierFilter);
            }

            renderUsersTable(filtered);
        }

        function clearFilters() {
            document.getElementById('userSearch').value = '';
            document.getElementById('tierFilter').value = '';
            renderUsersTable(allUsers);
        }

        function showCreateUserModal() {
            const modal = document.getElementById('createUserModal');
            modal.style.display = 'flex';
        }

        function hideCreateUserModal() {
            const modal = document.getElementById('createUserModal');
            modal.style.display = 'none';
            // Clear form
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserEmail').value = '';
            document.getElementById('newUserPhone').value = '';
            document.getElementById('newUserTier').value = 'FAM';
            document.getElementById('newUserPassword').value = '';
            document.getElementById('newUserFreeAccess').checked = false;
        }

        async function createUser() {
            const name = document.getElementById('newUserName').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const phone = document.getElementById('newUserPhone').value.trim();
            const tier = document.getElementById('newUserTier').value;
            const password = document.getElementById('newUserPassword').value;
            const isBetaTester = document.getElementById('newUserFreeAccess').checked;

            // Validation
            if (!name || !email || !password) {
                alert(' Please fill in all required fields (Name, Email, Password)');
                return;
            }

            if (password.length < 8) {
                alert(' Password must be at least 8 characters long');
                return;
            }

            // Split name into firstName and lastName
            const nameParts = name.split(' ');
            const firstName = nameParts[0];
            const lastName = nameParts.slice(1).join(' ') || firstName;

            const userData = {
                firstName,
                lastName,
                email,
                phone,
                tier,
                password,
                isBetaTester
            };

            try {
                const response = await fetch(`${API_URL}/users`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();
                if (result.success) {
                    const memberId = result.data.referralCode || 'Not assigned';
                    const referralLink = result.data.referralLink || `${window.location.origin}/register.html?ref=${memberId}`;

                    // Create a detailed success message
                    const successMessage = ` User created successfully!\n\n` +
                        ` MEMBER DETAILS:\n` +
                        `\n` +
                        ` Name: ${firstName} ${lastName}\n` +
                        ` Email: ${email}\n` +
                        ` Tier: ${tier}\n` +
                        ` Member ID: ${memberId}\n\n` +
                        ` REFERRAL LINK:\n${referralLink}\n\n` +
                        ` TIP: Copy the Member ID and Referral Link above.\n` +
                        `Share them with the new member for inviting purposes!`;

                    alert(successMessage);

                    // Copy referral link to clipboard
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(referralLink).then(() => {
                            console.log('Referral link copied to clipboard');
                        }).catch(err => {
                            console.error('Could not copy text: ', err);
                        });
                    }

                    hideCreateUserModal();
                    loadUsersData();
                } else {
                    alert(' Error creating user: ' + result.message);
                }
            } catch (error) {
                alert(' Error creating user. Please try again.');
                console.error(error);
            }
        }

        function showGrantManualAccessModal() {
            const modal = document.getElementById('grantManualAccessModal');
            modal.style.display = 'flex';
        }

        function hideGrantManualAccessModal() {
            const modal = document.getElementById('grantManualAccessModal');
            modal.style.display = 'none';
            // Clear form
            document.getElementById('manualAccessName').value = '';
            document.getElementById('manualAccessEmail').value = '';
            document.getElementById('manualAccessPhone').value = '';
            document.getElementById('manualAccessIdNumber').value = '';
            document.getElementById('manualAccessTier').value = 'BRONZE';
            document.getElementById('manualAccessSponsorCode').value = '';
            document.getElementById('manualAccessPassword').value = 'Welcome@123';
        }

        async function grantManualAccess() {
            const name = document.getElementById('manualAccessName').value.trim();
            const email = document.getElementById('manualAccessEmail').value.trim();
            const phone = document.getElementById('manualAccessPhone').value.trim();
            const tier = document.getElementById('manualAccessTier').value;
            const sponsorCode = document.getElementById('manualAccessSponsorCode').value.trim();
            const password = document.getElementById('manualAccessPassword').value;

            // Validation
            if (!name || !email || !phone) {
                alert(' Please fill in all required fields (Name, Email, Phone)');
                return;
            }

            if (password.length < 8) {
                alert(' Password must be at least 8 characters long');
                return;
            }

            // Split name into firstName and lastName
            const nameParts = name.split(' ');
            const firstName = nameParts[0];
            const lastName = nameParts.slice(1).join(' ') || firstName;

            const userData = {
                firstName,
                lastName,
                email,
                phone,
                tier,
                sponsorCode,
                password,
                isBetaTester: false // Manual access users are not beta testers by default
            };

            try {
                const response = await fetch(`${API_URL}/users`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();
                if (result.success) {
                    hideGrantManualAccessModal();
                    showManualAccessSuccess(result.data);
                    loadUsersData();
                } else {
                    alert(' Error registering member: ' + result.message);
                }
            } catch (error) {
                alert(' Error registering member. Please try again.');
                console.error(error);
            }
        }

        function showManualAccessSuccess(userData) {
            const modal = document.getElementById('manualAccessSuccessModal');
            const detailsDiv = document.getElementById('manualAccessSuccessDetails');

            detailsDiv.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <strong style="color: var(--navy-blue);">Member Name:</strong><br>
                    <span style="font-size: 1.1rem;">${userData.firstName} ${userData.lastName}</span>
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong style="color: var(--navy-blue);">Email:</strong><br>
                    <span>${userData.email}</span>
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong style="color: var(--navy-blue);">Membership Number (Referral Code):</strong><br>
                    <span style="font-size: 1.2rem; font-weight: bold; color: #28a745; background: #e8f5e9; padding: 0.5rem 1rem; border-radius: 5px; display: inline-block;">${userData.referralCode}</span>
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong style="color: var(--navy-blue);">Referral Link:</strong><br>
                    <input type="text" value="https://z2blegacybuilders.co.za/tiers.html?ref=${userData.referralCode}" readonly style="width: 100%; padding: 0.5rem; border: 2px solid #28a745; border-radius: 5px; font-family: monospace; font-size: 0.9rem;" onclick="this.select(); document.execCommand('copy'); alert('Referral link copied to clipboard!');">
                    <small style="color: #666; display: block; margin-top: 0.3rem;">Click to copy and share with prospects</small>
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong style="color: var(--navy-blue);">User ID:</strong><br>
                    <span style="font-family: monospace;">${userData.id}</span>
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong style="color: var(--navy-blue);">Access Type:</strong><br>
                    <span style="background: #28a745; color: white; padding: 0.3rem 0.8rem; border-radius: 5px; font-size: 0.9rem;">Manual Access (Cash/In-Kind)</span>
                </div>
                <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; border-left: 4px solid #ffc107; margin-top: 1rem;">
                    <p style="margin: 0; color: #856404; font-size: 0.9rem;">
                        <i class="fas fa-info-circle"></i> <strong>Next Steps:</strong><br>
                         Share the referral code with the member<br>
                         Member can log in with their email and password<br>
                         Placement in 3x3 matrix will be automatic based on sponsor
                    </p>
                </div>
            `;

            modal.style.display = 'flex';
        }

        function closeManualAccessSuccessModal() {
            const modal = document.getElementById('manualAccessSuccessModal');
            modal.style.display = 'none';
        }

        function editUser(user) {
            const newTier = prompt(`Edit tier for ${user.name}\n\nCurrent tier: ${user.tier}\n\nEnter new tier (FAM, BRONZE, COPPER, SILVER, GOLD, PLATINUM):`, user.tier);

            if (!newTier) return;

            const validTiers = ['FAM', 'BRONZE', 'COPPER', 'SILVER', 'GOLD', 'PLATINUM'];
            if (!validTiers.includes(newTier.toUpperCase())) {
                alert(' Invalid tier. Please use: FAM, BRONZE, COPPER, SILVER, GOLD, or PLATINUM');
                return;
            }

            updateUserTier(user._id, newTier.toUpperCase());
        }

        async function updateUserTier(userId, newTier) {
            try {
                const response = await fetch(`${API_URL}/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tier: newTier })
                });

                const result = await response.json();
                if (result.success) {
                    alert(' User tier updated successfully!');
                    loadUsersData();
                } else {
                    alert(' Error updating user: ' + result.message);
                }
            } catch (error) {
                alert(' Error updating user. Please try again.');
                console.error(error);
            }
        }

        async function deleteUser(userId) {
            if (!confirm(' Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                if (result.success) {
                    alert(' User deleted successfully!');
                    loadUsersData();
                } else {
                    alert(' Error deleting user: ' + result.message);
                }
            } catch (error) {
                alert(' Error deleting user. Please try again.');
                console.error(error);
            }
        }

        // ============================================
        // FAM TIER MANAGEMENT FUNCTIONS
        // ============================================

        async function loadFAMStats() {
            try {
                const response = await fetch(`${API_URL}/users/fam/stats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const result = await response.json();
                if (result.success) {
                    displayFAMStats(result.data);
                } else {
                    alert(' Error loading FAM statistics');
                }
            } catch (error) {
                console.error('Error loading FAM stats:', error);
                alert(' Error loading FAM statistics. Please try again.');
            }
        }

        function displayFAMStats(data) {
            document.getElementById('famTotalCount').textContent = data.totalFAM || 0;
            document.getElementById('famActiveCount').textContent = data.activeFAM || 0;
            document.getElementById('famExpiredCount').textContent = data.expiredFAM || 0;
            document.getElementById('famExpiringSoonCount').textContent = data.expiringSoonCount || 0;

            // Display expiring soon list
            if (data.expiringSoon && data.expiringSoon.length > 0) {
                document.getElementById('famExpiringSoonSection').style.display = 'block';
                const listHTML = data.expiringSoon.map(user => {
                    const expiryDate = new Date(user.famExpiryDate).toLocaleDateString();
                    return `
                        <div style="padding: 0.5rem; border-bottom: 1px solid #eee;">
                            <strong>${user.firstName} ${user.lastName}</strong> (${user.email})<br>
                            <small>Expires: ${expiryDate} | Months Remaining: ${user.famMonthsRemaining}</small>
                        </div>
                    `;
                }).join('');
                document.getElementById('famExpiringSoonList').innerHTML = listHTML;
            } else {
                document.getElementById('famExpiringSoonSection').style.display = 'none';
            }
        }

        async function refreshFAMCredits() {
            if (!confirm(' This will add 5 credits to all eligible FAM members.\n\nRun this once a month (30+ days since last refresh).\n\nContinue?')) {
                return;
            }

            const resultDiv = document.getElementById('famActionResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Refreshing FAM credits...</p>';

            try {
                const response = await fetch(`${API_URL}/users/fam/refresh-credits`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                if (result.success) {
                    const data = result.data;
                    let html = `
                        <h3 style="color: var(--success);"> FAM Credit Refresh Completed!</h3>
                        <p><strong>Total FAM Users:</strong> ${data.totalFAMUsers}</p>
                        <p><strong>Credits Refreshed:</strong> ${data.refreshedCount} users</p>
                        <p><strong>Skipped (too soon):</strong> ${data.skippedCount} users</p>
                    `;

                    if (data.refreshResults && data.refreshResults.length > 0) {
                        html += '<h4>Refreshed Users:</h4><ul>';
                        data.refreshResults.forEach(user => {
                            html += `<li>${user.name}: +5 credits (New Balance: ${user.newBalance}, Months Remaining: ${user.monthsRemaining})</li>`;
                        });
                        html += '</ul>';
                    }

                    resultDiv.innerHTML = html;
                    loadFAMStats(); // Reload stats
                } else {
                    resultDiv.innerHTML = `<p style="color: var(--danger);"> Error: ${result.message}</p>`;
                }
            } catch (error) {
                console.error('Error refreshing FAM credits:', error);
                resultDiv.innerHTML = '<p style="color: var(--danger);"> Error refreshing credits. Please try again.</p>';
            }
        }

        async function checkFAMExpiry() {
            if (!confirm(' This will suspend all FAM accounts that have expired (90+ days).\n\nRun this daily to check for expired accounts.\n\nContinue?')) {
                return;
            }

            const resultDiv = document.getElementById('famActionResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Checking FAM expiry...</p>';

            try {
                const response = await fetch(`${API_URL}/users/fam/check-expiry`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                if (result.success) {
                    const data = result.data;
                    let html = `
                        <h3 style="color: var(--warning);"> FAM Expiry Check Completed!</h3>
                        <p><strong>Expired Accounts:</strong> ${data.expiredCount}</p>
                    `;

                    if (data.expiredResults && data.expiredResults.length > 0) {
                        html += '<h4>Suspended Users (Need Upgrade):</h4><ul>';
                        data.expiredResults.forEach(user => {
                            const expiredDate = new Date(user.expiredOn).toLocaleDateString();
                            html += `<li>${user.name} (${user.email}) - Expired: ${expiredDate}</li>`;
                        });
                        html += '</ul>';
                    } else {
                        html += '<p> No expired FAM accounts found. All FAM users are still within their 3-month trial period.</p>';
                    }

                    resultDiv.innerHTML = html;
                    loadFAMStats(); // Reload stats
                } else {
                    resultDiv.innerHTML = `<p style="color: var(--danger);"> Error: ${result.message}</p>`;
                }
            } catch (error) {
                console.error('Error checking FAM expiry:', error);
                resultDiv.innerHTML = '<p style="color: var(--danger);"> Error checking expiry. Please try again.</p>';
            }
        }
    </script>
</body>
</html>
