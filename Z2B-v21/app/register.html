<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - Z2B Legacy Builders</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --navy-blue: #0A2647;
            --gold: #FFD700;
            --royal-gold: #D4AF37;
            --orange: #FF6B35;
            --light-gold: #FFF4CC;
            --dark-navy: #051428;
            --white: #FFFFFF;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--navy-blue) 0%, var(--dark-navy) 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            padding: 2rem 0;
        }

        .register-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .register-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .register-header {
            background: linear-gradient(135deg, var(--gold), var(--orange));
            padding: 2rem;
            text-align: center;
            color: var(--navy-blue);
        }

        .register-header h2 {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .register-body {
            padding: 2rem;
        }

        .form-label {
            font-weight: 600;
            color: var(--navy-blue);
        }

        .form-control:focus {
            border-color: var(--gold);
            box-shadow: 0 0 0 0.2rem rgba(255, 215, 0, 0.25);
        }

        .payment-option {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .payment-option:hover {
            border-color: var(--gold);
            background-color: var(--light-gold);
        }

        .payment-option.active {
            border-color: var(--gold);
            background-color: var(--light-gold);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        .payment-option input[type="radio"] {
            width: 20px;
            height: 20px;
            margin-right: 1rem;
        }

        .payment-details {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            margin-top: 1rem;
            display: none;
        }

        .payment-details.active {
            display: block;
        }

        .btn-register {
            background: linear-gradient(135deg, var(--gold), var(--orange));
            color: var(--navy-blue);
            border: none;
            padding: 0.8rem 3rem;
            font-weight: bold;
            border-radius: 50px;
            width: 100%;
            font-size: 1.1rem;
            transition: all 0.3s;
        }

        .btn-register:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(255, 215, 0, 0.6);
            color: var(--white);
        }

        .sponsor-info {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 107, 53, 0.1));
            padding: 1rem;
            border-radius: 10px;
            border-left: 4px solid var(--gold);
            margin-bottom: 1.5rem;
        }

        .alert-info-custom {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="register-container">
        <div class="register-card">
            <div class="register-header">
                <h2><i class="fas fa-user-plus"></i> Join Z2B Legacy Builders</h2>
                <p class="mb-0">Start Your Journey to Financial Freedom</p>
            </div>

            <div class="register-body">
                <form id="registerForm">
                    <!-- Sponsor Information -->
                    <div class="sponsor-info" id="sponsorInfo" style="display: none;">
                        <h6 class="mb-2"><i class="fas fa-handshake"></i> Your Sponsor</h6>
                        <p class="mb-0" id="sponsorDetails">Loading...</p>
                    </div>

                    <!-- Personal Information -->
                    <h5 class="mb-3"><i class="fas fa-user"></i> Personal Information</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">First Name *</label>
                            <input type="text" class="form-control" id="firstName" name="firstName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Last Name *</label>
                            <input type="text" class="form-control" id="lastName" name="lastName" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email Address *</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">WhatsApp Number *</label>
                            <input type="tel" class="form-control" id="whatsapp" name="whatsapp" placeholder="e.g., 0774901639" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Z2B SPONSOR ID (Optional)</label>
                        <input type="text" class="form-control" id="idNumber" name="idNumber" placeholder="Auto-filled from referral link or enter manually">
                        <small class="text-muted">Your sponsor's ID will auto-fill if you used a referral link. Leave empty if you don't have a sponsor.</small>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Password *</label>
                        <input type="password" class="form-control" id="password" name="password" required minlength="6">
                        <small class="text-muted">Minimum 6 characters</small>
                    </div>

                    <!-- Membership Tier Selection -->
                    <h5 class="mb-3"><i class="fas fa-crown"></i> Choose Your Membership Tier</h5>
                    <div class="mb-4">
                        <select class="form-select" id="tier" name="tier" required>
                            <option value="">Select a tier...</option>
                            <option value="FAM">FAM - Free Access Member (R0)</option>
                            <option value="BRONZE">BRONZE - R960/month (or R480 Beta Price)</option>
                            <option value="COPPER">COPPER - R1,980/month (or R990 Beta Price)</option>
                            <option value="SILVER">SILVER - R2,980/month (or R1,490 Beta Price)</option>
                            <option value="GOLD">GOLD - R4,980/month (or R2,490 Beta Price)</option>
                            <option value="PLATINUM">PLATINUM - R6,980/month (or R3,490 Beta Price)</option>
                            <option value="LIFETIME">LIFETIME - R12,000 One-Time (or R6,000 Beta Price)</option>
                        </select>
                    </div>

                    <!-- Payment Method Selection -->
                    <h5 class="mb-3"><i class="fas fa-credit-card"></i> Payment Method</h5>

                    <!-- Online Payment -->
                    <div class="payment-option" onclick="selectPayment('online')">
                        <label style="display: flex; align-items: center; margin: 0; cursor: pointer;">
                            <input type="radio" name="paymentMethod" value="online" id="paymentOnline">
                            <div>
                                <h6 class="mb-1"><i class="fas fa-globe"></i> Pay Online (Yoco/Payfast/Crypto)</h6>
                                <small class="text-muted">Instant activation - Pay with card, EFT, or cryptocurrency</small>
                            </div>
                        </label>
                    </div>

                    <!-- Bank EFT -->
                    <div class="payment-option" onclick="selectPayment('eft')">
                        <label style="display: flex; align-items: center; margin: 0; cursor: pointer;">
                            <input type="radio" name="paymentMethod" value="eft" id="paymentEft">
                            <div>
                                <h6 class="mb-1"><i class="fas fa-university"></i> Bank EFT Transfer</h6>
                                <small class="text-muted">Activate after payment verification</small>
                            </div>
                        </label>
                    </div>
                    <div class="payment-details" id="eftDetails">
                        <h6><i class="fas fa-info-circle"></i> Bank Transfer Details:</h6>
                        <p class="mb-1"><strong>Account Name:</strong> Zero2billionaires Amavulandlela</p>
                        <p class="mb-1"><strong>Account Number:</strong> 1318257727</p>
                        <p class="mb-1"><strong>Bank:</strong> NEDBANK</p>
                        <p class="mb-3"><strong>Reference:</strong> Your WhatsApp Number</p>
                        <div class="alert alert-warning mb-0">
                            <small><i class="fas fa-exclamation-triangle"></i> Please use your WhatsApp number as the payment reference so we can identify your payment.</small>
                        </div>
                    </div>

                    <!-- Crypto Payment -->
                    <div class="payment-option" onclick="selectPayment('crypto')">
                        <label style="display: flex; align-items: center; margin: 0; cursor: pointer;">
                            <input type="radio" name="paymentMethod" value="crypto" id="paymentCrypto">
                            <div>
                                <h6 class="mb-1"><i class="fab fa-bitcoin"></i> Cryptocurrency</h6>
                                <small class="text-muted">Pay with Bitcoin, Ethereum, USDT, and more</small>
                            </div>
                        </label>
                    </div>
                    <div class="payment-details" id="cryptoDetails">
                        <div class="alert alert-info mb-0">
                            <p class="mb-0"><i class="fas fa-info-circle"></i> You'll be redirected to our crypto payment gateway (CoinPayments) after registration. We accept 2000+ cryptocurrencies including BTC, ETH, USDT, and more.</p>
                        </div>
                    </div>

                    <!-- Direct Cash Deposit -->
                    <div class="payment-option" onclick="selectPayment('cash')">
                        <label style="display: flex; align-items: center; margin: 0; cursor: pointer;">
                            <input type="radio" name="paymentMethod" value="cash" id="paymentCash">
                            <div>
                                <h6 class="mb-1"><i class="fas fa-money-bill-wave"></i> Direct Cash Deposit</h6>
                                <small class="text-muted">FREE ACCESS until admin receives proof of payment</small>
                            </div>
                        </label>
                    </div>
                    <div class="payment-details" id="cashDetails">
                        <div class="alert-info-custom">
                            <h6><i class="fas fa-gift"></i> Special Offer!</h6>
                            <p class="mb-2">When you choose Direct Cash Deposit, you get <strong>IMMEDIATE FREE ACCESS</strong> to your selected tier until we receive and verify your proof of payment!</p>
                        </div>
                        <h6 class="mt-3"><i class="fas fa-info-circle"></i> Cash Deposit Details:</h6>
                        <p class="mb-1"><strong>Account Name:</strong> Zero2billionaires Amavulandlela</p>
                        <p class="mb-1"><strong>Account Number:</strong> 1318257727</p>
                        <p class="mb-1"><strong>Bank:</strong> NEDBANK</p>
                        <p class="mb-3"><strong>Reference:</strong> Your WhatsApp Number</p>
                        <div class="alert alert-success">
                            <h6 class="mb-2"><strong>Important Instructions:</strong></h6>
                            <ol class="mb-0" style="padding-left: 1.2rem;">
                                <li>Make your cash deposit at any NEDBANK branch</li>
                                <li>Use your WhatsApp number as the reference</li>
                                <li>Keep the deposit slip/receipt</li>
                                <li>Send proof of payment to our WhatsApp: <strong>077 490 1639</strong></li>
                                <li>Once verified, your tier will be upgraded from FREE to your selected tier</li>
                            </ol>
                        </div>
                    </div>

                    <!-- Hidden field for sponsor code -->
                    <input type="hidden" id="sponsorCode" name="sponsorCode">

                    <!-- Submit Button -->
                    <div class="mt-4">
                        <button type="submit" class="btn-register" id="submitBtn">
                            <i class="fas fa-rocket"></i> Complete Registration
                        </button>
                    </div>

                    <div class="text-center mt-3">
                        <small class="text-muted">Already have an account? <a href="dashboard.html">Login here</a></small>
                    </div>
                </form>
            </div>
        </div>

        <div class="text-center mt-3">
            <a href="index.html" class="text-white"><i class="fas fa-arrow-left"></i> Back to Home</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API Configuration
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:5000'
            : 'https://z2b-production-3cd3.up.railway.app';

        // Extract sponsor code from URL or localStorage
        function getSponsorCodeFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            let sponsorCode = urlParams.get('ref') || urlParams.get('sponsor') || urlParams.get('referral');

            // Fallback to localStorage if not in URL (persistent tracking)
            if (!sponsorCode) {
                sponsorCode = localStorage.getItem('z2b_sponsor_code');
                if (sponsorCode) {
                    console.log('âœ… Sponsor code retrieved from localStorage:', sponsorCode);
                }
            } else {
                // Update localStorage if URL has a sponsor code
                localStorage.setItem('z2b_sponsor_code', sponsorCode);
                localStorage.setItem('z2b_sponsor_timestamp', Date.now().toString());
                console.log('âœ… Sponsor code captured and stored:', sponsorCode);
            }

            return sponsorCode;
        }

        // Load sponsor information
        async function loadSponsorInfo() {
            const sponsorCode = getSponsorCodeFromURL();
            if (sponsorCode) {
                document.getElementById('sponsorCode').value = sponsorCode;

                // Auto-fill the Z2B SPONSOR ID field
                document.getElementById('idNumber').value = sponsorCode;
                document.getElementById('idNumber').style.backgroundColor = '#e8f5e9';
                document.getElementById('idNumber').style.borderColor = '#4CAF50';

                document.getElementById('sponsorInfo').style.display = 'block';
                document.getElementById('sponsorDetails').innerHTML = `<i class="fas fa-spinner fa-spin"></i> Loading sponsor information...`;

                try {
                    const response = await fetch(`${API_BASE_URL}/api/users/by-referral/${sponsorCode}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.data) {
                            const sponsor = data.data;
                            document.getElementById('sponsorDetails').innerHTML =
                                `<strong>${sponsor.firstName} ${sponsor.lastName}</strong> (${sponsor.referralCode})`;
                        } else {
                            document.getElementById('sponsorDetails').innerHTML =
                                `<span class="text-muted">Referral code: ${sponsorCode}</span>`;
                        }
                    } else {
                        document.getElementById('sponsorDetails').innerHTML =
                            `<span class="text-muted">Referral code: ${sponsorCode}</span>`;
                    }
                } catch (error) {
                    console.error('Error loading sponsor info:', error);
                    document.getElementById('sponsorDetails').innerHTML =
                        `<span class="text-muted">Referral code: ${sponsorCode}</span>`;
                }
            }
        }

        // Payment method selection
        function selectPayment(method) {
            // Remove active class from all options
            document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('active'));
            document.querySelectorAll('.payment-details').forEach(det => det.classList.remove('active'));

            // Activate selected option
            const radio = document.getElementById('payment' + method.charAt(0).toUpperCase() + method.slice(1));
            radio.checked = true;
            radio.closest('.payment-option').classList.add('active');

            // Show payment details
            const detailsId = method + 'Details';
            const detailsEl = document.getElementById(detailsId);
            if (detailsEl) {
                detailsEl.classList.add('active');
            }
        }

        // Form submission
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

            try {
                // Get introApp from URL parameter (if user came from standalone app purchase)
                const urlParams = new URLSearchParams(window.location.search);
                const introApp = urlParams.get('introApp'); // e.g., ?introApp=mydigitaltwin

                const formData = {
                    firstName: document.getElementById('firstName').value.trim(),
                    lastName: document.getElementById('lastName').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    phone: document.getElementById('whatsapp').value.trim(),
                    idNumber: document.getElementById('idNumber').value.trim(),
                    password: document.getElementById('password').value,
                    tier: document.getElementById('tier').value,
                    sponsorCode: document.getElementById('sponsorCode').value || null,
                    paymentMethod: document.querySelector('input[name="paymentMethod"]:checked')?.value,
                    introApp: introApp || null // NEW: Track which app introduced the user
                };

                // Validate tier selection first
                if (!formData.tier) {
                    alert('Please select a membership tier');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    return;
                }

                // For paid tiers, validate payment method
                if (formData.tier !== 'FAM' && !formData.paymentMethod) {
                    alert('Please select a payment method');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    // Show success message
                    alert(`ðŸŽ‰ Registration Successful!\n\nWelcome ${formData.firstName}!\n\nYour Member ID: ${result.data.referralCode}\n\nA welcome email with your login credentials and referral link has been sent to ${formData.email}`);

                    // Handle FAM tier (Free Access Member - no payment required)
                    if (formData.tier === 'FAM') {
                        alert('ðŸŽ‰ Welcome to your FREE 30-Day Coach Manlaw Trial!\n\nYou get 5 AI credits per week to experience Coach Manlaw.\n\nLogin to your dashboard to start your transformation journey!');
                        window.location.href = 'dashboard.html';
                    }
                    // Handle payment redirection for paid tiers
                    else if (formData.paymentMethod === 'cash') {
                        alert('You now have FREE ACCESS to your selected tier!\n\nPlease make your deposit and send proof of payment to WhatsApp: 077 490 1639');
                        window.location.href = 'dashboard.html';
                    } else if (formData.paymentMethod === 'online') {
                        // Redirect to payment gateway
                        if (result.data.paymentUrl) {
                            window.location.href = result.data.paymentUrl;
                        } else {
                            alert('Please contact support to complete your payment.');
                            window.location.href = 'dashboard.html';
                        }
                    } else if (formData.paymentMethod === 'eft') {
                        alert('Please make your EFT transfer using the banking details provided.\n\nUse your WhatsApp number as the reference.\n\nYour account will be activated once payment is verified.');
                        window.location.href = 'dashboard.html';
                    } else if (formData.paymentMethod === 'crypto') {
                        alert('You will be redirected to our cryptocurrency payment gateway.');
                        if (result.data.paymentUrl) {
                            window.location.href = result.data.paymentUrl;
                        } else {
                            window.location.href = 'dashboard.html';
                        }
                    }
                } else {
                    alert('Registration failed: ' + (result.message || 'Unknown error'));
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('Registration failed. Please try again or contact support.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadSponsorInfo();
        });
    </script>
    <!-- Footer -->
    <footer style="text-align: center; padding: 30px 20px; margin-top: 50px; background: rgba(255,255,255,0.05); border-top: 1px solid rgba(255,255,255,0.1);">
        <p style="margin: 0; color: rgba(255,255,255,0.7); font-size: 14px;">
            Built with <i class="fas fa-heart" style="color: #ff6b6b; animation: heartbeat 1.5s infinite;"></i> by <strong style="color: #FFD700;">Z2B Legacy Builders</strong>
        </p>
    </footer>
    <style>
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.1); }
            50% { transform: scale(1); }
        }
    </style>
</body>
</html>
