<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coach Manlaw - 7-Stage Employee to Entrepreneur Transformation | Z2B</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            /* Futuristic Royal Gold */
            --royal-gold: #FFD700;
            --royal-gold-light: #FFED4E;
            --royal-gold-dark: #D4AF37;
            --royal-gold-shine: #FFF9C4;
            --royal-gold-deep: #B8860B;
            --gold-glow: rgba(255, 215, 0, 0.6);

            /* Futuristic Royal Blue */
            --royal-blue: #0A1F44;
            --royal-blue-light: #1E3A8A;
            --royal-blue-bright: #2563EB;
            --royal-blue-neon: #60A5FA;
            --royal-blue-deep: #030B1F;
            --blue-glow: rgba(37, 99, 235, 0.5);

            /* Cyber Accents */
            --cyber-cyan: #00D9FF;
            --cyber-purple: #B45FFF;
            --neon-pink: #FF006E;
            --electric-blue: #0066FF;

            /* Base Colors */
            --white: #FFFFFF;
            --black: #000000;
            --success: #00FF88;
            --warning: #FFB800;

            /* Legacy aliases */
            --gold: var(--royal-gold);
            --light-gold: var(--royal-gold-light);
            --deep-navy: var(--royal-blue);
            --navy-blue: var(--royal-blue-light);
            --dark-navy: var(--royal-blue-deep);
            --orange: var(--royal-gold-dark);
            --border-color: var(--gold-glow);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background:
                radial-gradient(ellipse at top left, var(--royal-blue-bright) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, var(--royal-gold-dark) 0%, transparent 50%),
                linear-gradient(135deg, var(--royal-blue-deep) 0%, var(--royal-blue) 50%, var(--royal-blue-deep) 100%);
            color: var(--white);
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(255, 215, 0, 0.03) 2px,
                    rgba(255, 215, 0, 0.03) 4px
                );
            pointer-events: none;
            z-index: 1;
        }

        .coach-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            height: 100vh;
            position: relative;
            z-index: 10;
        }

        /* Sidebar */
        .sidebar {
            background: linear-gradient(180deg, rgba(10, 31, 68, 0.95) 0%, rgba(3, 11, 31, 0.98) 100%);
            padding: 2rem 1.5rem;
            border-right: 3px solid var(--royal-gold);
            box-shadow:
                inset -3px 0 15px var(--gold-glow),
                5px 0 30px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            position: relative;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 3px;
            height: 100%;
            background: linear-gradient(180deg, transparent, var(--royal-gold), transparent);
            animation: borderGlow 3s ease-in-out infinite;
        }

        @keyframes borderGlow {
            0%, 100% {
                opacity: 0.5;
            }
            50% {
                opacity: 1;
                filter: drop-shadow(0 0 10px var(--royal-gold));
            }
        }

        .back-btn {
            color: var(--gold);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
            transition: all 0.3s;
        }

        .back-btn:hover {
            color: var(--orange);
            transform: translateX(-5px);
        }

        .coach-avatar-lg {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--royal-gold) 0%, var(--royal-gold-light) 50%, var(--royal-gold-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem;
            margin: 0 auto 1.5rem;
            border: 4px solid var(--royal-gold);
            box-shadow:
                0 0 30px var(--gold-glow),
                0 0 60px rgba(255, 215, 0, 0.3),
                inset 0 0 20px rgba(255, 255, 255, 0.2);
            animation: pulseGlow 3s ease-in-out infinite;
            position: relative;
        }

        .coach-avatar-lg::before {
            content: '';
            position: absolute;
            inset: -10px;
            border-radius: 50%;
            background: conic-gradient(
                var(--royal-gold),
                var(--royal-blue-bright),
                var(--royal-gold)
            );
            opacity: 0.5;
            filter: blur(20px);
            animation: rotate 4s linear infinite;
            z-index: -1;
        }

        @keyframes pulseGlow {
            0%, 100% {
                transform: scale(1);
                box-shadow:
                    0 0 30px var(--gold-glow),
                    0 0 60px rgba(255, 215, 0, 0.3),
                    inset 0 0 20px rgba(255, 255, 255, 0.2);
            }
            50% {
                transform: scale(1.05);
                box-shadow:
                    0 0 50px var(--gold-glow),
                    0 0 80px rgba(255, 215, 0, 0.5),
                    inset 0 0 30px rgba(255, 255, 255, 0.3);
            }
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
            }
            50% {
                box-shadow: 0 0 40px rgba(255, 215, 0, 0.8);
            }
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .coach-name {
            text-align: center;
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--gold);
            margin-bottom: 0.5rem;
        }

        .coach-status {
            text-align: center;
            color: var(--white);
            opacity: 0.8;
            margin-bottom: 2rem;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00ff00;
            margin-right: 5px;
            animation: blink 2s ease-in-out infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        .btss-panel {
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.3) 0%, rgba(10, 31, 68, 0.5) 100%);
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 1.5rem;
            border: 2px solid rgba(255, 215, 0, 0.3);
            box-shadow:
                0 4px 20px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .btss-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .btss-panel h5 {
            color: var(--royal-gold);
            margin-bottom: 1rem;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px var(--gold-glow);
        }

        .leg-bar {
            margin-bottom: 1rem;
        }

        .leg-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: var(--royal-gold-light);
        }

        .bar-container {
            width: 100%;
            height: 10px;
            background: rgba(3, 11, 31, 0.8);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(255, 215, 0, 0.2);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg,
                var(--royal-blue-bright) 0%,
                var(--cyber-cyan) 50%,
                var(--royal-gold) 100%);
            border-radius: 10px;
            transition: width 1s ease;
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.6);
            position: relative;
            overflow: hidden;
        }

        .bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: barShine 2s infinite;
        }

        @keyframes barShine {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .stats-box {
            background: linear-gradient(135deg, var(--royal-gold) 0%, var(--royal-gold-light) 100%);
            padding: 1rem;
            border-radius: 15px;
            text-align: center;
            color: var(--royal-blue-deep);
            margin-bottom: 1rem;
            border: 2px solid var(--royal-gold-shine);
            box-shadow:
                0 8px 25px rgba(255, 215, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            position: relative;
            overflow: hidden;
        }

        .stats-box::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.3) 50%, transparent 70%);
            animation: statsShine 3s infinite;
        }

        @keyframes statsShine {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            position: relative;
            z-index: 1;
        }

        .stats-label {
            font-size: 0.85rem;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .sidebar-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .sidebar-btn {
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.5) 0%, rgba(10, 31, 68, 0.7) 100%);
            border: 2px solid var(--royal-gold);
            padding: 0.8rem;
            border-radius: 10px;
            color: var(--white);
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            position: relative;
            overflow: hidden;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .sidebar-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.3), transparent);
            transition: left 0.5s;
        }

        .sidebar-btn:hover::before {
            left: 100%;
        }

        .sidebar-btn:hover {
            background: linear-gradient(135deg, var(--royal-gold) 0%, var(--royal-gold-light) 100%);
            color: var(--royal-blue-deep);
            border-color: var(--royal-gold-shine);
            box-shadow:
                0 0 20px var(--gold-glow),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        /* Chat Area */
        .chat-area {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .chat-header {
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.8) 0%, rgba(10, 31, 68, 0.9) 100%);
            padding: 1.5rem 2rem;
            border-bottom: 3px solid var(--royal-gold);
            box-shadow:
                0 4px 20px rgba(0, 0, 0, 0.3),
                inset 0 -3px 15px var(--gold-glow);
            position: relative;
        }

        .chat-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg,
                transparent,
                var(--royal-gold),
                transparent);
            animation: headerScan 3s ease-in-out infinite;
        }

        @keyframes headerScan {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .chat-header h2 {
            color: var(--royal-gold);
            font-size: 1.8rem;
            margin-bottom: 0.3rem;
            text-shadow: 0 0 20px var(--gold-glow);
            letter-spacing: 1px;
        }

        .chat-header p {
            color: var(--white);
            opacity: 0.9;
            font-size: 0.95rem;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            background:
                linear-gradient(180deg, rgba(10, 31, 68, 0.3) 0%, rgba(3, 11, 31, 0.5) 100%);
        }

        .message {
            display: flex;
            margin-bottom: 1.5rem;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.coach {
            justify-content: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gold), var(--orange));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            margin-right: 0;
            margin-left: 1rem;
            order: 2;
            background: linear-gradient(135deg, var(--deep-navy), var(--navy-blue));
        }

        .message-content {
            max-width: 70%;
            background: rgba(255, 255, 255, 0.95);
            padding: 1.2rem 1.5rem;
            border-radius: 20px;
            color: var(--dark-navy);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .message-content strong {
            color: var(--dark-text);
            font-weight: 700;
        }

        .message-content em {
            color: var(--medium-text);
            font-style: italic;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, var(--gold), var(--orange));
            color: var(--navy-blue);
        }

        .message-text {
            line-height: 1.6;
            margin-bottom: 0.5rem;
            color: var(--medium-text);
        }

        .message-time {
            font-size: 0.75rem;
            opacity: 0.6;
            text-align: right;
            color: var(--dark-navy);
        }

        .typing-indicator {
            display: none;
            padding: 1rem 1.5rem;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            width: fit-content;
        }

        .typing-indicator.active {
            display: block;
        }

        .typing-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--navy-blue);
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            60%,
            100% {
                opacity: 0.3;
                transform: translateY(0);
            }

            30% {
                opacity: 1;
                transform: translateY(-10px);
            }
        }

        /* Input Area */
        .chat-input-area {
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.8) 0%, rgba(10, 31, 68, 0.9) 100%);
            padding: 1.5rem 2rem;
            border-top: 3px solid var(--royal-gold);
            box-shadow:
                0 -4px 20px rgba(0, 0, 0, 0.3),
                inset 0 3px 15px var(--gold-glow);
        }

        .quick-actions {
            display: flex;
            gap: 0.8rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.6) 0%, rgba(10, 31, 68, 0.8) 100%);
            border: 2px solid rgba(255, 215, 0, 0.4);
            padding: 0.6rem 1.2rem;
            border-radius: 50px;
            color: var(--white);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .quick-action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.3), transparent);
            transition: left 0.5s;
        }

        .quick-action-btn:hover::before {
            left: 100%;
        }

        .quick-action-btn:hover {
            background: linear-gradient(135deg, var(--royal-gold) 0%, var(--royal-gold-light) 100%);
            color: var(--royal-blue-deep);
            border-color: var(--royal-gold-shine);
            box-shadow: 0 0 15px var(--gold-glow);
        }

        .input-container {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            background: rgba(3, 11, 31, 0.8);
            border: 2px solid rgba(255, 215, 0, 0.4);
            border-radius: 50px;
            padding: 1rem 1.5rem;
            color: var(--white);
            font-size: 1rem;
            transition: all 0.3s;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .chat-input:focus {
            outline: none;
            background: rgba(3, 11, 31, 0.9);
            border-color: var(--royal-gold);
            box-shadow:
                inset 0 2px 10px rgba(0, 0, 0, 0.5),
                0 0 20px var(--gold-glow);
        }

        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .btn-send {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--royal-gold) 0%, var(--royal-gold-light) 100%);
            border: 2px solid var(--royal-gold-shine);
            color: var(--royal-blue-deep);
            font-size: 1.3rem;
            transition: all 0.3s;
            cursor: pointer;
            box-shadow:
                0 4px 15px var(--gold-glow),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            position: relative;
            overflow: hidden;
        }

        .btn-send::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.4) 50%, transparent 70%);
            animation: buttonShine 2s infinite;
        }

        @keyframes buttonShine {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn-send:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow:
                0 8px 30px var(--gold-glow),
                0 0 40px rgba(255, 215, 0, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.7);
        }

        .btn-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Assessment Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(3, 11, 31, 0.95);
            backdrop-filter: blur(10px);
            z-index: 2000;
            overflow-y: auto;
        }

        .modal-overlay.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-content {
            background: linear-gradient(135deg, var(--royal-blue) 0%, var(--royal-blue-deep) 100%);
            border-radius: 20px;
            padding: 2rem;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 3px solid var(--royal-gold);
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 0 40px var(--gold-glow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
            padding-bottom: 1rem;
        }

        .modal-header h3 {
            color: var(--royal-gold);
            font-size: 1.8rem;
            margin: 0;
            text-shadow: 0 0 20px var(--gold-glow);
            letter-spacing: 1px;
        }

        .btn-close {
            background: linear-gradient(135deg, var(--royal-gold) 0%, var(--royal-gold-light) 100%);
            border: 2px solid var(--royal-gold-shine);
            color: var(--royal-blue-deep);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
            box-shadow: 0 4px 15px var(--gold-glow);
        }

        .btn-close:hover {
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 8px 25px var(--gold-glow);
        }

        .assessment-form {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .assessment-item {
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.3) 0%, rgba(10, 31, 68, 0.5) 100%);
            padding: 1.5rem;
            border-radius: 15px;
            border: 2px solid rgba(255, 215, 0, 0.2);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .assessment-item h4 {
            color: var(--royal-gold);
            margin-bottom: 0.5rem;
            text-shadow: 0 0 10px var(--gold-glow);
        }

        .assessment-item p {
            color: var(--white);
            opacity: 0.9;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .slider {
            flex: 1;
            height: 10px;
            border-radius: 10px;
            background: rgba(3, 11, 31, 0.8);
            border: 1px solid rgba(255, 215, 0, 0.3);
            outline: none;
            appearance: none;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        .slider::-webkit-slider-track {
            height: 10px;
            border-radius: 10px;
            background: transparent;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--royal-gold) 0%, var(--royal-gold-light) 100%);
            border: 2px solid var(--royal-gold-shine);
            cursor: pointer;
            box-shadow:
                0 0 15px var(--gold-glow),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            transition: all 0.3s;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow:
                0 0 25px var(--gold-glow),
                inset 0 1px 0 rgba(255, 255, 255, 0.7);
        }

        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--royal-gold) 0%, var(--royal-gold-light) 100%);
            border: 2px solid var(--royal-gold-shine);
            cursor: pointer;
            box-shadow:
                0 0 15px var(--gold-glow),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
        }

        .slider-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--gold);
            min-width: 50px;
            text-align: center;
        }

        .btn-submit {
            width: 100%;
            padding: 1.2rem;
            background: linear-gradient(135deg, var(--gold), var(--orange));
            color: var(--navy-blue);
            border: none;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 1rem;
        }

        .btn-submit:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.5);
        }

        /* Scrollbar */
        .chat-messages::-webkit-scrollbar,
        .sidebar::-webkit-scrollbar,
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track,
        .sidebar::-webkit-scrollbar-track,
        .modal-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        .chat-messages::-webkit-scrollbar-thumb,
        .sidebar::-webkit-scrollbar-thumb,
        .modal-content::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--gold), var(--orange));
            border-radius: 10px;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .coach-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                display: none;
            }

            .message-content {
                max-width: 85%;
            }
        }
    </style>
</head>

<body>
    <!-- VERSION BANNER - Shows what code version is loaded -->
    <div id="versionBanner" style="position: fixed; top: 0; left: 0; right: 0; z-index: 99999; background: linear-gradient(135deg, #4CECC4, #155799); color: #0A1F44; padding: 0.8rem 1.5rem; text-align: center; font-weight: 700; box-shadow: 0 4px 15px rgba(0,0,0,0.4); display: flex; justify-content: space-between; align-items: center; font-size: 1.1rem;">
        <div>
            <i class="fas fa-code-branch"></i>
            <span id="versionText">VERSION 2.0 FINAL - Music & Lesson Audio FIXED ‚úÖ</span>
            <small style="margin-left: 1rem; opacity: 0.8; font-size: 0.85rem;">(2025-01-10)</small>
        </div>
        <button onclick="document.getElementById('versionBanner').style.display='none'" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: #0A1F44; padding: 0.4rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
            <i class="fas fa-times"></i> Close
        </button>
    </div>

    <div class="coach-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <a href="dashboard.html" class="back-btn">
                <i class="fas fa-arrow-left"></i> Dashboard
            </a>

            <div class="coach-avatar-lg">üéØ</div>
            <h3 class="coach-name">Coach Manlaw</h3>
            <p class="coach-status">
                <span class="status-indicator"></span>
                Online & Ready
            </p>

            <!-- Session Selector -->
            <div style="margin: 1rem 0; padding: 0.5rem; background: rgba(255, 215, 0, 0.1); border-radius: 10px; border: 2px solid var(--gold);">
                <div style="display: flex; gap: 0.5rem;">
                    <button class="session-btn morning-btn active" onclick="switchSession('morning')" style="flex: 1; padding: 0.8rem; background: linear-gradient(135deg, #FF6B35, #F7931E); border: none; border-radius: 8px; color: white; font-weight: 700; font-size: 0.85rem; cursor: pointer; transition: all 0.3s;">
                        <i class="fas fa-sun"></i> MORNING<br>
                        <span style="font-size: 0.7rem; font-weight: 500;">7-Stage Journey</span>
                    </button>
                    <button class="session-btn evening-btn" onclick="switchSession('evening')" style="flex: 1; padding: 0.8rem; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 8px; color: rgba(255, 255, 255, 0.7); font-weight: 700; font-size: 0.85rem; cursor: pointer; transition: all 0.3s;">
                        <i class="fas fa-moon"></i> EVENING<br>
                        <span style="font-size: 0.7rem; font-weight: 500;">Current Curriculum</span>
                    </button>
                </div>
                <div style="margin-top: 0.5rem; text-align: center; font-size: 0.7rem; color: var(--gold); font-style: italic;">
                    <span id="sessionHint">Morning: Build your foundation</span>
                </div>
            </div>

            <div class="btss-panel">
                <h5><i class="fas fa-chart-line"></i> Four Legs Progress</h5>
                <div class="leg-bar">
                    <div class="leg-label">
                        <span>üß† Mindset Mystery</span>
                        <span id="mindsetScore">--</span>
                    </div>
                    <div class="bar-container">
                        <div class="bar-fill" id="mindsetBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="leg-bar">
                    <div class="leg-label">
                        <span>üí∏ Money Moves</span>
                        <span id="moneyScore">--</span>
                    </div>
                    <div class="bar-container">
                        <div class="bar-fill" id="moneyBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="leg-bar">
                    <div class="leg-label">
                        <span>‚öôÔ∏è Legacy Missions</span>
                        <span id="legacyScore">--</span>
                    </div>
                    <div class="bar-container">
                        <div class="bar-fill" id="legacyBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="leg-bar">
                    <div class="leg-label">
                        <span>üåç Momentum Movement</span>
                        <span id="movementScore">--</span>
                    </div>
                    <div class="bar-container">
                        <div class="bar-fill" id="movementBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Current Stage Tracker -->
            <div class="btss-panel" style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 107, 53, 0.15)); border: 2px solid var(--gold);">
                <h5 style="margin-bottom: 0.8rem;"><i class="fas fa-rocket"></i> Your Transformation Stage</h5>
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 2rem; font-weight: 800; color: var(--gold); margin-bottom: 0.3rem;" id="stageNumber">Stage 1</div>
                    <div style="font-size: 1.1rem; font-weight: 600; color: var(--white); margin-bottom: 0.3rem;" id="stageName">Awakening</div>
                    <div style="font-size: 0.9rem; color: var(--gold); font-weight: 500; font-style: italic; margin-bottom: 0.5rem;" id="stageSubtitle"></div>
                    <div style="font-size: 0.85rem; color: var(--orange); font-weight: 500;" id="stageLeg">üß† Mindset Mystery</div>
                </div>
                <div style="font-size: 0.75rem; color: var(--white); opacity: 0.8; text-align: center; font-style: italic; line-height: 1.3;" id="stageQuote">
                    "I'm not building my dream. I'm helping someone else build theirs."
                </div>
            </div>

            <div class="stats-box">
                <div class="stats-number" id="statsDay">Day 1</div>
                <div class="stats-label">Your Journey</div>
            </div>

            <div class="stats-box" style="background: linear-gradient(135deg, var(--success), var(--purple));">
                <div class="stats-number" id="statsOverall">0%</div>
                <div class="stats-label">Overall BTSS</div>
            </div>

            <!-- Current Lesson Card -->
            <div class="btss-panel" id="lessonCard" style="background: linear-gradient(135deg, rgba(255, 107, 53, 0.15), rgba(212, 175, 55, 0.15)); border: 2px solid var(--gold);">
                <h5 style="margin-bottom: 0.8rem;"><i class="fas fa-book-open"></i> Today's Lesson</h5>
                <div style="margin-bottom: 1rem;">
                    <div style="font-size: 0.75rem; color: var(--orange); font-weight: 600; margin-bottom: 0.3rem;">
                        <span id="lessonWeekPhase">WEEK 1 ‚Ä¢ MINDSET MYSTERY</span>
                    </div>
                    <div style="font-size: 0.95rem; color: var(--gold); font-weight: 700; line-height: 1.3;" id="lessonTitle">
                        The Employee Trap: Why You're Stuck
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.8rem;">
                    <button class="sidebar-btn" style="flex: 1; padding: 0.5rem; font-size: 0.75rem;" onclick="viewLesson()">
                        <i class="fas fa-eye"></i> View
                    </button>
                    <button class="sidebar-btn" style="flex: 1; padding: 0.5rem; font-size: 0.75rem;" onclick="completeLesson()">
                        <i class="fas fa-check"></i> Complete
                    </button>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="sidebar-btn" style="flex: 1; padding: 0.5rem; font-size: 0.75rem;" onclick="previousDay()">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="sidebar-btn" style="flex: 1; padding: 0.5rem; font-size: 0.75rem;" onclick="nextDay()">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <div class="sidebar-buttons">
                <button class="sidebar-btn" onclick="openAssessment()">
                    <i class="fas fa-clipboard-check"></i> Take BTSS Assessment
                </button>
                <button class="sidebar-btn" onclick="showProgress()">
                    <i class="fas fa-chart-line"></i> View Progress
                </button>
                <button class="sidebar-btn" onclick="viewJournal()">
                    <i class="fas fa-book-open"></i> My Journal
                </button>
                <button class="sidebar-btn" onclick="showSettings()">
                    <i class="fas fa-cog"></i> AI Settings
                </button>
                <button class="sidebar-btn" onclick="openVoiceRecording()" style="background: linear-gradient(135deg, #FF4444, #CC0000); font-weight: 600;">
                    <i class="fas fa-microphone"></i> Record My Voice
                </button>
                <button class="sidebar-btn" onclick="showMusicPlayer()" style="background: linear-gradient(135deg, #00D9FF, #B45FFF); font-weight: 600;">
                    <i class="fas fa-headphones"></i> Music Player
                </button>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="chat-header">
                <h2><i class="fas fa-graduation-cap"></i> Coach Manlaw</h2>
                <p id="headerStatus">Transforming Employees into Entrepreneurs Through the 7-Stage Journey</p>
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- Welcome Message -->
                <div class="message coach">
                    <div class="message-avatar">üéØ</div>
                    <div class="message-content">
                        <div class="message-text">
                            <strong>Hey Employee, Ready to Break Free? üëã</strong><br><br>

                            I'm Coach Manlaw‚Äîand I see you. You're trading time for money, building someone else's dream, feeling the weight of the paycheck trap.
                            You know there's more, but the path from <strong>employee to entrepreneur</strong> feels unclear, risky, maybe even impossible.<br><br>

                            Let me be clear: <strong>This isn't just a career change. It's a complete identity shift.</strong><br>
                            It's about unlearning dependency and rediscovering self-agency. Moving from surviving on a paycheck to creating value, systems, and legacy.<br><br>

                            <strong>üåç THE 7-STAGE TRANSFORMATION JOURNEY: From Employee to Entrepreneur</strong><br><br>

                            I'll guide you through <strong>7 transformational stages</strong>, built on the <strong>4 Legs of Your Billion-Dollar Table</strong>.
                            Your success depends on your weakest leg‚Äîand we're strengthening ALL of them:<br><br>

                            <strong style="color: #FFD700; font-size: 1.1rem;">üß† MINDSET MYSTERY</strong> - <em>Awakening & Reprogramming Your Mind</em><br>
                            <strong>Stage 1: Awakening</strong> ‚Äì "I'm not building my dream. I'm helping someone else build theirs."<br>
                            ‚Üí Realize the trap. Recognize job security is an illusion. Hard work alone won't create freedom.<br>
                            ‚Üí Focus: <em>Awareness ‚Üí Financial self-realization</em><br><br>

                            <strong>Stage 2: Reprogramming</strong> ‚Äì "If I don't change my thinking, I'll repeat the same cycle."<br>
                            ‚Üí Unlearn employee habits (fear, dependency, trading time for money). Reprogram for growth, risk, leadership.<br>
                            ‚Üí Focus: <em>Unlearning ‚Üí Building a Money Mindset</em><br><br>

                            <strong style="color: #FFD700; font-size: 1.1rem;">üí∏ MONEY MOVES</strong> - <em>From Value Discovery to First Income</em><br>
                            <strong>Stage 3: Discovery</strong> ‚Äì "What do I have that can solve problems or create value?"<br>
                            ‚Üí Identify your purpose, passions, strengths. Find your profitable niche‚Äîyour true path as a value creator.<br>
                            ‚Üí Focus: <em>Self-awareness ‚Üí Profitable purpose</em><br><br>

                            <strong>Stage 4: Activation</strong> ‚Äì "Done is better than perfect. Action creates clarity."<br>
                            ‚Üí Test ideas through small offers or side hustles. Learn by doing. Overcome fear through execution.<br>
                            ‚Üí Focus: <em>Action ‚Üí First income stream</em><br><br>

                            <strong style="color: #FFD700; font-size: 1.1rem;">‚öôÔ∏è LEGACY MISSIONS</strong> - <em>Building Systems That Work For You</em><br>
                            <strong>Stage 5: Systemization</strong> ‚Äì "I don't want to work harder‚ÄîI want to build a system that works for me."<br>
                            ‚Üí Move from hustling to structuring. Build systems, automations, processes that create leverage and consistency.<br>
                            ‚Üí Focus: <em>Self-employment ‚Üí Business ownership</em><br><br>

                            <strong style="color: #FFD700; font-size: 1.1rem;">üåç MOMENTUM MOVEMENT</strong> - <em>From Solo Success to Generational Impact</em><br>
                            <strong>Stage 6: Expansion</strong> ‚Äì "I grow by helping others grow."<br>
                            ‚Üí Shift from working IN the business to working ON it. Build teams, collaborations, communities that multiply your impact.<br>
                            ‚Üí Focus: <em>Leadership ‚Üí Community growth</em><br><br>

                            <strong>Stage 7: Legacy</strong> ‚Äì "My purpose is to create systems that outlive me."<br>
                            ‚Üí Transcend personal success. Focus on generational impact, mentorship, contribution.<br>
                            ‚Üí Focus: <em>Purpose-driven leadership ‚Üí Legacy creation</em><br><br>

                            <strong>üìä YOUR BILLIONAIRE TABLE FRAMEWORK:</strong><br>
                            <strong>üß† Mindset Mystery</strong> - Transform identity & beliefs (Stages 1-2)<br>
                            <strong>üí∏ Money Moves</strong> - Build wealth systems that work while you sleep (Stages 3-4)<br>
                            <strong>‚öôÔ∏è Legacy Missions</strong> - Create scalable systems & automation (Stage 5)<br>
                            <strong>üåç Momentum Movement</strong> - Build influence & lead movements (Stages 6-7)<br><br>

                            <em>"As a man thinks, so is he"</em> (Proverbs 23:7). But thinking without action is just dreaming.
                            We're building <strong>systems, movements, and money machines</strong>.<br><br>

                            <em>"I am a Legacy Builder, You are a Legacy Builder, and Together we are Builders of Legacies."</em><br><br>

                            <strong>Your First Step:</strong> Take your BTSS (Billion-Dollar Table Stability Score) assessment.
                            I'll identify which stage you're in, which leg is weakest, and exactly where to focus your transformation.<br><br>

                            Or just ask me anything‚ÄîI'm here 24/7 to coach you through this journey. <strong>Let's transform you from employee to entrepreneur!</strong> üí™üî•
                        </div>
                        <div class="message-time" id="welcomeTime">Just now</div>
                        <div style="margin-top: 1rem;">
                            <button id="introAudioBtn" onclick="playIntroductionAudio()" class="sidebar-btn" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, var(--success), var(--purple)); font-weight: 600;">
                                <i class="fas fa-volume-up"></i> <span id="introAudioText">Listen to Introduction</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 90-Day Lesson Overview -->
                <div id="roadmapSection" class="message coach" style="margin-top: 2rem;">
                    <div class="message-avatar">üìö</div>
                    <div class="message-content">
                        <div class="message-text">
                            <strong style="font-size: 1.3rem; color: var(--gold);">üìñ YOUR 90-DAY TRANSFORMATION ROADMAP</strong><br><br>

                            <p style="opacity: 0.9; margin-bottom: 1.5rem;">
                                Below is your complete journey‚Äîall 90 lessons that will transform you from employee to entrepreneur.
                                <strong>Lessons are unlocked sequentially</strong> as you complete them. Stay disciplined, follow the path, and trust the process.
                            </p>

                            <div style="margin-bottom: 1rem;">
                                <button onclick="readAllLessons()" class="sidebar-btn" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, var(--gold), var(--orange)); font-weight: 600;">
                                    <i class="fas fa-headphones"></i> Luke Reads All 90 Lessons
                                </button>
                            </div>

                            <div id="lessonOverviewContainer">
                                <!-- Lesson overview will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="typing-indicator" id="typingIndicator">
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                </div>
            </div>

            <div class="chat-input-area">
                <div class="quick-actions" id="quickActions">
                    <button class="quick-action-btn" onclick="viewLesson()">
                        üìñ Today's Lesson
                    </button>
                    <button class="quick-action-btn" onclick="viewLesson()">
                        üéØ Today's Activity
                    </button>
                    <button class="quick-action-btn" onclick="openAssessment()">
                        üí° Take Assessment
                    </button>
                    <button class="quick-action-btn" onclick="showProgress()">
                        üìä My Progress
                    </button>
                    <button class="quick-action-btn" onclick="show90DayList()">
                        üìö 90-Day Content List
                    </button>
                </div>

                <div class="input-container">
                    <input type="text" class="chat-input" id="messageInput" placeholder="Ask Coach Manlaw anything..."
                        onkeypress="handleKeyPress(event)">
                    <button class="btn-send" id="sendBtn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Journal Modal -->
    <div class="modal-overlay" id="journalModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-book-open"></i> Your Transformation Journal</h3>
                <button class="btn-close" onclick="closeJournal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="assessment-item" style="background: linear-gradient(135deg, rgba(76, 236, 196, 0.15), rgba(155, 89, 182, 0.15)); border-left: 4px solid var(--success);">
                <p style="margin: 0; opacity: 0.9; line-height: 1.6;">
                    <strong>üìñ Your Complete Journey Record</strong><br>
                    All your activities, assignments, and personal reflections from your 90-day transformation. This is your legacy document.
                </p>
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button type="button" onclick="downloadJournal()" class="sidebar-btn" style="flex: 1; background: linear-gradient(135deg, var(--gold), var(--orange)); padding: 1rem; font-weight: 600;">
                        <i class="fas fa-download"></i> Download Journal
                    </button>
                    <button type="button" onclick="clearJournal()" class="sidebar-btn" style="flex: 1; background: linear-gradient(135deg, rgba(255,0,0,0.6), rgba(150,0,0,0.6)); padding: 1rem; font-weight: 600;">
                        <i class="fas fa-trash"></i> Clear Journal
                    </button>
                </div>
            </div>

            <div id="journalEntriesContainer" style="max-height: 60vh; overflow-y: auto;">
                <!-- Journal entries will be populated here -->
            </div>
        </div>
    </div>

    <!-- BTSS Assessment Modal -->
    <div class="modal-overlay" id="assessmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-clipboard-check"></i> BTSS Assessment</h3>
                <button class="btn-close" onclick="closeAssessment()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- BTSS Explanation Section -->
            <div style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(255, 107, 53, 0.15)); padding: 1.5rem; border-radius: 12px; border-left: 4px solid var(--gold); margin-bottom: 2rem;">
                <h4 style="color: var(--gold); margin: 0 0 1rem 0; font-size: 1.1rem;">
                    <i class="fas fa-info-circle"></i> What is BTSS?
                </h4>
                <p style="color: var(--white); opacity: 0.95; margin-bottom: 1rem; line-height: 1.6;">
                    <strong>BTSS = Billion-Dollar Table Stability Score</strong><br>
                    Your empire is a table. It stands on 4 legs. If one leg is weak, the whole table wobbles‚Äîno matter how strong the others are. BTSS measures the stability of your table by assessing all four legs.
                </p>

                <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="color: var(--gold); font-weight: 600; margin: 0 0 0.5rem 0; font-size: 0.95rem;">
                        <i class="fas fa-table"></i> The 4 Legs of Your Billion-Dollar Table:
                    </p>
                    <ul style="color: var(--white); opacity: 0.9; margin: 0; padding-left: 1.5rem; line-height: 1.8; font-size: 0.9rem;">
                        <li><strong>üß† Mindset Mystery:</strong> Your beliefs, vision, spiritual alignment, mental wealth</li>
                        <li><strong>üí∏ Money Moves:</strong> Financial intelligence, income streams, wealth multiplication</li>
                        <li><strong>‚öôÔ∏è Legacy Missions:</strong> Scalable systems, automation, purpose-driven business</li>
                        <li><strong>üåç Momentum Movement:</strong> Impact, influence, community building, leadership</li>
                    </ul>
                </div>

                <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px;">
                    <p style="color: var(--orange); font-weight: 600; margin: 0 0 0.5rem 0; font-size: 0.95rem;">
                        <i class="fas fa-chart-line"></i> How to Rate Yourself (0-100):
                    </p>
                    <table style="width: 100%; color: var(--white); font-size: 0.85rem; border-collapse: collapse;">
                        <tr style="background: rgba(255,255,255,0.05);">
                            <td style="padding: 0.5rem; border: 1px solid rgba(255,255,255,0.1); font-weight: 600;">0-20</td>
                            <td style="padding: 0.5rem; border: 1px solid rgba(255,255,255,0.1);">
                                <strong style="color: var(--danger);">Broken:</strong> No foundation. Starting from scratch. Need urgent attention.
                            </td>
                        </tr>
                        <tr>
                            <td style="padding: 0.5rem; border: 1px solid rgba(255,255,255,0.1); font-weight: 600;">21-40</td>
                            <td style="padding: 0.5rem; border: 1px solid rgba(255,255,255,0.1);">
                                <strong style="color: var(--orange);">Weak:</strong> Some awareness, but no systems. Struggling and inconsistent.
                            </td>
                        </tr>
                        <tr style="background: rgba(255,255,255,0.05);">
                            <td style="padding: 0.5rem; border: 1px solid rgba(255,255,255,0.1); font-weight: 600;">41-60</td>
                            <td style="padding: 0.5rem; border: 1px solid rgba(255,255,255,0.1);">
                                <strong style="color: var(--gold);">Developing:</strong> Basic foundation. Learning and growing, but not yet consistent.
                            </td>
                        </tr>
                        <tr>
                            <td style="padding: 0.5rem; border: 1px solid rgba(255,255,255,0.1); font-weight: 600;">61-80</td>
                            <td style="padding: 0.5rem; border: 1px solid rgba(255,255,255,0.1);">
                                <strong style="color: var(--success);">Strong:</strong> Solid systems. Consistent results. Growing steadily.
                            </td>
                        </tr>
                        <tr style="background: rgba(255,255,255,0.05);">
                            <td style="padding: 0.5rem; border: 1px solid rgba(255,255,255,0.1); font-weight: 600;">81-100</td>
                            <td style="padding: 0.5rem; border: 1px solid rgba(255,255,255,0.1);">
                                <strong style="color: var(--purple);">Elite:</strong> Mastery level. Systems run without you. Multiplying impact.
                            </td>
                        </tr>
                    </table>
                </div>

                <p style="color: var(--white); opacity: 0.85; margin: 1rem 0 0 0; font-size: 0.85rem; font-style: italic;">
                    <i class="fas fa-lightbulb"></i> <strong>Remember:</strong> Be brutally honest. Your weakest leg determines your table's stability‚Äîand your growth potential!
                </p>
            </div>

            <div class="assessment-form" id="assessmentForm">
                <div class="assessment-item">
                    <h4>üß† Mindset Mystery</h4>
                    <p style="margin-bottom: 0.5rem;">Your beliefs, vision, spiritual alignment, and mental wealth</p>
                    <details style="margin-bottom: 1rem;">
                        <summary style="cursor: pointer; color: var(--gold); font-size: 0.85rem; opacity: 0.8;">
                            <i class="fas fa-question-circle"></i> How to rate this?
                        </summary>
                        <div style="padding: 0.8rem; background: rgba(0,0,0,0.2); border-radius: 6px; margin-top: 0.5rem; font-size: 0.8rem; line-height: 1.6;">
                            <strong>0-20:</strong> Stuck in employee mindset. No vision. Doubt yourself constantly.<br>
                            <strong>21-40:</strong> Aware you want more, but fear holds you back. No clear vision yet.<br>
                            <strong>41-60:</strong> Starting to think like entrepreneur. Have vision, working on beliefs.<br>
                            <strong>61-80:</strong> Strong mindset. Clear vision. Faith-driven. Still growing.<br>
                            <strong>81-100:</strong> Unshakeable belief. Crystal-clear vision. Spiritual alignment. Unstoppable.
                        </div>
                    </details>
                    <div class="slider-container">
                        <input type="range" min="0" max="100" value="50" class="slider" id="mindsetSlider">
                        <span class="slider-value" id="mindsetValue">50</span>
                    </div>
                </div>

                <div class="assessment-item">
                    <h4>üí∏ Money Moves</h4>
                    <p style="margin-bottom: 0.5rem;">Financial intelligence, income streams, and wealth multiplication</p>
                    <details style="margin-bottom: 1rem;">
                        <summary style="cursor: pointer; color: var(--gold); font-size: 0.85rem; opacity: 0.8;">
                            <i class="fas fa-question-circle"></i> How to rate this?
                        </summary>
                        <div style="padding: 0.8rem; background: rgba(0,0,0,0.2); border-radius: 6px; margin-top: 0.5rem; font-size: 0.8rem; line-height: 1.6;">
                            <strong>0-20:</strong> One income stream (salary). Living paycheck to paycheck. No savings.<br>
                            <strong>21-40:</strong> Same income, but trying to save. No investment knowledge yet.<br>
                            <strong>41-60:</strong> Starting side income. Learning about money. Building assets slowly.<br>
                            <strong>61-80:</strong> Multiple income streams. Growing investments. Good financial IQ.<br>
                            <strong>81-100:</strong> Passive income exceeds expenses. Money multiplies itself. Financial freedom.
                        </div>
                    </details>
                    <div class="slider-container">
                        <input type="range" min="0" max="100" value="50" class="slider" id="moneySlider">
                        <span class="slider-value" id="moneyValue">50</span>
                    </div>
                </div>

                <div class="assessment-item">
                    <h4>‚öôÔ∏è Legacy Missions</h4>
                    <p style="margin-bottom: 0.5rem;">Scalable systems, automation, purpose-driven business, and management</p>
                    <details style="margin-bottom: 1rem;">
                        <summary style="cursor: pointer; color: var(--gold); font-size: 0.85rem; opacity: 0.8;">
                            <i class="fas fa-question-circle"></i> How to rate this?
                        </summary>
                        <div style="padding: 0.8rem; background: rgba(0,0,0,0.2); border-radius: 6px; margin-top: 0.5rem; font-size: 0.8rem; line-height: 1.6;">
                            <strong>0-20:</strong> No systems. Everything depends on you. Hustling daily.<br>
                            <strong>21-40:</strong> Aware you need systems, but haven't built any yet. Still trading time for money.<br>
                            <strong>41-60:</strong> Some basic systems. Trying to automate. Still doing most work yourself.<br>
                            <strong>61-80:</strong> Good systems in place. Team handles most tasks. Business runs without you (mostly).<br>
                            <strong>81-100:</strong> Fully automated. Business runs without you. Scalable and duplicatable systems.
                        </div>
                    </details>
                    <div class="slider-container">
                        <input type="range" min="0" max="100" value="50" class="slider" id="legacySlider">
                        <span class="slider-value" id="legacyValue">50</span>
                    </div>
                </div>

                <div class="assessment-item">
                    <h4>üåç Momentum Movement</h4>
                    <p style="margin-bottom: 0.5rem;">Impact, influence, community building, and leadership</p>
                    <details style="margin-bottom: 1rem;">
                        <summary style="cursor: pointer; color: var(--gold); font-size: 0.85rem; opacity: 0.8;">
                            <i class="fas fa-question-circle"></i> How to rate this?
                        </summary>
                        <div style="padding: 0.8rem; background: rgba(0,0,0,0.2); border-radius: 6px; margin-top: 0.5rem; font-size: 0.8rem; line-height: 1.6;">
                            <strong>0-20:</strong> No network. Working alone. No influence. Nobody follows your lead.<br>
                            <strong>21-40:</strong> Small circle. Trying to network. Minimal influence. Inconsistent leadership.<br>
                            <strong>41-60:</strong> Growing community. Some influence. People listen. Building leadership skills.<br>
                            <strong>61-80:</strong> Strong network. Clear influence. Leading teams. Creating impact beyond yourself.<br>
                            <strong>81-100:</strong> Movement builder. Massive influence. Leading leaders. Generational impact. Legacy in motion.
                        </div>
                    </details>
                    <div class="slider-container">
                        <input type="range" min="0" max="100" value="50" class="slider" id="movementSlider">
                        <span class="slider-value" id="movementValue">50</span>
                    </div>
                </div>

                <div class="btn-submit" id="submitAssessmentBtn" style="cursor: pointer; user-select: none;">
                    <i class="fas fa-check"></i> Submit Assessment
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-cog"></i> AI Settings</h3>
                <button class="btn-close" onclick="closeSettings()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="assessment-item">
                <h4>AI API Key</h4>
                <p>Enter your API key to enable AI coaching</p>
                <input type="password" id="claudeKey" placeholder="Enter API key..."
                    style="width: 100%; padding: 1rem; border-radius: 10px; border: 2px solid var(--gold); background: rgba(255,255,255,0.1); color: white;">
            </div>

            <div class="assessment-item">
                <h4>AI Model</h4>
                <select id="aiModel"
                    style="width: 100%; padding: 1rem; border-radius: 10px; border: 2px solid var(--gold); background: rgba(255,255,255,0.1); color: white;">
                    <option value="claude-sonnet-4-20250514">Advanced Model (Recommended)</option>
                    <option value="gpt-4">Alternative Model</option>
                </select>
            </div>

            <button type="button" class="btn-submit" onclick="saveSettings()">
                <i class="fas fa-save"></i> Save Settings
            </button>
        </div>
    </div>

    <!-- Activity Center Modal -->
    <div class="modal-overlay" id="activityModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3><i class="fas fa-tasks"></i> Activity Center</h3>
                <button class="btn-close" onclick="closeActivity()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <p style="color: var(--white); opacity: 0.9; margin-bottom: 2rem;">
                Complete daily activities, respond to assignments, and track your engagement with Coach Manlaw's curriculum.
            </p>

            <div class="assessment-item">
                <h4><i class="fas fa-fire"></i> Today's Activity</h4>
                <div style="background: rgba(255, 107, 53, 0.1); padding: 1.5rem; border-radius: 10px; border-left: 4px solid var(--royal-gold); margin-bottom: 1.5rem;">
                    <h5 style="color: var(--royal-gold); margin-bottom: 0.8rem;" id="activityTitle">Daily Reflection: Your Current Table Stability</h5>
                    <p style="color: var(--white); line-height: 1.8; margin-bottom: 1rem;" id="activityDescription">
                        Reflect on your Four Legs Table. Which leg is your weakest right now, and what specific action will you take this week to strengthen it?
                    </p>
                    <div style="display: flex; gap: 1rem; align-items: center; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,215,0,0.2);">
                        <div style="flex: 1;">
                            <small style="color: var(--royal-gold); display: block; margin-bottom: 0.3rem;">Estimated Time</small>
                            <span style="color: var(--white);" id="activityTime">5-10 minutes</span>
                        </div>
                        <div style="flex: 1;">
                            <small style="color: var(--royal-gold); display: block; margin-bottom: 0.3rem;">AI Fuel Cost</small>
                            <span style="color: var(--white);" id="activityFuel">2 fuel</span>
                        </div>
                        <div style="flex: 1;">
                            <small style="color: var(--royal-gold); display: block; margin-bottom: 0.3rem;">Status</small>
                            <span style="color: #00ff88; font-weight: 600;" id="activityStatus">Active</span>
                        </div>
                    </div>
                </div>

                <div id="activityResponseSection">
                    <label style="color: var(--royal-gold); font-weight: 600; margin-bottom: 0.5rem; display: block;">
                        <i class="fas fa-pencil-alt"></i> Your Response
                    </label>
                    <textarea id="activityResponseInput" placeholder="Type your thoughtful response here... Coach Manlaw will provide personalized feedback."
                        style="width: 100%; min-height: 150px; padding: 1rem; border: 2px solid var(--royal-gold); border-radius: 12px; background: rgba(0,0,0,0.3); color: white; font-family: inherit; font-size: 0.95rem; resize: vertical; margin-bottom: 1rem;"></textarea>

                    <button type="button" onclick="submitActivityResponse()" class="btn-submit" style="width: 100%; background: linear-gradient(135deg, var(--royal-gold), var(--royal-gold-light)); padding: 1rem; font-weight: 600;">
                        <i class="fas fa-paper-plane"></i> Submit to Coach Manlaw
                    </button>
                </div>
            </div>

            <div class="assessment-item" style="margin-top: 2rem;">
                <h4><i class="fas fa-history"></i> Recent Activities</h4>
                <div id="activityHistory">
                    <div style="background: rgba(30, 58, 138, 0.3); padding: 1rem; border-radius: 10px; margin-bottom: 0.8rem; border-left: 3px solid #00ff88;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <span style="color: var(--royal-gold); font-weight: 600;">Week 1, Day 1: Breaking the Employee Mindset</span>
                            <span style="color: #00ff88; font-size: 0.85rem;"><i class="fas fa-check-circle"></i> Completed</span>
                        </div>
                        <p style="color: var(--white); opacity: 0.8; font-size: 0.9rem; margin: 0;">Submitted 2 days ago</p>
                    </div>
                    <div style="background: rgba(30, 58, 138, 0.3); padding: 1rem; border-radius: 10px; margin-bottom: 0.8rem; border-left: 3px solid #00ff88;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <span style="color: var(--royal-gold); font-weight: 600;">Week 1, Day 2: Vision Alignment Exercise</span>
                            <span style="color: #00ff88; font-size: 0.85rem;"><i class="fas fa-check-circle"></i> Completed</span>
                        </div>
                        <p style="color: var(--white); opacity: 0.8; font-size: 0.9rem; margin: 0;">Submitted 1 day ago</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lesson Detail Modal -->
    <div class="modal-overlay" id="lessonModal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <div style="font-size: 0.85rem; color: var(--orange); margin-bottom: 0.3rem;" id="modalLessonWeek">WEEK 1 ‚Ä¢ DAY 1</div>
                    <h3 id="modalLessonTitle">The Employee Trap: Why You're Stuck</h3>
                </div>
                <button class="btn-close" onclick="closeLessonModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Current Stage Tracker (In Modal) -->
            <div class="assessment-item" style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 107, 53, 0.15)); border: 2px solid var(--gold);">
                <div style="text-align: center;">
                    <div style="font-size: 0.9rem; font-weight: 600; color: var(--orange); margin-bottom: 0.5rem;"><i class="fas fa-rocket"></i> YOUR TRANSFORMATION STAGE</div>
                    <div style="font-size: 1.5rem; font-weight: 800; color: var(--gold); margin-bottom: 0.2rem;" id="modalStageNumber">Stage 1</div>
                    <div style="font-size: 1rem; font-weight: 600; color: var(--white); margin-bottom: 0.2rem;" id="modalStageName">Awakening</div>
                    <div style="font-size: 0.85rem; color: var(--gold); font-weight: 500; font-style: italic; margin-bottom: 0.4rem;" id="modalStageSubtitle"></div>
                    <div style="font-size: 0.8rem; color: var(--orange); font-weight: 500;" id="modalStageLeg">üß† Mindset Mystery</div>
                </div>
            </div>

            <!-- Stage Overview with Details -->
            <div class="assessment-item" id="stageOverviewPanel" style="background: linear-gradient(135deg, rgba(76, 236, 196, 0.1), rgba(155, 89, 182, 0.1)); border-left: 4px solid var(--purple);">
                <h4 style="color: var(--gold); margin-bottom: 1rem;"><i class="fas fa-map-marked-alt"></i> Stage Overview</h4>
                <div id="stageOverviewContent">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <div class="assessment-item">
                <h4><i class="fas fa-book"></i> Lesson</h4>
                <p id="modalLessonContent" style="white-space: pre-line;">
                    Understanding the psychological chains of employment...
                </p>
            </div>

            <!-- Comprehension Check -->
            <div class="assessment-item" style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(255, 107, 53, 0.1)); border-left: 4px solid var(--gold);">
                <h4><i class="fas fa-brain"></i> Comprehension Check</h4>
                <p style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 1rem;">
                    Answer these 5 questions to ensure you've grasped today's lesson. Understanding comes before action.
                </p>
                <div id="comprehensionQuestions">
                    <!-- Questions will be populated by JavaScript -->
                </div>
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button type="button" onclick="checkComprehension()" class="sidebar-btn" style="flex: 1; background: linear-gradient(135deg, var(--gold), var(--orange)); padding: 1rem; font-weight: 600;">
                        <i class="fas fa-check-circle"></i> Check Answers
                    </button>
                    <button type="button" onclick="saveToJournal('comprehension')" class="sidebar-btn" style="flex: 1; background: linear-gradient(135deg, var(--purple), var(--success)); padding: 1rem; font-weight: 600;">
                        <i class="fas fa-save"></i> Save to Journal
                    </button>
                </div>
                <div id="comprehensionFeedback" style="display: none; margin-top: 1rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(76, 236, 196, 0.15), rgba(155, 89, 182, 0.15)); border-left: 4px solid var(--success); border-radius: 12px;">
                    <h5 style="margin: 0 0 0.8rem 0; color: var(--gold); font-size: 1rem;"><i class="fas fa-trophy"></i> Results</h5>
                    <p id="comprehensionFeedbackText" style="margin: 0; line-height: 1.6; color: rgba(255,255,255,0.9);"></p>
                </div>
            </div>

            <div class="assessment-item">
                <h4><i class="fas fa-play-circle"></i> Activity</h4>
                <p id="modalLessonActivity">
                    Write down 5 employee beliefs holding you back...
                </p>
                <div id="activityResponseSection" style="margin-top: 1rem;">
                    <textarea id="activityResponseInput" placeholder="üìù Type your activity response here... This will be saved to your journal." style="width: 100%; min-height: 150px; padding: 1rem; border: 2px solid var(--purple); border-radius: 12px; background: rgba(0,0,0,0.3); color: white; font-family: inherit; font-size: 0.95rem; resize: vertical;"></textarea>
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.8rem;">
                        <button type="button" onclick="saveToJournal('activity')" class="sidebar-btn" style="flex: 1; background: linear-gradient(135deg, var(--purple), var(--success)); padding: 1rem; font-weight: 600;">
                            <i class="fas fa-save"></i> Save to Journal
                        </button>
                        <button type="button" onclick="submitActivityResponse()" class="sidebar-btn" style="flex: 1; background: linear-gradient(135deg, var(--orange), var(--gold)); padding: 1rem; font-weight: 600;">
                            <i class="fas fa-paper-plane"></i> Submit to Coach
                        </button>
                    </div>
                    <div id="activityFeedback" style="display: none; margin-top: 1rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(76, 236, 196, 0.15), rgba(155, 89, 182, 0.15)); border-left: 4px solid var(--purple); border-radius: 12px;">
                        <h5 style="margin: 0 0 0.8rem 0; color: var(--gold); font-size: 1rem;"><i class="fas fa-comments"></i> Coach ManLaw Says:</h5>
                        <p id="activityFeedbackText" style="margin: 0; line-height: 1.6; color: rgba(255,255,255,0.9);"></p>
                    </div>
                </div>
            </div>

            <div class="assessment-item">
                <h4><i class="fas fa-clipboard-list"></i> Assignment</h4>
                <p id="modalLessonAssignment">
                    BTSS Assessment - Baseline measurement...
                </p>
                <div id="assignmentResponseSection" style="margin-top: 1rem;">
                    <textarea id="assignmentResponseInput" placeholder="üìù Type your assignment response here... This will be saved to your journal." style="width: 100%; min-height: 150px; padding: 1rem; border: 2px solid var(--orange); border-radius: 12px; background: rgba(0,0,0,0.3); color: white; font-family: inherit; font-size: 0.95rem; resize: vertical;"></textarea>
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.8rem;">
                        <button type="button" onclick="saveToJournal('assignment')" class="sidebar-btn" style="flex: 1; background: linear-gradient(135deg, var(--purple), var(--success)); padding: 1rem; font-weight: 600;">
                            <i class="fas fa-save"></i> Save to Journal
                        </button>
                        <button type="button" onclick="submitAssignmentResponse()" class="sidebar-btn" style="flex: 1; background: linear-gradient(135deg, var(--gold), var(--orange)); padding: 1rem; font-weight: 600;">
                            <i class="fas fa-paper-plane"></i> Submit to Coach
                        </button>
                    </div>
                    <div id="assignmentFeedback" style="display: none; margin-top: 1rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(255, 107, 53, 0.15), rgba(212, 175, 55, 0.15)); border-left: 4px solid var(--orange); border-radius: 12px;">
                        <h5 style="margin: 0 0 0.8rem 0; color: var(--gold); font-size: 1rem;"><i class="fas fa-comments"></i> Coach ManLaw Says:</h5>
                        <p id="assignmentFeedbackText" style="margin: 0; line-height: 1.6; color: rgba(255,255,255,0.9);"></p>
                    </div>
                </div>
            </div>

            <!-- Personal Notes / Journal Section -->
            <div class="assessment-item" style="background: linear-gradient(135deg, rgba(155, 89, 182, 0.15), rgba(76, 236, 196, 0.15)); border-left: 4px solid var(--success);">
                <h4><i class="fas fa-pen-fancy"></i> Personal Notes & Reflections</h4>
                <p style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 1rem;">
                    Capture your thoughts, insights, and reflections from today's lesson. All entries are automatically saved to your journal.
                </p>
                <textarea id="personalNotesInput" placeholder="‚úçÔ∏è Write your thoughts, breakthroughs, questions, or reflections here..." style="width: 100%; min-height: 150px; padding: 1rem; border: 2px solid var(--success); border-radius: 12px; background: rgba(0,0,0,0.3); color: white; font-family: inherit; font-size: 0.95rem; resize: vertical;"></textarea>
                <div style="display: flex; gap: 0.5rem; margin-top: 0.8rem;">
                    <button type="button" onclick="saveToJournal('notes')" class="sidebar-btn" style="flex: 1; background: linear-gradient(135deg, var(--success), var(--purple)); padding: 1rem; font-weight: 600;">
                        <i class="fas fa-save"></i> Save Notes to Journal
                    </button>
                    <button type="button" onclick="viewJournal()" class="sidebar-btn" style="flex: 1; background: linear-gradient(135deg, var(--gold), var(--orange)); padding: 1rem; font-weight: 600;">
                        <i class="fas fa-book-open"></i> View Full Journal
                    </button>
                </div>
            </div>

            <div class="assessment-item" id="modalAppConnection" style="display: none; background: linear-gradient(135deg, rgba(255, 107, 53, 0.1), rgba(212, 175, 55, 0.1));">
                <h4><i class="fas fa-link"></i> Recommended App</h4>
                <p><strong id="modalAppName">ZYRO</strong></p>
                <p id="modalAppHow" style="font-size: 0.9rem;">Use ZYRO's challenges to practice...</p>
            </div>

            <!-- Learning Mode Selector -->
            <div class="assessment-item" style="background: linear-gradient(135deg, rgba(76, 236, 196, 0.1), rgba(155, 89, 182, 0.1));">
                <h4><i class="fas fa-brain"></i> Learning Mode</h4>
                <p style="font-size: 0.85rem; margin-bottom: 1rem;">Choose how you want to experience this lesson:</p>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.8rem;">
                    <button type="button" class="sidebar-btn" id="modeRead" onclick="setLearningMode('read')" style="padding: 0.8rem; font-size: 0.85rem;">
                        <i class="fas fa-book"></i><br>Read
                    </button>
                    <button type="button" class="sidebar-btn" id="modeListen" onclick="setLearningMode('listen')" style="padding: 0.8rem; font-size: 0.85rem;">
                        <i class="fas fa-headphones"></i><br>Listen
                    </button>
                    <button type="button" class="sidebar-btn" id="modeWatch" onclick="setLearningMode('watch')" style="padding: 0.8rem; font-size: 0.85rem;">
                        <i class="fas fa-video"></i><br>Watch
                    </button>
                </div>
            </div>

            <!-- Audio Player (for Listen mode) -->
            <div class="assessment-item" id="audioPlayer" style="display: none; background: linear-gradient(135deg, rgba(76, 236, 196, 0.15), rgba(155, 89, 182, 0.15));">
                <h4><i class="fas fa-volume-up"></i> Audio Lesson - Listen Mode</h4>
                <p style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 1rem;">
                    <i class="fas fa-headphones"></i> Read along while listening! Audio will narrate the lesson below. Perfect for multitasking or reinforcing learning!
                </p>

                <!-- Voice Selection -->
                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid rgba(180, 95, 255, 0.3);">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.8rem;">
                        <i class="fas fa-microphone-alt" style="color: var(--cyber-purple); font-size: 1.2rem;"></i>
                        <strong style="color: var(--royal-gold);">Select Voice:</strong>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.8rem;">
                        <button id="voiceManlaw" onclick="selectVoice('manlaw')" style="padding: 0.8rem; background: linear-gradient(135deg, var(--cyber-purple), #9347E0); border: 2px solid var(--cyber-purple); border-radius: 10px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <i class="fas fa-magic"></i>
                            <span>Manlaw (ZYNTH)</span>
                        </button>
                        <button id="voiceLuke" onclick="selectVoice('luke')" style="padding: 0.8rem; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <i class="fas fa-male"></i>
                            <span>Luke (Male)</span>
                        </button>
                        <button id="voiceFemale" onclick="selectVoice('female')" style="padding: 0.8rem; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <i class="fas fa-female"></i>
                            <span>Ayanda (Female)</span>
                        </button>
                    </div>
                    <div id="voiceStatus" style="margin-top: 0.8rem; font-size: 0.85rem; color: var(--royal-gold-light); text-align: center;">
                        <i class="fas fa-info-circle"></i> <span id="voiceStatusText">Using ZYNTH cloned voice</span>
                    </div>
                </div>

                <div style="display: flex; align-items: center; gap: 1rem; margin-top: 1rem;">
                    <button type="button" id="playPauseBtn" onclick="toggleAudio()" style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, var(--success), var(--purple)); border: none; color: white; font-size: 1.2rem; cursor: pointer; box-shadow: 0 4px 15px rgba(76, 236, 196, 0.4); transition: all 0.3s;">
                        <i class="fas fa-play"></i>
                    </button>
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div style="font-size: 0.85rem; opacity: 0.8;" id="audioProgress">Ready to play</div>
                            <div style="font-size: 0.85rem; opacity: 0.8; font-weight: 600; color: var(--gold);" id="audioTime">0:00 / 0:00</div>
                        </div>
                        <div class="bar-container" onclick="seekAudio(event)" style="cursor: pointer; height: 8px; position: relative;" title="Click to seek">
                            <div class="bar-fill" id="audioProgressBar" style="width: 0%; background: linear-gradient(90deg, var(--success), var(--purple)); transition: width 0.1s linear; height: 100%; border-radius: 4px;"></div>
                            <div id="audioProgressHandle" style="position: absolute; top: 50%; right: 0; transform: translate(50%, -50%); width: 14px; height: 14px; background: white; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.3s;"></div>
                        </div>
                    </div>
                    <button type="button" onclick="stopAudio()" style="width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.1); border: none; color: white; cursor: pointer; transition: all 0.3s;" title="Stop playback">
                        <i class="fas fa-stop"></i>
                    </button>
                </div>

                <!-- Speed Control -->
                <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.85rem;"><i class="fas fa-tachometer-alt"></i> Playback Speed:</span>
                        <span id="speedDisplay" style="font-weight: 600; color: var(--gold);">1.0x</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem;">
                        <button onclick="setAudioSpeed(0.75)" style="padding: 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 0.75rem; cursor: pointer;">0.75x</button>
                        <button onclick="setAudioSpeed(0.9)" style="padding: 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 0.75rem; cursor: pointer;">0.9x</button>
                        <button onclick="setAudioSpeed(1.0)" style="padding: 0.5rem; background: linear-gradient(135deg, var(--gold), var(--orange)); border: none; border-radius: 6px; color: var(--navy-blue); font-size: 0.75rem; font-weight: 600; cursor: pointer;">1.0x</button>
                        <button onclick="setAudioSpeed(1.25)" style="padding: 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 0.75rem; cursor: pointer;">1.25x</button>
                        <button onclick="setAudioSpeed(1.5)" style="padding: 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; font-size: 0.75rem; cursor: pointer;">1.5x</button>
                    </div>
                </div>

                <p style="font-size: 0.8rem; opacity: 0.7; margin-top: 1rem;">
                    <i class="fas fa-lightbulb"></i> <strong>Pro Tip:</strong> Read along with the audio for better retention, or just listen while you work, drive, or exercise!
                </p>
            </div>

            <!-- Video/Animation View (for Watch mode) -->
            <div class="assessment-item" id="videoPlayer" style="display: none; background: rgba(0,0,0,0.3);">
                <!-- AI Video Lesson Option -->
                <div id="videoGenerateSection" style="background: linear-gradient(135deg, rgba(255, 107, 53, 0.2), rgba(212, 175, 55, 0.2)); padding: 1.5rem; border-radius: 10px; margin-bottom: 1rem;">
                    <h4 style="color: var(--gold); margin-bottom: 0.8rem;">
                        <i class="fas fa-video"></i> AI Video Lesson (VIDZIE)
                    </h4>
                    <p style="font-size: 0.9rem; margin-bottom: 1rem; opacity: 0.9;">
                        Generate a professional talking avatar video of this lesson with Coach Manlaw's voice! <br>
                        <span style="font-size: 0.85rem; color: var(--gold);">
                            <i class="fas fa-star"></i> Stage-aware video includes your transformation stage context
                        </span>
                    </p>
                    <button type="button" onclick="generateCoachingVideo()" id="btnGenerateCoachVideo" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, var(--gold), var(--orange)); border: none; border-radius: 10px; color: var(--navy-blue); font-weight: 700; cursor: pointer;">
                        <i class="fas fa-magic"></i> Generate Video Lesson
                    </button>
                    <div id="videoGenerationProgress" style="display: none; margin-top: 1rem;">
                        <div style="font-size: 0.9rem; margin-bottom: 0.5rem; text-align: center;">
                            <i class="fas fa-spinner fa-spin"></i> Generating your video lesson...
                        </div>
                        <div class="bar-container">
                            <div class="bar-fill" id="videoGenProgressBar" style="width: 0%; background: linear-gradient(90deg, var(--gold), var(--orange));"></div>
                        </div>
                        <p style="font-size: 0.85rem; opacity: 0.7; margin-top: 0.5rem; text-align: center;">
                            This usually takes 10-30 seconds...
                        </p>
                    </div>
                </div>

                <!-- Generated Video Player -->
                <div id="generatedVideoSection" style="display: none; margin-bottom: 1rem;">
                    <video id="coachingVideoPlayer" controls style="width: 100%; border-radius: 10px; background: black;">
                        <source id="videoSource" type="video/mp4">
                    </video>
                    <div style="display: flex; gap: 0.8rem; margin-top: 1rem;">
                        <button type="button" onclick="downloadCoachingVideo()" style="flex: 1; padding: 0.8rem; background: linear-gradient(135deg, var(--success), var(--purple)); border: none; border-radius: 10px; color: white; font-weight: 600; cursor: pointer;">
                            <i class="fas fa-download"></i> Download
                        </button>
                        <button type="button" onclick="shareCoachingVideo()" style="flex: 1; padding: 0.8rem; background: linear-gradient(135deg, var(--gold), var(--orange)); border: none; border-radius: 10px; color: var(--navy-blue); font-weight: 600; cursor: pointer;">
                            <i class="fas fa-share"></i> Share
                        </button>
                    </div>
                </div>

                <!-- Animated Slides (fallback) -->
                <div id="animatedLesson" style="min-height: 300px; padding: 2rem; text-align: center; position: relative; overflow: hidden;">
                    <!-- Animated content will be inserted here -->
                </div>
                <div style="display: flex; gap: 0.8rem; margin-top: 1rem;">
                    <button type="button" onclick="restartAnimation()" style="flex: 1; padding: 0.8rem; background: rgba(255,255,255,0.1); border: none; border-radius: 10px; color: white; cursor: pointer;">
                        <i class="fas fa-redo"></i> Restart Animation
                    </button>
                    <button type="button" onclick="pauseAnimation()" id="pauseAnimBtn" style="flex: 1; padding: 0.8rem; background: rgba(255,255,255,0.1); border: none; border-radius: 10px; color: white; cursor: pointer;">
                        <i class="fas fa-pause"></i> Pause
                    </button>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button type="button" class="btn-submit" style="flex: 1; background: rgba(255,255,255,0.1); color: white;" onclick="previousDay()">
                    <i class="fas fa-chevron-left"></i> Previous Day
                </button>
                <button type="button" class="btn-submit" style="flex: 1;" onclick="completeLesson()">
                    <i class="fas fa-check"></i> Mark Complete
                </button>
                <button type="button" class="btn-submit" style="flex: 1; background: rgba(255,255,255,0.1); color: white;" onclick="nextDay()">
                    Next Day <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Progress Dashboard Modal -->
    <div class="modal-overlay" id="progressModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3><i class="fas fa-chart-line"></i> 90-Day Progress Dashboard</h3>
                <button class="btn-close" onclick="closeProgress()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="assessment-item">
                <h4>Overall Journey</h4>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; color: var(--gold); font-weight: bold;" id="progressDay">1</div>
                        <div style="font-size: 0.85rem; opacity: 0.8;">Day of 90</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; color: var(--orange); font-weight: bold;" id="progressPercent">1%</div>
                        <div style="font-size: 0.85rem; opacity: 0.8;">Complete</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; color: var(--success); font-weight: bold;" id="progressCompleted">0</div>
                        <div style="font-size: 0.85rem; opacity: 0.8;">Lessons Done</div>
                    </div>
                </div>
            </div>

            <div class="assessment-item">
                <h4>Phase Progress</h4>
                <div style="margin-top: 1rem;">
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>üß† Phase 1: Mindset Mystery</span>
                            <span id="phase1Progress">0%</span>
                        </div>
                        <div class="bar-container">
                            <div class="bar-fill" id="phase1Bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>üí∏ Phase 2: Money Moves</span>
                            <span id="phase2Progress">0%</span>
                        </div>
                        <div class="bar-container">
                            <div class="bar-fill" id="phase2Bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>‚öôÔ∏è Phase 3: Legacy Missions</span>
                            <span id="phase3Progress">0%</span>
                        </div>
                        <div class="bar-container">
                            <div class="bar-fill" id="phase3Bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>üåç Phase 4: Momentum Movement</span>
                            <span id="phase4Progress">0%</span>
                        </div>
                        <div class="bar-container">
                            <div class="bar-fill" id="phase4Bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="assessment-item">
                <h4>BTSS Evolution</h4>
                <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">
                    Track how each leg has improved since Day 1
                </p>
                <div id="btssHistory" style="font-size: 0.85rem; opacity: 0.9;">
                    No assessment history yet. Take your first BTSS assessment to start tracking!
                </div>
            </div>

            <button type="button" class="btn-submit" onclick="closeProgress()">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    </div>

    <!-- Voice Recording Modal -->
    <div class="modal-overlay" id="voiceRecordingModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3><i class="fas fa-microphone"></i> Record Your Voice for Coach Manlaw</h3>
                <button class="btn-close" onclick="closeVoiceRecording()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Instructions -->
            <div class="assessment-item" style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 107, 53, 0.15)); border-left: 4px solid var(--gold);">
                <h4><i class="fas fa-info-circle"></i> How This Works</h4>
                <p style="font-size: 0.9rem; line-height: 1.6;">
                    Record yourself reading the <strong>30-minute script</strong> below. Speak naturally and clearly, as if you're coaching someone.
                    This recording will be used to clone your voice for all 90 lessons + introduction.
                </p>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 1rem;">
                    <div style="text-align: center; padding: 0.8rem; background: rgba(255,255,255,0.05); border-radius: 10px;">
                        <div style="font-size: 1.5rem; color: var(--gold);">üé§</div>
                        <div style="font-size: 0.85rem; margin-top: 0.5rem;">Clear voice</div>
                    </div>
                    <div style="text-align: center; padding: 0.8rem; background: rgba(255,255,255,0.05); border-radius: 10px;">
                        <div style="font-size: 1.5rem; color: var(--orange);">üîá</div>
                        <div style="font-size: 0.85rem; margin-top: 0.5rem;">Quiet room</div>
                    </div>
                    <div style="text-align: center; padding: 0.8rem; background: rgba(255,255,255,0.05); border-radius: 10px;">
                        <div style="font-size: 1.5rem; color: var(--success);">üí¨</div>
                        <div style="font-size: 0.85rem; margin-top: 0.5rem;">Natural tone</div>
                    </div>
                    <div style="text-align: center; padding: 0.8rem; background: rgba(255,255,255,0.05); border-radius: 10px;">
                        <div style="font-size: 1.5rem; color: var(--purple);">‚è±Ô∏è</div>
                        <div style="font-size: 0.85rem; margin-top: 0.5rem;">~30 minutes</div>
                    </div>
                </div>
            </div>

            <!-- Reading Script -->
            <div class="assessment-item" style="max-height: 400px; overflow-y: auto;">
                <h4><i class="fas fa-scroll"></i> 30-Minute Reading Script</h4>
                <div id="voiceScript" style="font-size: 0.95rem; line-height: 1.8; color: var(--white); opacity: 0.95; padding: 1.5rem; background: rgba(0,0,0,0.3); border-radius: 10px; white-space: pre-line;">
                    Loading script...
                </div>
            </div>

            <!-- Recording Interface -->
            <div class="assessment-item" style="background: linear-gradient(135deg, rgba(76, 236, 196, 0.1), rgba(155, 89, 182, 0.1)); border-left: 4px solid var(--purple);">
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div style="font-size: 0.85rem; color: var(--orange); font-weight: 600; margin-bottom: 0.5rem;">
                        30-MINUTE VOICE SAMPLE
                    </div>
                    <div style="font-size: 0.9rem; color: var(--white); opacity: 0.8;">
                        Read the script above naturally. Take breaks if needed.
                    </div>
                </div>

                <!-- Recording Controls -->
                <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 1rem;">
                    <button id="recordBtn" onclick="startRecording()" style="flex: 1; max-width: 200px; padding: 1.2rem; background: linear-gradient(135deg, #FF4444, #CC0000); border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; font-size: 1rem;">
                        <i class="fas fa-circle"></i> Record
                    </button>
                    <button id="stopBtn" onclick="stopRecording()" disabled style="flex: 1; max-width: 200px; padding: 1.2rem; background: linear-gradient(135deg, var(--gold), var(--orange)); border: none; border-radius: 10px; color: var(--navy-blue); font-weight: 700; cursor: pointer; font-size: 1rem; opacity: 0.5;">
                        <i class="fas fa-stop"></i> Stop
                    </button>
                </div>

                <!-- Recording Status -->
                <div id="recordingStatus" style="text-align: center; margin-bottom: 1rem; min-height: 30px;">
                    <div id="recordingTimer" style="display: none; font-size: 1.5rem; font-weight: 700; color: #FF4444;">
                        <i class="fas fa-circle" style="animation: pulse 1s infinite;"></i> 0:00
                    </div>
                </div>

                <!-- Audio Playback -->
                <div id="audioPlaybackSection" style="display: none;">
                    <div style="background: rgba(0,0,0,0.3); padding: 1.5rem; border-radius: 10px; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <button onclick="playRecording()" style="padding: 0.8rem 1.5rem; background: linear-gradient(135deg, var(--success), var(--purple)); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
                                <i class="fas fa-play"></i> Play
                            </button>
                            <div style="flex: 1; font-size: 0.9rem; opacity: 0.8;">
                                Listen to your recording
                            </div>
                        </div>
                        <audio id="audioPlayback" style="width: 100%; margin-bottom: 1rem;"></audio>
                    </div>

                    <!-- Accept or Re-record -->
                    <div style="display: flex; gap: 1rem;">
                        <button onclick="acceptRecording()" style="flex: 1; padding: 1.2rem; background: linear-gradient(135deg, var(--success), var(--purple)); border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer;">
                            <i class="fas fa-check"></i> Accept & Next
                        </button>
                        <button onclick="reRecord()" style="flex: 1; padding: 1.2rem; background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); border: 2px solid var(--orange); border-radius: 10px; color: var(--orange); font-weight: 700; cursor: pointer;">
                            <i class="fas fa-redo"></i> Re-record
                        </button>
                    </div>
                </div>
            </div>

            <!-- Recorded Samples List -->
            <div class="assessment-item">
                <h4><i class="fas fa-list"></i> Recorded Samples</h4>
                <div id="recordedSamplesList" style="max-height: 300px; overflow-y: auto;">
                    <div style="text-align: center; padding: 2rem; opacity: 0.5;">
                        No samples recorded yet. Start recording above!
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 1rem;">
                <button type="button" class="btn-submit" onclick="saveVoiceProfile()" id="saveVoiceBtn" disabled style="opacity: 0.5;">
                    <i class="fas fa-save"></i> Save Voice Profile
                </button>
                <button type="button" class="sidebar-btn" onclick="closeVoiceRecording()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // State
        const currentUserId = 'user_' + (localStorage.getItem('coach_user_id') || Date.now());
        localStorage.setItem('coach_user_id', currentUserId);

        let btssScores = JSON.parse(localStorage.getItem('coach_btss_scores')) || null;
        let btssHistory = JSON.parse(localStorage.getItem('coach_btss_history')) || [];
        let chatHistory = JSON.parse(localStorage.getItem('coach_chat_history')) || [];
        let startDate = localStorage.getItem('coach_start_date') || new Date().toISOString();
        let currentDay = parseInt(localStorage.getItem('coach_current_day')) || 1;
        let completedLessons = JSON.parse(localStorage.getItem('coach_completed_lessons')) || [];
        let curriculum = null;
        let learningMode = localStorage.getItem('coach_learning_mode') || 'read';

        // 7-Stage Transformation Journey (Morning Session Curriculum)
        const SEVEN_STAGE_CURRICULUM = {
            programName: "7-Stage Transformation Journey",
            totalDays: 90,
            description: "Build your foundation with the 7-Stage Transformation Journey",
            stages: [
                {
                    id: 1,
                    title: "Stage 1: Awareness",
                    subtitle: "Recognize your current reality and discover what's truly possible for your future",
                    days: "1-13",
                    dayRange: [1, 13],
                    description: "The first stage of transformation is waking up to where you truly are. Not where you wish you were, not where you pretend to be, but your actual starting point. Awareness is about honest self-assessment, recognizing patterns that have kept you stuck, and opening your eyes to possibilities you've been blind to. This stage strips away denial and builds the foundation for real change.",
                    keyLessons: [
                        "Honest self-inventory of your current financial, mental, and spiritual state",
                        "Identifying the employee mindset patterns that have limited you",
                        "Discovering your unique gifts and how they can create wealth",
                        "Understanding the gap between where you are and where you want to be",
                        "Developing radical self-awareness and personal accountability"
                    ],
                    dailyPractice: "Morning reflection: What patterns am I repeating? What opportunities am I missing? What truth am I avoiding?",
                    btssImpact: "mindset"
                },
                {
                    id: 2,
                    title: "Stage 2: Alignment",
                    subtitle: "Align your goals, values, and vision with your transformation path",
                    days: "14-26",
                    dayRange: [14, 26],
                    description: "Once you know where you are (Awareness), the next step is aligning everything in your life toward where you want to go. This means your daily actions, your relationships, your time, your money, your energy‚Äîall pointing in the same direction. Misalignment creates friction, frustration, and wasted effort. Alignment creates momentum, flow, and exponential progress.",
                    keyLessons: [
                        "Clarifying your core values and non-negotiables",
                        "Setting goals that align with your vision and values",
                        "Eliminating activities, relationships, and habits that pull you off course",
                        "Creating a vision board and strategic plan for your future",
                        "Aligning your spiritual purpose with your wealth-building mission"
                    ],
                    dailyPractice: "Morning check-in: Does today's schedule align with my vision? What needs to change?",
                    btssImpact: "mindset"
                },
                {
                    id: 3,
                    title: "Stage 3: Action",
                    subtitle: "Take consistent daily steps that move you toward your entrepreneurial goals",
                    days: "27-39",
                    dayRange: [27, 39],
                    description: "Awareness without action is just philosophy. Alignment without action is just dreaming. This stage is about translating your vision into tangible steps, building momentum through daily discipline, and proving to yourself that you can do what you said you'd do. Action creates evidence. Evidence builds belief. Belief fuels more action. The cycle begins here.",
                    keyLessons: [
                        "Breaking big goals into daily micro-actions",
                        "Building the discipline of daily execution",
                        "Overcoming analysis paralysis and perfectionism",
                        "Creating accountability systems that keep you moving",
                        "Developing the money-making habits of billionaires"
                    ],
                    dailyPractice: "Morning commitment: What is the ONE action today that will move me forward?",
                    btssImpact: "money"
                },
                {
                    id: 4,
                    title: "Stage 4: Adjustment",
                    subtitle: "Adapt your strategies based on real feedback and lessons learned along the way",
                    days: "40-52",
                    dayRange: [40, 52],
                    description: "No plan survives first contact with reality. This stage teaches you to embrace feedback, learn from failures, and course-correct quickly. Adjustment isn't about quitting‚Äîit's about refining. It's the difference between stubbornly running into a wall and intelligently finding a door. Billionaires pivot fast. Employees resist change. This stage turns you into a master adapter.",
                    keyLessons: [
                        "Treating failure as feedback, not finality",
                        "Reading market signals and adjusting your approach",
                        "Developing flexibility without losing your core vision",
                        "Learning from mistakes without attaching shame",
                        "Using data and results to guide your next moves"
                    ],
                    dailyPractice: "Morning review: What worked yesterday? What didn't? What will I do differently today?",
                    btssImpact: "money"
                },
                {
                    id: 5,
                    title: "Stage 5: Acceleration",
                    subtitle: "Scale your efforts and multiply your results exponentially through proven systems",
                    days: "53-65",
                    dayRange: [53, 65],
                    description: "By this stage, you've built momentum, learned what works, and eliminated what doesn't. Now it's time to scale. Acceleration is about leverage‚Äîdoing more with less, reaching more people, earning more income with the same effort. It's about systemizing, automating, and multiplying yourself through teams, technology, and strategy. This is where you go from linear to exponential growth.",
                    keyLessons: [
                        "Building systems that work without you",
                        "Leveraging technology and automation",
                        "Creating passive income streams",
                        "Recruiting and leading a team that multiplies your impact",
                        "Applying the 80/20 principle to maximize results"
                    ],
                    dailyPractice: "Morning strategy: How can I 10x this result? What leverage can I create today?",
                    btssImpact: "legacy"
                },
                {
                    id: 6,
                    title: "Stage 6: Ascension",
                    subtitle: "Reach new levels of success, influence, and financial freedom beyond your dreams",
                    days: "66-78",
                    dayRange: [66, 78],
                    description: "Ascension is the breakthrough stage where you transcend previous limitations and step into a new level of wealth, influence, and impact. You're no longer grinding‚Äîyou're gliding. Money flows to you because of who you've become, not just what you do. Your reputation precedes you. Opportunities seek you. This is the reward for the previous 5 stages of work.",
                    keyLessons: [
                        "Operating from abundance instead of scarcity",
                        "Building wealth that lasts beyond your lifetime",
                        "Expanding your influence and impact radius",
                        "Creating multiple streams of income",
                        "Living in financial freedom and peace"
                    ],
                    dailyPractice: "Morning gratitude: What new level have I reached? How can I expand from here?",
                    btssImpact: "legacy"
                },
                {
                    id: 7,
                    title: "Stage 7: Activation",
                    subtitle: "Become a leader who activates and inspires transformation in others",
                    days: "79-90",
                    dayRange: [79, 90],
                    description: "The final stage is about legacy. You've been transformed‚Äînow you transform others. Activation means you become a coach, mentor, and leader who pulls others up the same journey you just completed. This is where your wealth becomes a tool for generational change, where your story becomes a testimony that inspires thousands. You're no longer just building wealth‚Äîyou're building builders.",
                    keyLessons: [
                        "Teaching what you've learned to multiply your impact",
                        "Building a legacy that outlives you",
                        "Creating systems that empower others to succeed",
                        "Leading with generosity, wisdom, and influence",
                        "Activating the next generation of Legacy Builders"
                    ],
                    dailyPractice: "Morning mission: Who can I activate today? What wisdom can I share?",
                    btssImpact: "momentum"
                }
            ]
        };

        // Audio/Video state
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;
        let isAudioPlaying = false;
        let animationInterval = null;
        let animationPaused = false;

        // Audio timing and progress
        let audioStartTime = 0;
        let audioTotalChars = 0;
        let audioCurrentChar = 0;
        let audioEstimatedDuration = 0;
        let audioProgressInterval = null;

        // User tier management
        let userTier = 'FAM'; // Default to FAM
        function getUserTier() {
            const user = JSON.parse(localStorage.getItem('z2b_current_user') || '{}');
            // Map tier codes to names
            const tierMap = {
                'FREE': 'FAM',
                'STARTER': 'Bronze',
                'PRO': 'Copper',
                'ELITE': 'Silver', // Silver, Gold, Platinum all use ELITE
                'LIFETIME': 'Platinum'
            };
            return tierMap[user.tier] || 'FAM';
        }
        userTier = getUserTier();

        // Session management (morning/evening)
        let currentSession = localStorage.getItem('coach_current_session') || 'morning';

        function switchSession(session) {
            currentSession = session;
            localStorage.setItem('coach_current_session', session);

            // Update button active states
            const morningBtn = document.querySelector('.morning-btn');
            const eveningBtn = document.querySelector('.evening-btn');
            const sessionHint = document.getElementById('sessionHint');

            if (session === 'morning') {
                // Activate morning button
                morningBtn.style.background = 'linear-gradient(135deg, #FF6B35, #F7931E)';
                morningBtn.style.border = 'none';
                morningBtn.style.color = 'white';

                // Deactivate evening button
                eveningBtn.style.background = 'rgba(255, 255, 255, 0.1)';
                eveningBtn.style.border = '2px solid rgba(255, 215, 0, 0.3)';
                eveningBtn.style.color = 'rgba(255, 255, 255, 0.7)';

                // Update hint text
                sessionHint.textContent = 'Morning: Build your foundation with the 7-Stage Transformation Journey';

                console.log('üåÖ Switched to MORNING session - 7-Stage Journey');
            } else {
                // Activate evening button
                eveningBtn.style.background = 'linear-gradient(135deg, #1A237E, #4A148C)';
                eveningBtn.style.border = 'none';
                eveningBtn.style.color = 'white';

                // Deactivate morning button
                morningBtn.style.background = 'rgba(255, 255, 255, 0.1)';
                morningBtn.style.border = '2px solid rgba(255, 215, 0, 0.3)';
                morningBtn.style.color = 'rgba(255, 255, 255, 0.7)';

                // Update hint text
                sessionHint.textContent = 'Evening: Continue your 90-day transformation curriculum';

                console.log('üåô Switched to EVENING session - Current Curriculum');
            }

            // Reload curriculum display to show appropriate content
            updateCurrentLesson();
        }

        // Tier access functions
        function canAccessLesson(day) {
            if (userTier === 'FAM') {
                return day <= 7; // FAM only gets first 7 lessons
            }
            return true; // All other tiers get all lessons
        }

        function canAccessAudio() {
            // Audio available for Copper and above (Copper,Silver,Gold,Platinum)
            return ['Copper', 'Silver', 'Gold', 'Platinum'].includes(userTier);
        }

        function canAccessVideo() {
            // Video available for Silver and above
            return ['Silver', 'Gold', 'Platinum'].includes(userTier);
        }

        function showUpgradeNudge(feature, requiredTier) {
            const tierPrices = {
                'Bronze': 'R480/month',
                'Copper': 'R980/month',
                'Silver': 'R1,480/month'
            };

            const message = `
                üîí <strong>${feature} Locked</strong><br><br>
                Upgrade to <strong>${requiredTier}</strong> (${tierPrices[requiredTier] || ''}) or higher to unlock ${feature}!<br><br>
                <strong>Benefits of ${requiredTier}:</strong><br>
                ${requiredTier === 'Bronze' ? '‚Ä¢ Access to Coach Manlaw text lessons<br>‚Ä¢ 100 AI Fuel<br>‚Ä¢ 25% ISP Commission<br>‚Ä¢ 3 Generation TSC' : ''}
                ${requiredTier === 'Copper' ? '‚Ä¢ Audio learning mode<br>‚Ä¢ 200 AI Fuel<br>‚Ä¢ 28% ISP Commission<br>‚Ä¢ 5 Generation TSC' : ''}
                ${requiredTier === 'Silver' ? '‚Ä¢ Video learning mode<br>‚Ä¢ All 4 AI Apps<br>‚Ä¢ 30% ISP Commission<br>‚Ä¢ 7 Generation TSC<br>‚Ä¢ TLI Access' : ''}
            `;

            if (confirm('You need to upgrade to access this feature. Go to Tiers page?')) {
                window.location.href = 'tiers.html';
            }

            addCoachMessage(message);
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            localStorage.setItem('coach_start_date', startDate);
            loadCurriculum();
            loadBTSSScores();
            updateJourneyDay();
            updateCurrentLesson();
            setupSliderListeners();
            loadSettings();
            document.getElementById('welcomeTime').textContent = getCurrentTime();

            // Initialize session buttons with saved preference
            setTimeout(() => {
                switchSession(currentSession);
            }, 100);
        });

        // Load curriculum from MANLAW_CURRICULUM
        function loadCurriculum() {
            console.log('üîÑ Attempting to load curriculum...');
            console.log('üîç MANLAW_CURRICULUM exists:', typeof MANLAW_CURRICULUM !== 'undefined');
            if (typeof MANLAW_CURRICULUM !== 'undefined') {
                curriculum = MANLAW_CURRICULUM;
                console.log('‚úÖ Curriculum loaded successfully!');
                console.log('‚úÖ Program name:', curriculum.programName);
                console.log('‚úÖ Phase 1 weeks:', curriculum.phase1_mindset?.weeks?.length);
            } else {
                console.error('‚ùå MANLAW_CURRICULUM not found in window scope!');
                console.error('‚ùå Please check if coach-manlaw-curriculum.js loaded correctly');
                alert('‚ö†Ô∏è Curriculum failed to load. Please refresh the page.');
            }
        }

        // Get lesson by day number
        function getLessonByDay(day) {
            // MORNING SESSION: 7-Stage Transformation Journey
            if (currentSession === 'morning') {
                // Find which stage this day belongs to
                for (const stage of SEVEN_STAGE_CURRICULUM.stages) {
                    if (day >= stage.dayRange[0] && day <= stage.dayRange[1]) {
                        return {
                            day: day,
                            title: stage.title,
                            content: `${stage.description}\n\n<strong>Key Lessons:</strong>\n${stage.keyLessons.map((lesson, i) => `${i + 1}. ${lesson}`).join('\n')}\n\n<strong>Daily Practice:</strong>\n${stage.dailyPractice}`,
                            activity: stage.dailyPractice,
                            assignment: `Reflect on: ${stage.subtitle}`,
                            btssImpact: stage.btssImpact,
                            week: Math.ceil(day / 7),
                            theme: stage.title,
                            phaseTitle: "7-Stage Transformation Journey",
                            stageInfo: stage
                        };
                    }
                }
                return null;
            }

            // EVENING SESSION: 90-Day Current Curriculum
            if (!curriculum) return null;

            // Search through all phases
            const phases = [
                curriculum.phase1_mindset,
                curriculum.phase2_money,
                curriculum.phase3_legacy,
                curriculum.phase4_momentum,
                curriculum.finalPhase_integration
            ];

            for (const phase of phases) {
                for (const week of phase.weeks) {
                    for (const lesson of week.lessons) {
                        if (lesson.day === day) {
                            return {
                                ...lesson,
                                week: week.week,
                                theme: week.theme,
                                phaseTitle: phase.title
                            };
                        }
                    }
                }
            }

            return null;
        }

        // Get all lessons (1-90)
        function getAllLessons() {
            // MORNING SESSION: Return 7-Stage lessons
            if (currentSession === 'morning') {
                const allLessons = [];
                for (let day = 1; day <= 90; day++) {
                    const lesson = getLessonByDay(day);
                    if (lesson) {
                        allLessons.push(lesson);
                    }
                }
                return allLessons;
            }

            // EVENING SESSION: Return 90-day curriculum lessons
            if (!curriculum) return [];

            const allLessons = [];
            const phases = [
                curriculum.phase1_mindset,
                curriculum.phase2_money,
                curriculum.phase3_legacy,
                curriculum.phase4_momentum,
                curriculum.finalPhase_integration
            ];

            for (const phase of phases) {
                for (const week of phase.weeks) {
                    for (const lesson of week.lessons) {
                        allLessons.push({
                            ...lesson,
                            week: week.week,
                            theme: week.theme,
                            phaseTitle: phase.title
                        });
                    }
                }
            }

            // Sort by day to ensure correct order
            return allLessons.sort((a, b) => a.day - b.day);
        }

        // Check if a lesson is unlocked
        function isLessonUnlocked(day) {
            // Day 1 is always unlocked
            if (day === 1) return true;

            // A lesson is unlocked if the previous lesson is completed
            return completedLessons.includes(day - 1);
        }

        // Navigate to a specific lesson
        function goToLesson(day) {
            if (!isLessonUnlocked(day)) {
                addCoachMessage(`üîí This lesson is locked! Complete Day ${day - 1} first to unlock it. Stay disciplined‚Äîthe sequence matters for your transformation!`);
                return;
            }

            currentDay = day;
            updateJourneyDay();
            updateCurrentLesson();
            viewLesson();
        }

        // Render the 90-day lesson overview
        function renderLessonOverview() {
            const allLessons = getAllLessons();
            const container = document.getElementById('lessonOverviewContainer');

            console.log('üìö renderLessonOverview called');
            console.log('Container exists:', !!container);
            console.log('All lessons count:', allLessons.length);

            if (!container) {
                console.error('‚ùå lessonOverviewContainer not found in DOM!');
                return;
            }

            if (allLessons.length === 0) {
                console.error('‚ùå No lessons found! Curriculum may not be loaded.');
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; background: rgba(255,107,53,0.1); border-radius: 10px; border: 2px dashed var(--orange);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--orange); margin-bottom: 1rem;"></i>
                        <p style="color: var(--white); opacity: 0.9;">
                            <strong>Curriculum Not Loaded Yet</strong><br>
                            Please refresh the page or wait a moment for the curriculum to load.
                        </p>
                    </div>
                `;
                return;
            }

            let html = '';
            let currentStage = 0;
            let currentPhase = '';

            allLessons.forEach((lesson) => {
                const stageInfo = getCurrentStage(lesson.day);
                const isUnlocked = isLessonUnlocked(lesson.day);
                const isCompleted = completedLessons.includes(lesson.day);
                const isCurrent = lesson.day === currentDay;

                // Add stage header when stage changes
                if (stageInfo.stage !== currentStage) {
                    currentStage = stageInfo.stage;
                    html += `
                        <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 107, 53, 0.15));
                                    padding: 1rem; border-radius: 10px; border-left: 4px solid var(--gold);
                                    margin: 1.5rem 0 1rem 0;">
                            <div style="font-size: 1.1rem; font-weight: 700; color: #D4AF37; margin-bottom: 0.3rem;">
                                Stage ${stageInfo.stage}: ${stageInfo.name}${stageInfo.subtitle ? ' - ' + stageInfo.subtitle : ''}
                            </div>
                            <div style="font-size: 0.85rem; color: #FF6B35; font-weight: 600;">${stageInfo.leg}</div>
                            <div style="font-size: 0.8rem; color: #030B1F; opacity: 0.75; font-style: italic; margin-top: 0.3rem;">
                                ${stageInfo.quote}
                            </div>
                        </div>
                    `;
                }

                // Add phase header when phase changes
                if (lesson.phaseTitle !== currentPhase) {
                    currentPhase = lesson.phaseTitle;
                    html += `
                        <div style="font-size: 0.95rem; font-weight: 700; color: #FF6B35;
                                    margin: 1rem 0 0.5rem 0; padding: 0.5rem 0.5rem 0.5rem 0.8rem;
                                    background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 107, 53, 0.1));
                                    border-left: 3px solid #FF6B35; border-radius: 5px;">
                            ${lesson.phaseTitle}
                        </div>
                    `;
                }

                // Lesson item
                const lockIcon = isCompleted ? '‚úÖ' : (isUnlocked ? 'üîì' : 'üîí');
                const opacity = isUnlocked ? '1' : '0.6';
                const cursor = isUnlocked ? 'pointer' : 'not-allowed';
                const hoverStyle = isUnlocked ? 'this.style.background="linear-gradient(135deg, rgba(255, 215, 0, 0.25), rgba(255, 107, 53, 0.25))"' : '';
                const unhoverStyle = isUnlocked ? `this.style.background="${isCurrent ? 'linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 107, 53, 0.15))' : 'linear-gradient(135deg, rgba(255, 215, 0, 0.08), rgba(255, 107, 53, 0.08))'}"` : '';
                const currentBorder = isCurrent ? 'border: 2px solid #D4AF37;' : 'border: 1px solid rgba(255, 215, 0, 0.3);';
                const currentBg = isCurrent ? 'background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 107, 53, 0.15));' : 'background: linear-gradient(135deg, rgba(255, 215, 0, 0.08), rgba(255, 107, 53, 0.08));';

                html += `
                    <div onclick="${isUnlocked ? `goToLesson(${lesson.day})` : ''}"
                         onmouseover="${hoverStyle}"
                         onmouseout="${unhoverStyle}"
                         style="display: flex; align-items: center; gap: 1rem;
                                padding: 0.8rem; margin: 0.3rem 0;
                                ${currentBg} ${currentBorder}
                                border-radius: 8px; cursor: ${cursor}; opacity: ${opacity};
                                transition: all 0.3s;">
                        <div style="font-size: 1.2rem; min-width: 30px;">${lockIcon}</div>
                        <div style="flex: 1;">
                            <div style="font-size: 0.75rem; color: #FF6B35; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                                Day ${lesson.day} ‚Ä¢ Week ${lesson.week}
                            </div>
                            <div style="font-size: 0.95rem; color: #030B1F; font-weight: 600; margin-top: 0.2rem;">
                                ${lesson.title}
                            </div>
                        </div>
                        ${isCurrent ? '<div style="font-size: 0.75rem; color: #D4AF37; font-weight: 700; white-space: nowrap;">‚óÑ YOU ARE HERE</div>' : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Update current lesson display
        function updateCurrentLesson() {
            const lesson = getLessonByDay(currentDay);
            if (!lesson) {
                console.error('No lesson found for day:', currentDay);
                return;
            }

            // Update sidebar lesson card
            document.getElementById('lessonWeekPhase').textContent =
                `WEEK ${lesson.week} ‚Ä¢ DAY ${lesson.day}`;
            document.getElementById('lessonTitle').textContent = lesson.title;

            // Check if lesson is completed
            const isCompleted = completedLessons.includes(currentDay);
            const completeBtn = document.querySelector('#lessonCard button[onclick="completeLesson()"]');
            if (isCompleted) {
                completeBtn.innerHTML = '<i class="fas fa-check-circle"></i> Done';
                completeBtn.style.background = 'linear-gradient(135deg, var(--success), var(--purple))';
            } else {
                completeBtn.innerHTML = '<i class="fas fa-check"></i> Complete';
                completeBtn.style.background = '';
            }
        }

        // View lesson details
        function viewLesson() {
            alert('‚úÖ Button clicked! viewLesson function is running. Current day: ' + currentDay);
            console.log('üîç viewLesson called - currentDay:', currentDay);
            console.log('üîç curriculum exists:', !!curriculum);

            // Force load curriculum if not loaded
            if (!curriculum && typeof MANLAW_CURRICULUM !== 'undefined') {
                curriculum = MANLAW_CURRICULUM;
                console.log('‚úÖ Curriculum loaded on-demand');
            }

            const lesson = getLessonByDay(currentDay);
            console.log('üîç lesson found:', !!lesson, lesson);

            if (!lesson) {
                alert('‚ö†Ô∏è Lesson not found for day ' + currentDay + '. Curriculum may not be loaded properly. Please refresh.');
                console.error('‚ùå Lesson not found for day:', currentDay);
                console.error('‚ùå Curriculum status:', curriculum ? 'loaded' : 'not loaded');
                return;
            }

            console.log('‚úÖ Opening modal for lesson:', lesson.title);

            // Check tier access for FAM users
            if (!canAccessLesson(currentDay)) {
                showUpgradeNudge(`Lesson ${currentDay} and beyond`, 'Bronze');
                return;
            }

            // Populate modal
            document.getElementById('modalLessonWeek').textContent =
                `WEEK ${lesson.week} ‚Ä¢ DAY ${lesson.day}`;
            document.getElementById('modalLessonTitle').textContent = lesson.title;
            document.getElementById('modalLessonContent').innerHTML = lesson.content;
            document.getElementById('modalLessonActivity').innerHTML = lesson.activity;
            document.getElementById('modalLessonAssignment').innerHTML = lesson.assignment;

            // Update stage info in modal
            const stageInfo = getCurrentStage(currentDay);
            document.getElementById('modalStageNumber').textContent = `Stage ${stageInfo.stage}`;
            document.getElementById('modalStageName').textContent = stageInfo.name;
            document.getElementById('modalStageSubtitle').textContent = stageInfo.subtitle ? `- ${stageInfo.subtitle}` : '';
            document.getElementById('modalStageLeg').textContent = stageInfo.leg;

            // Generate and populate comprehension questions
            populateComprehensionQuestions(lesson);

            // Update stage overview content
            const overview = getStageOverview(stageInfo.stage);
            const overviewHTML = `
                <div style="margin-bottom: 1rem;">
                    <div style="font-size: 1rem; font-weight: 700; color: var(--gold); margin-bottom: 0.5rem;">
                        ${overview.legPhase}
                    </div>
                    <div style="font-size: 0.95rem; color: var(--white); margin-bottom: 0.5rem;">
                        <strong>Stage ${stageInfo.stage}: ${stageInfo.name}</strong> ‚Äì ${stageInfo.quote}
                    </div>
                    <div style="font-size: 0.9rem; color: var(--white); opacity: 0.9; margin-bottom: 0.3rem;">
                        ‚Üí ${overview.description}
                    </div>
                    <div style="font-size: 0.85rem; color: var(--orange); font-style: italic;">
                        ‚Üí Focus: <strong>${overview.focus}</strong>
                    </div>
                </div>
                <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px;">
                    <div style="font-size: 0.85rem; font-weight: 600; color: var(--gold); margin-bottom: 0.5rem;">
                        üéØ What You'll Learn in This Stage:
                    </div>
                    <ul style="margin: 0; padding-left: 1.5rem; color: var(--white); opacity: 0.9; font-size: 0.85rem; line-height: 1.8;">
                        ${overview.keyLearnings.map(learning => `<li>${learning}</li>`).join('')}
                    </ul>
                </div>
            `;
            document.getElementById('stageOverviewContent').innerHTML = overviewHTML;

            // Show/hide app connection
            const appSection = document.getElementById('modalAppConnection');
            if (lesson.appConnection) {
                appSection.style.display = 'block';
                document.getElementById('modalAppName').textContent = lesson.appConnection.app;
                document.getElementById('modalAppHow').textContent = lesson.appConnection.how;
            } else {
                appSection.style.display = 'none';
            }

            // Show response sections
            document.getElementById("activityResponseSection").style.display = "block";
            document.getElementById("assignmentResponseSection").style.display = "block";
            
            // Clear previous responses and feedback
            document.getElementById("activityResponseInput").value = "";
            document.getElementById("assignmentResponseInput").value = "";
            document.getElementById("activityFeedback").style.display = "none";
            document.getElementById("assignmentFeedback").style.display = "none";

            // Open modal
            const modal = document.getElementById('lessonModal');
            console.log('üéØ Modal element found:', !!modal);
            if (modal) {
                modal.classList.add('show');
                console.log('‚úÖ Modal classList after adding show:', modal.classList.toString());
                console.log('‚úÖ Modal display style:', window.getComputedStyle(modal).display);
            } else {
                console.error('‚ùå lessonModal element not found in DOM!');
                alert('‚ö†Ô∏è Modal element not found. Page may be corrupted.');
            }

            // AUTO-UNLOCK: Mark lesson as complete when opened (unlocks next lesson)
            if (!completedLessons.includes(currentDay)) {
                completedLessons.push(currentDay);
                localStorage.setItem('coach_completed_lessons', JSON.stringify(completedLessons));

                // Update lesson overview to show completion
                renderLessonOverview();

                console.log(`‚úÖ Lesson ${currentDay} auto-completed (unlocks Day ${currentDay + 1})`);
            }
        }

        // Submit activity response to Coach ManLaw
        async function submitActivityResponse() {
            const lesson = getLessonByDay(currentDay);
            if (!lesson) {
                alert('Unable to determine current lesson');
                return;
            }

            const userResponse = document.getElementById('activityResponseInput').value.trim();
            if (!userResponse || userResponse.length < 10) {
                alert('Please write at least 10 characters in your response');
                return;
            }

            // Show loading state
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            button.disabled = true;

            try {
                const response = await fetch('/api/coach/activity-response', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUserId || 'demo-user',
                        day: currentDay,
                        lessonTitle: lesson.title,
                        responseType: 'activity',
                        userResponse: userResponse,
                        btssImpact: lesson.btssImpact || 'all',
                        activity: lesson.activity
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Show feedback
                    document.getElementById('activityFeedbackText').textContent = data.feedback;
                    document.getElementById('activityFeedback').style.display = 'block';

                    // Clear input
                    document.getElementById('activityResponseInput').value = '';

                    // Scroll to feedback
                    document.getElementById('activityFeedback').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    alert('Error: ' + (data.message || 'Failed to submit response'));
                }
            } catch (error) {
                console.error('Submit error:', error);
                alert('Failed to submit your response. Please try again.');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Submit assignment response to Coach ManLaw
        async function submitAssignmentResponse() {
            const lesson = getLessonByDay(currentDay);
            if (!lesson) {
                alert('Unable to determine current lesson');
                return;
            }

            const userResponse = document.getElementById('assignmentResponseInput').value.trim();
            if (!userResponse || userResponse.length < 10) {
                alert('Please write at least 10 characters in your response');
                return;
            }

            // Show loading state
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            button.disabled = true;

            try {
                const response = await fetch('/api/coach/activity-response', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUserId || 'demo-user',
                        day: currentDay,
                        lessonTitle: lesson.title,
                        responseType: 'assignment',
                        userResponse: userResponse,
                        btssImpact: lesson.btssImpact || 'all',
                        activity: lesson.assignment
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Show feedback
                    document.getElementById('assignmentFeedbackText').textContent = data.feedback;
                    document.getElementById('assignmentFeedback').style.display = 'block';

                    // Clear input
                    document.getElementById('assignmentResponseInput').value = '';

                    // Scroll to feedback
                    document.getElementById('assignmentFeedback').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    alert('Error: ' + (data.message || 'Failed to submit response'));
                }
            } catch (error) {
                console.error('Submit error:', error);
                alert('Failed to submit your response. Please try again.');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Close lesson modal
        function closeLessonModal() {
            document.getElementById('lessonModal').classList.remove('show');
        }

        // Complete lesson
        function completeLesson() {
            if (!completedLessons.includes(currentDay)) {
                completedLessons.push(currentDay);
                localStorage.setItem('coach_completed_lessons', JSON.stringify(completedLessons));

                // Update UI
                updateCurrentLesson();
                updateProgressDashboard();
                renderLessonOverview(); // Update lesson list to show completion

                // Close modal if open
                closeLessonModal();

                // Send congratulations message with social sharing option
                addCoachMessage(`
                    <strong>üéâ Lesson Complete!</strong><br><br>
                    You've completed Day ${currentDay}: "${getLessonByDay(currentDay).title}"<br><br>
                    Keep building, Legacy Builder! Ready for the next lesson?
                `);

                // Show social sharing for milestone days
                const milestoneDays = [1, 7, 13, 26, 39, 52, 65, 78, 90];
                if (milestoneDays.includes(currentDay)) {
                    setTimeout(() => showSocialShare(currentDay), 1000);
                }
            }
        }

        // ==================== VOICE RECORDING FOR VOICE CLONING ====================

        // 30-Minute Voice Cloning Script (~4500 words)
        const voiceScript = `Hey Employee, Ready to Break Free?

I'm Coach Manlaw, and I see you. You're trading time for money, building someone else's dream, feeling the weight of the paycheck trap. You know there's more, but the path from employee to entrepreneur feels unclear, risky, maybe even impossible.

Let me be clear: This isn't just a career change. It's a complete identity shift. It's about unlearning dependency and rediscovering self-agency. Moving from surviving on a paycheck to creating value, systems, and legacy.

THE SEVEN STAGE TRANSFORMATION JOURNEY

I'll guide you through seven transformational stages, built on the Four Legs of Your Billion-Dollar Table. Your success depends on your weakest leg, and we're strengthening all of them.

Stage One: Awakening. Realize the trap. Recognize job security is an illusion. Hard work alone won't create freedom. You're stuck in a cycle that wasn't designed for your liberation. It was designed for your productivity.

Stage Two: Reprogramming. Unlearn employee habits. Reprogram for growth, risk, leadership. The employee mindset is a prison of someone else's making. Break free from it.

Stage Three: Discovery. Identify your purpose, passions, strengths. Find your profitable niche. What problem can you solve better than anyone else? That's your path.

Stage Four: Activation. Test ideas. Learn by doing. Overcome fear through execution. Action creates clarity. Waiting for perfect conditions creates regret.

Stage Five: Systemization. Move from hustling to structuring. Build systems that work for you, not you working for the systems. Freedom comes from automation, not exhaustion.

Stage Six: Expansion. Build teams, collaborations, communities that multiply your impact. You can't scale if you're the bottleneck. Leadership is leverage.

Stage Seven: Legacy. Create systems that outlive you. Generational impact. Mentorship. Contribution. This is where entrepreneurs become legends.

YOUR BILLION DOLLAR TABLE FRAMEWORK

Imagine a table with four legs. That table is your life, your business, your billion-dollar future. If one leg is weak, the whole table wobbles, no matter how strong the others are.

Leg One: Mindset Mystery. Transform your identity and beliefs. You can't build a million-dollar business with a minimum-wage mindset. Your internal programming dictates your external results.

Leg Two: Money Moves. Build wealth systems that work while you sleep. Passive income isn't a dream. It's a design. Multiple streams, strategic investments, assets that appreciate.

Leg Three: Legacy Missions. Create scalable systems and automation. Your business should run without you. If it can't, you don't have a business. You have a job you created for yourself.

Leg Four: Momentum Movement. Build influence and lead movements. Your network is your net worth. Your message is your mission. Impact at scale requires a movement, not just a product.

THE EMPLOYEE TRAP

Let's talk about why you're stuck. The employee trap is psychological, financial, and cultural. You were taught to get good grades, get a good job, work hard, and retire. That was the script. But who wrote it? And who benefits from it?

The illusion of job security. Your job isn't secure. It's convenient for your employer. The moment you cost more than you provide, you're replaceable. Loyalty is a one-way street in corporate culture.

Trading time for money. There are only twenty-four hours in a day. If you're paid by the hour, your income has a ceiling. That ceiling is your time. Entrepreneurs break that ceiling by creating value that scales.

Building someone else's dream. Every day you work for someone else, you're building their vision, their wealth, their legacy. What about yours? How much longer will you postpone your own greatness?

The golden handcuffs syndrome. The more you earn as an employee, the harder it is to leave. The mortgage, the car payment, the lifestyle you've built. It all depends on that paycheck. You're not free. You're funded.

MINDSET MYSTERY: THE FIRST LEG

Your mindset is the foundation of everything. Employee mindset versus entrepreneur mindset. Let's break it down.

Employees seek stability. Entrepreneurs create opportunity. Employees avoid risk. Entrepreneurs calculate and take risk. Employees trade time for money. Entrepreneurs build assets that generate money.

Employees wait for permission. Entrepreneurs take initiative. Employees follow instructions. Entrepreneurs write the playbook. Employees retire. Entrepreneurs build legacies.

The fear of failure keeps you employed. The acceptance of failure makes you an entrepreneur. Every successful entrepreneur has failed more times than the average employee has tried.

Scarcity versus abundance thinking. Employees operate from scarcity. There's only one promotion, one spot, one opportunity. Entrepreneurs operate from abundance. There's infinite opportunity if you create it.

From consumer to producer. Employees consume. They buy products, pay for services, rent their time. Entrepreneurs produce. They create products, offer services, own their time.

MONEY MOVES: THE SECOND LEG

Money doesn't sleep, and neither should your income. Multiple streams of income. Active income is what you earn by working. Passive income is what you earn while sleeping. Your goal? Flip the ratio.

The mathematics of wealth. Employees earn linear income. One hour equals one paycheck. Entrepreneurs earn exponential income. One product can sell a million times. One system can serve thousands simultaneously.

Ownership versus salary. Employees rent their time. Entrepreneurs own assets. Real estate, businesses, intellectual property, equity. Ownership is the only path to generational wealth.

Investing like a billionaire. Diversify your portfolio. Stocks, real estate, businesses, crypto, commodities. Don't put all your eggs in one basket. And definitely don't put them in someone else's basket.

Cash flow is king. Profit is an opinion. Cash is a fact. Revenue is vanity. Profit is sanity. Cash flow is reality. Build systems that generate consistent, predictable cash flow.

LEGACY MISSIONS: THE THIRD LEG

Your business should outlive you. That's legacy. Systems, automation, documentation. If your business can't run without you, it's not a business. It's self-employment.

Standard operating procedures. Document everything. How you acquire customers. How you deliver value. How you handle support. How you scale. A documented process is a repeatable process.

Automation and delegation. Technology handles repetition. People handle complexity. Your job as a leader is to architect the system, not operate it.

Building to sell. Even if you never sell, build your business as if you will. Buyers want systems, not solopreneurs. Investors want scalability, not dependency.

Generational wealth. Legacy isn't just about money. It's about values, systems, opportunities you pass down. What will your children inherit? Debt or assets? Scarcity or abundance?

MOMENTUM MOVEMENT: THE FOURTH LEG

You can't build a billion-dollar business alone. You need a team. A network. A movement.

Building your team. Hire for culture, train for skill. Your team is your leverage. The right people multiply your impact. The wrong people divide your energy.

Strategic partnerships. Collaborate, don't compete. Two businesses serving the same audience? Partner. Create win-win scenarios. Joint ventures, affiliate programs, co-marketing.

Your personal brand. You are the message. Your story, your journey, your transformation. People connect with people, not logos. Build your brand, and your business will follow.

Thought leadership. Share your insights. Write. Speak. Teach. Mentor. The more you give, the more you grow. Thought leaders attract opportunity.

Community building. Your customers should become your community. Your community becomes your advocates. Your advocates become your salesforce.

STAGE ONE: AWAKENING

Day one. The employee trap. Why you're stuck. You wake up, go to work, come home, repeat. Weekends are for recovery, not creation. Vacations are an escape, not a lifestyle. This is the trap.

Day two. The illusion of job security. Your job isn't guaranteed. Recessions happen. Layoffs happen. Automation happens. The only security is self-reliance.

Day three. Trading time for money. The hidden cost. Your time is finite. Your potential is infinite. Every hour you trade for a paycheck is an hour you're not building equity.

Day four. Building someone else's dream. Your boss has a vision. A mission. A legacy plan. Where do you fit in it? As a tool. As a resource. As an expense.

Day five. The golden handcuffs syndrome. The more you earn, the more you spend. The more you spend, the more you need that job. It's a cycle designed to keep you running.

Day six. Why hard work alone won't set you free. Hard work is necessary but not sufficient. You need smart work. Strategic work. Leveraged work.

Day seven. BTSS Assessment and Awakening Reflection. Where are you now? Where do you want to be? What's stopping you? Awareness is the first step to transformation.

STAGE TWO: REPROGRAMMING

Week three. Unlearning employee habits. Identifying your employee mindset patterns. The need for approval. The fear of mistakes. The wait for instructions. These are chains. Break them.

The fear of risk. Why you're risk-averse. Because you were taught that safety equals success. But safety equals stagnation. Growth requires risk. Calculated, strategic, intelligent risk.

Dependency to self-reliance shift. Stop waiting for someone to save you. No one is coming. Your rescue is your responsibility. Your transformation is your mission.

Scarcity versus abundance thinking. There's enough for everyone. Opportunity isn't scarce. Your belief in scarcity is. Shift your mindset, shift your reality.

The time trader to value creator shift. Stop selling hours. Start creating value. Products, systems, content, intellectual property. Value scales. Time doesn't.

Consumer to producer identity change. Stop consuming other people's content, products, and dreams. Start producing your own. The world needs what you have to offer.

STAGE THREE: DISCOVERY

Week five. Finding your profitable purpose. Your zone of genius discovery. What do you do better than most? What do you do effortlessly that others struggle with? That's your genius.

Identifying your transferable skills. Everything you've learned as an employee is valuable. Customer service. Project management. Sales. Communication. These skills translate.

Passions that align with profit. Do what you love, but make sure someone will pay for it. Passion without profit is a hobby. Profit without passion is a prison.

Market needs you can solve. Problems are opportunities. Every problem is a business waiting to be built. What frustrates people? Solve it.

Your unique value proposition. What makes you different? What makes you better? What makes you the only choice? Define it clearly.

CONCLUSION OF VOICE SAMPLE

This is the foundation of your ninety-day transformation. From employee to entrepreneur. From dependency to self-agency. From paycheck to legacy.

I am a Legacy Builder. You are a Legacy Builder. Together, we are Builders of Legacies.

Let's transform you from employee to entrepreneur. Your journey starts now.`;

        // Voice recording state
        let mediaRecorder = null;
        let audioChunks = [];
        let currentRecording = null;
        let recordingTimer = null;
        let recordingStartTime = 0;
        let currentSampleIndex = 0;
        let voiceRecordings = JSON.parse(localStorage.getItem('coach_voice_recordings')) || [];

        // Open voice recording modal
        function openVoiceRecording() {
            document.getElementById('voiceRecordingModal').classList.add('show');

            // Display the 30-minute script
            document.getElementById('voiceScript').textContent = voiceScript;

            // Check if voice sample already recorded
            const existingRecording = localStorage.getItem('coach_voice_master_recording');
            if (existingRecording) {
                document.getElementById('audioPlayback').src = existingRecording;
                document.getElementById('audioPlaybackSection').style.display = 'block';
                document.getElementById('saveVoiceBtn').disabled = false;
                document.getElementById('saveVoiceBtn').style.opacity = '1';
            }
        }

        // Close voice recording modal
        function closeVoiceRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopRecording();
            }
            document.getElementById('voiceRecordingModal').classList.remove('show');
        }

        // Update UI with current sample and progress
        function updateVoiceRecordingUI() {
            const sampleNumber = currentSampleIndex + 1;
            document.getElementById('currentSampleNumber').textContent = sampleNumber;
            document.getElementById('sampleText').textContent = voiceSamples[currentSampleIndex];
            document.getElementById('recordedCount').textContent = voiceRecordings.length;

            const progress = (voiceRecordings.length / voiceSamples.length) * 100;
            document.getElementById('voiceProgressBar').style.width = progress + '%';

            // Enable save button if all samples recorded
            const saveBtn = document.getElementById('saveVoiceBtn');
            if (voiceRecordings.length >= voiceSamples.length) {
                saveBtn.disabled = false;
                saveBtn.style.opacity = '1';
            } else {
                saveBtn.disabled = true;
                saveBtn.style.opacity = '0.5';
            }
        }

        // Start recording
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    currentRecording = audioBlob;

                    // Show playback section
                    const audioURL = URL.createObjectURL(audioBlob);
                    document.getElementById('audioPlayback').src = audioURL;
                    document.getElementById('audioPlaybackSection').style.display = 'block';

                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();

                // Update UI
                document.getElementById('recordBtn').disabled = true;
                document.getElementById('recordBtn').style.opacity = '0.5';
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('stopBtn').style.opacity = '1';
                document.getElementById('recordingTimer').style.display = 'block';

                // Start timer
                recordingStartTime = Date.now();
                recordingTimer = setInterval(updateRecordingTimer, 100);

                console.log('üé§ Recording started...');
            } catch (error) {
                console.error('‚ùå Error accessing microphone:', error);
                alert('Could not access microphone. Please check permissions.');
            }
        }

        // Update recording timer
        function updateRecordingTimer() {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('recordingTimer').innerHTML =
                `<i class="fas fa-circle" style="animation: pulse 1s infinite;"></i> ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Stop recording
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();

                // Update UI
                document.getElementById('recordBtn').disabled = false;
                document.getElementById('recordBtn').style.opacity = '1';
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('stopBtn').style.opacity = '0.5';
                document.getElementById('recordingTimer').style.display = 'none';

                // Stop timer
                clearInterval(recordingTimer);

                console.log('‚èπÔ∏è Recording stopped');
            }
        }

        // Play recording
        function playRecording() {
            const audio = document.getElementById('audioPlayback');
            audio.play();
        }

        // Accept recording (save master 30-minute sample)
        async function acceptRecording() {
            if (!currentRecording) {
                alert('No recording to accept');
                return;
            }

            // Convert blob to base64 for storage
            const reader = new FileReader();
            reader.readAsDataURL(currentRecording);
            reader.onloadend = () => {
                const base64Audio = reader.result;

                // Save master recording to localStorage
                localStorage.setItem('coach_voice_master_recording', base64Audio);
                localStorage.setItem('coach_voice_recording_date', new Date().toISOString());

                // Enable save button
                document.getElementById('saveVoiceBtn').disabled = false;
                document.getElementById('saveVoiceBtn').style.opacity = '1';

                // Hide playback controls
                document.getElementById('audioPlaybackSection').style.display = 'block';

                // Show success message
                alert('‚úÖ 30-minute voice sample saved! You can now save your voice profile to proceed with voice cloning.');
                console.log('‚úÖ Master voice recording saved!');
            };
        }

        // Re-record current sample
        function reRecord() {
            document.getElementById('audioPlaybackSection').style.display = 'none';
            currentRecording = null;
        }

        // Load and display recorded samples
        function loadRecordedSamples() {
            const listContainer = document.getElementById('recordedSamplesList');

            if (voiceRecordings.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; opacity: 0.5;">
                        No samples recorded yet. Start recording above!
                    </div>
                `;
                return;
            }

            let html = '';
            voiceRecordings.forEach((recording, index) => {
                html += `
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: linear-gradient(135deg, rgba(255, 215, 0, 0.08), rgba(255, 107, 53, 0.08)); border-radius: 10px; margin-bottom: 0.5rem; border: 1px solid rgba(255, 215, 0, 0.3);">
                        <div style="flex: 1;">
                            <div style="font-size: 0.75rem; color: var(--orange); font-weight: 600; margin-bottom: 0.3rem;">
                                SAMPLE ${recording.sampleIndex + 1}
                            </div>
                            <div style="font-size: 0.85rem; color: var(--white); opacity: 0.9;">
                                ${recording.sampleText.substring(0, 60)}...
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="playSample(${index})" style="padding: 0.6rem 1rem; background: linear-gradient(135deg, var(--success), var(--purple)); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; font-size: 0.85rem;">
                                <i class="fas fa-play"></i>
                            </button>
                            <button onclick="deleteSample(${index})" style="padding: 0.6rem 1rem; background: linear-gradient(135deg, #FF4444, #CC0000); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; font-size: 0.85rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });

            listContainer.innerHTML = html;
        }

        // Play a specific sample
        function playSample(index) {
            const recording = voiceRecordings[index];
            const audio = new Audio(recording.audioData);
            audio.play();
        }

        // Delete a sample
        function deleteSample(index) {
            if (confirm('Delete this voice sample?')) {
                voiceRecordings.splice(index, 1);
                localStorage.setItem('coach_voice_recordings', JSON.stringify(voiceRecordings));
                updateVoiceRecordingUI();
                loadRecordedSamples();
            }
        }

        // Save voice profile and prepare for voice cloning
        function saveVoiceProfile() {
            const masterRecording = localStorage.getItem('coach_voice_master_recording');

            if (!masterRecording) {
                alert('Please record your 30-minute voice sample first!');
                return;
            }

            // Mark voice profile as complete
            localStorage.setItem('coach_voice_profile_complete', 'true');
            localStorage.setItem('coach_voice_profile_date', new Date().toISOString());

            // Show detailed next steps message
            addCoachMessage(`
                <strong>üéâ Voice Profile Saved Successfully!</strong><br><br>
                Your 30-minute voice sample has been saved! (~${Math.round(masterRecording.length / 1024)}KB)<br><br>

                <strong>üìã Next Steps for Voice Cloning:</strong><br><br>

                <strong>OPTION 1: Coqui TTS (Free, Self-Hosted)</strong><br>
                ‚Ä¢ Install Python and Coqui TTS library<br>
                ‚Ä¢ Use your recording to train voice model<br>
                ‚Ä¢ Generate audio for all 90 lessons locally<br>
                ‚Ä¢ No third-party service needed<br><br>

                <strong>OPTION 2: Manual Audio Recording</strong><br>
                ‚Ä¢ Use your recording as reference tone<br>
                ‚Ä¢ Record full audio for each lesson manually<br>
                ‚Ä¢ Upload audio files to the app<br>
                ‚Ä¢ App plays your recordings<br><br>

                <strong>üîß Technical Setup (Coming Soon):</strong><br>
                I'll add features to:<br>
                1. Export your 30-min recording<br>
                2. Upload generated lesson audio<br>
                3. Integrate voice synthesis API<br>
                4. Auto-generate all 90 lessons + intro<br><br>

                <strong>üìä Current Status:</strong><br>
                ‚úÖ Master voice recording saved<br>
                ‚úÖ Voice profile completed<br>
                ‚è≥ Voice cloning setup pending<br>
                ‚è≥ 90 lesson audio generation pending<br><br>

                <em>Your recording is safely stored in your browser (localStorage).</em><br>
                <em>Ready to proceed with voice cloning integration when you are!</em>
            `);

            closeVoiceRecording();

            console.log('‚úÖ Voice profile saved!', {
                recordingSize: `${Math.round(masterRecording.length / 1024)}KB`,
                timestamp: new Date().toISOString()
            });
        }

        // ==================== INTRODUCTION AUDIO ====================

        // Play introduction audio with Luke
        function playIntroductionAudio() {
            const introText = `
                Hey Employee, Ready to Break Free?

                I'm Coach Manlaw‚Äîand I see you. You're trading time for money, building someone else's dream, feeling the weight of the paycheck trap.
                You know there's more, but the path from employee to entrepreneur feels unclear, risky, maybe even impossible.

                Let me be clear: This isn't just a career change. It's a complete identity shift.
                It's about unlearning dependency and rediscovering self-agency. Moving from surviving on a paycheck to creating value, systems, and legacy.

                THE 7-STAGE TRANSFORMATION JOURNEY: From Employee to Entrepreneur

                I'll guide you through 7 transformational stages, built on the 4 Legs of Your Billion-Dollar Table.
                Your success depends on your weakest leg‚Äîand we're strengthening ALL of them:

                Stage 1: Awakening ‚Äì Realize the trap. Recognize job security is an illusion. Hard work alone won't create freedom.

                Stage 2: Reprogramming ‚Äì Unlearn employee habits. Reprogram for growth, risk, leadership.

                Stage 3: Discovery ‚Äì Identify your purpose, passions, strengths. Find your profitable niche.

                Stage 4: Activation ‚Äì Test ideas. Learn by doing. Overcome fear through execution.

                Stage 5: Systemization ‚Äì Move from hustling to structuring. Build systems that work for you.

                Stage 6: Expansion ‚Äì Build teams, collaborations, communities that multiply your impact.

                Stage 7: Legacy ‚Äì Create systems that outlive you. Generational impact. Mentorship. Contribution.

                YOUR BILLIONAIRE TABLE FRAMEWORK:
                Mindset Mystery - Transform identity and beliefs
                Money Moves - Build wealth systems that work while you sleep
                Legacy Missions - Create scalable systems and automation
                Momentum Movement - Build influence and lead movements

                As a man thinks, so is he. But thinking without action is just dreaming.
                We're building systems, movements, and money machines.

                I am a Legacy Builder, You are a Legacy Builder, and Together we are Builders of Legacies.

                Your First Step: Take your BTSS assessment.
                I'll identify which stage you're in, which leg is weakest, and exactly where to focus your transformation.

                Let's transform you from employee to entrepreneur!
            `;

            if (currentUtterance && speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }

            currentUtterance = new SpeechSynthesisUtterance(introText);
            currentUtterance.rate = 0.9;
            currentUtterance.pitch = 1.0;
            currentUtterance.volume = 1.0;

            // Select Luke voice
            const voices = speechSynthesis.getVoices();
            const lukeVoice = voices.find(v => v.lang === 'en-ZA' && !v.name.toLowerCase().includes('female')) ||
                             voices.find(v => v.lang === 'en-ZA') ||
                             voices.find(v => v.name.includes('Luke') || v.name.includes('Thabo'));

            if (lukeVoice) {
                currentUtterance.voice = lukeVoice;
            }

            currentUtterance.onstart = () => {
                addCoachMessage('üéß Playing introduction... Luke is speaking to you!');
            };

            currentUtterance.onend = () => {
                addCoachMessage('‚úÖ Introduction complete. Ready to start your transformation?');
            };

            speechSynthesis.speak(currentUtterance);
        }

        // Read all 90 lessons
        function readAllLessons() {
            const allLessons = getAllLessons();
            if (allLessons.length === 0) {
                addCoachMessage('‚ö†Ô∏è Lessons not loaded yet. Please wait a moment and try again.');
                return;
            }

            let lessonText = `
                Your Complete 90-Day Transformation Journey.
                I'm going to read all 90 lesson titles organized by the 7 stages of transformation.
                Listen carefully to see the complete path from employee to entrepreneur.

            `;

            let currentStageNum = 0;
            allLessons.forEach((lesson) => {
                const stageInfo = getCurrentStage(lesson.day);

                // Announce new stage
                if (stageInfo.stage !== currentStageNum) {
                    currentStageNum = stageInfo.stage;
                    lessonText += `
                        Stage ${stageInfo.stage}: ${stageInfo.name}. ${stageInfo.leg}.
                    `;
                }

                lessonText += `
                    Day ${lesson.day}: ${lesson.title}.
                `;
            });

            lessonText += `
                That's your complete 90-day journey.
                All 90 lessons designed to transform you from employee to entrepreneur.
                Start with Day 1 and follow the path. Trust the process. Build your legacy.
            `;

            if (currentUtterance && speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }

            currentUtterance = new SpeechSynthesisUtterance(lessonText);
            currentUtterance.rate = 1.0;
            currentUtterance.pitch = 1.0;
            currentUtterance.volume = 1.0;

            // Select Luke voice
            const voices = speechSynthesis.getVoices();
            const lukeVoice = voices.find(v => v.lang === 'en-ZA' && !v.name.toLowerCase().includes('female')) ||
                             voices.find(v => v.lang === 'en-ZA') ||
                             voices.find(v => v.name.includes('Luke') || v.name.includes('Thabo'));

            if (lukeVoice) {
                currentUtterance.voice = lukeVoice;
            }

            currentUtterance.onstart = () => {
                addCoachMessage('üéß Luke is now reading all 90 lessons... This will take a few minutes. Relax and listen to your transformation roadmap!');
            };

            currentUtterance.onend = () => {
                addCoachMessage('‚úÖ All 90 lessons read! That\'s your complete journey. Ready to start Day 1?');
            };

            speechSynthesis.speak(currentUtterance);
        }

        // ==================== COMPREHENSION SYSTEM ====================

        // Generate comprehension questions based on lesson content
        function populateComprehensionQuestions(lesson) {
            const container = document.getElementById('comprehensionQuestions');
            if (!container) return;

            // Generate 5 questions based on the lesson
            const questions = generateQuestionsFromLesson(lesson);

            let html = '';
            questions.forEach((q, index) => {
                html += `
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 10px;">
                        <div style="font-weight: 600; color: var(--gold); margin-bottom: 0.8rem;">
                            ${index + 1}. ${q.question}
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            ${q.options.map((option, optIndex) => `
                                <label style="display: flex; align-items: center; padding: 0.8rem; background: rgba(255,255,255,0.05); border-radius: 8px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,215,0,0.15)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                                    <input type="radio" name="q${index}" value="${optIndex}" style="margin-right: 0.8rem; width: 18px; height: 18px; cursor: pointer;">
                                    <span style="color: var(--white); opacity: 0.9;">${option}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            container.dataset.answers = JSON.stringify(questions.map(q => q.correctIndex));
        }

        // Generate questions from lesson content
        function generateQuestionsFromLesson(lesson) {
            const stageInfo = getCurrentStage(lesson.day);

            // Base questions - these are generic but contextual to the transformation
            const questions = [
                {
                    question: `What is the main focus of today's lesson: "${lesson.title}"?`,
                    options: [
                        "Understanding the challenge and identifying the problem",
                        "Taking immediate action without understanding",
                        "Avoiding the topic entirely",
                        "Waiting for someone else to solve it"
                    ],
                    correctIndex: 0
                },
                {
                    question: `Which stage of transformation are you in on Day ${lesson.day}?`,
                    options: [
                        `Stage ${stageInfo.stage}: ${stageInfo.name}`,
                        "I'm not in any particular stage",
                        "The final stage",
                        "Just starting"
                    ],
                    correctIndex: 0
                },
                {
                    question: "According to Coach Manlaw, what comes before action?",
                    options: [
                        "Perfect planning",
                        "Understanding and awareness",
                        "Getting permission",
                        "Waiting for the right time"
                    ],
                    correctIndex: 1
                },
                {
                    question: `This lesson primarily impacts which leg of the Billion-Dollar Table?`,
                    options: [
                        stageInfo.leg,
                        "None of the legs",
                        "All legs equally",
                        "Only financial aspects"
                    ],
                    correctIndex: 0
                },
                {
                    question: "What is the ultimate goal of the 90-day transformation programme?",
                    options: [
                        "To become rich quickly",
                        "To quit your job immediately",
                        "To transform from employee mindset to entrepreneur mindset and build legacy",
                        "To learn theory without implementation"
                    ],
                    correctIndex: 2
                }
            ];

            return questions;
        }

        // Check comprehension answers
        function checkComprehension() {
            const container = document.getElementById('comprehensionQuestions');
            const correctAnswers = JSON.parse(container.dataset.answers || '[]');

            let score = 0;
            let totalQuestions = correctAnswers.length;
            let results = [];

            correctAnswers.forEach((correctIndex, qIndex) => {
                const selected = document.querySelector(`input[name="q${qIndex}"]:checked`);
                if (selected && parseInt(selected.value) === correctIndex) {
                    score++;
                    results.push(true);
                } else {
                    results.push(false);
                }
            });

            const percentage = Math.round((score / totalQuestions) * 100);
            const feedbackEl = document.getElementById('comprehensionFeedback');
            const feedbackText = document.getElementById('comprehensionFeedbackText');

            let message = '';
            let emoji = '';

            if (percentage === 100) {
                emoji = 'üèÜ';
                message = `<strong>Perfect Score! ${score}/${totalQuestions} (${percentage}%)</strong><br><br>Excellent! You've fully understood today's lesson. You're ready to move forward with the activity and assignment. This level of comprehension will accelerate your transformation!`;
            } else if (percentage >= 80) {
                emoji = '‚úÖ';
                message = `<strong>Great Job! ${score}/${totalQuestions} (${percentage}%)</strong><br><br>You've grasped the key concepts of today's lesson. Review the areas you missed to strengthen your understanding, then proceed with the activity and assignment.`;
            } else if (percentage >= 60) {
                emoji = 'üìñ';
                message = `<strong>Good Start! ${score}/${totalQuestions} (${percentage}%)</strong><br><br>You're on the right track, but I recommend re-reading today's lesson before moving to the activity. Understanding the foundation is crucial for lasting transformation.`;
            } else {
                emoji = 'üîÑ';
                message = `<strong>Needs Review: ${score}/${totalQuestions} (${percentage}%)</strong><br><br>Take your time to re-read today's lesson. Understanding comes before action. This isn't a race‚Äîit's a transformation. Read the lesson again, then retake the comprehension check.`;
            }

            feedbackText.innerHTML = `${emoji} ${message}`;
            feedbackEl.style.display = 'block';

            // Scroll to feedback
            feedbackEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // ==================== JOURNAL SYSTEM ====================

        // Save entry to journal
        function saveToJournal(type) {
            const lesson = getLessonByDay(currentDay);
            if (!lesson) return;

            let content = '';
            let entryType = '';

            if (type === 'activity') {
                content = document.getElementById('activityResponseInput').value.trim();
                entryType = 'Activity';
            } else if (type === 'assignment') {
                content = document.getElementById('assignmentResponseInput').value.trim();
                entryType = 'Assignment';
            } else if (type === 'notes') {
                content = document.getElementById('personalNotesInput').value.trim();
                entryType = 'Personal Notes';
            } else if (type === 'comprehension') {
                // Save comprehension quiz results
                const container = document.getElementById('comprehensionQuestions');
                const correctAnswers = JSON.parse(container.dataset.answers || '[]');
                let results = [];
                correctAnswers.forEach((correctIndex, qIndex) => {
                    const selected = document.querySelector(`input[name="q${qIndex}"]:checked`);
                    const questionText = container.querySelectorAll('.assessment-item > div > div')[qIndex * 2]?.textContent || `Question ${qIndex + 1}`;
                    results.push({
                        question: questionText,
                        answered: selected ? parseInt(selected.value) === correctIndex : false
                    });
                });
                const score = results.filter(r => r.answered).length;
                content = `Comprehension Score: ${score}/${correctAnswers.length} (${Math.round((score/correctAnswers.length)*100)}%)\n\n`;
                results.forEach((r, i) => {
                    content += `${i + 1}. ${r.question.replace(/^\d+\.\s*/, '')} - ${r.answered ? '‚úì Correct' : '‚úó Incorrect'}\n`;
                });
                entryType = 'Comprehension';
            }

            if (!content) {
                addCoachMessage(`‚ö†Ô∏è Please write something in the ${entryType.toLowerCase()} field before saving!`);
                return;
            }

            // Get existing journal
            const journal = JSON.parse(localStorage.getItem('coach_journal') || '[]');

            // Create journal entry
            const entry = {
                id: Date.now(),
                day: currentDay,
                date: new Date().toISOString(),
                lessonTitle: lesson.title,
                type: entryType,
                content: content,
                stageInfo: getCurrentStage(currentDay)
            };

            // Add to journal
            journal.push(entry);
            localStorage.setItem('coach_journal', JSON.stringify(journal));

            // Show confirmation
            addCoachMessage(`
                <strong>‚úÖ Saved to Journal!</strong><br><br>
                Your ${entryType.toLowerCase()} for Day ${currentDay} has been saved to your transformation journal.
                You can view and download your complete journal anytime!
            `);

            // Clear the input field
            if (type === 'activity') document.getElementById('activityResponseInput').value = '';
            if (type === 'assignment') document.getElementById('assignmentResponseInput').value = '';
            if (type === 'notes') document.getElementById('personalNotesInput').value = '';
        }

        // Open journal modal
        function viewJournal() {
            const journal = JSON.parse(localStorage.getItem('coach_journal') || '[]');
            const container = document.getElementById('journalEntriesContainer');

            if (journal.length === 0) {
                container.innerHTML = `
                    <div class="assessment-item" style="text-align: center; padding: 3rem;">
                        <i class="fas fa-book-open" style="font-size: 3rem; color: var(--gold); opacity: 0.5; margin-bottom: 1rem;"></i>
                        <p style="color: var(--white); opacity: 0.7;">
                            Your journal is empty. Start writing your transformation story!
                        </p>
                    </div>
                `;
            } else {
                // Sort by day (most recent first)
                journal.sort((a, b) => b.day - a.day);

                let html = '';
                journal.forEach((entry) => {
                    const date = new Date(entry.date).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    const typeColor = entry.type === 'Activity' ? 'var(--purple)' :
                                     entry.type === 'Assignment' ? 'var(--orange)' :
                                     'var(--success)';

                    html += `
                        <div class="assessment-item" style="border-left: 4px solid ${typeColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <div>
                                    <div style="font-size: 0.85rem; color: ${typeColor}; font-weight: 600;">
                                        Day ${entry.day} ‚Ä¢ ${entry.type}
                                    </div>
                                    <div style="font-size: 0.95rem; color: var(--gold); font-weight: 600;">
                                        ${entry.lessonTitle}
                                    </div>
                                    <div style="font-size: 0.75rem; color: var(--white); opacity: 0.6;">
                                        ${date}
                                    </div>
                                </div>
                            </div>
                            <div style="color: var(--white); opacity: 0.9; line-height: 1.6; white-space: pre-wrap;">
                                ${entry.content}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            }

            document.getElementById('journalModal').classList.add('show');
        }

        // Close journal modal
        function closeJournal() {
            document.getElementById('journalModal').classList.remove('show');
        }

        // Download journal as text file
        function downloadJournal() {
            const journal = JSON.parse(localStorage.getItem('coach_journal') || '[]');

            if (journal.length === 0) {
                addCoachMessage('‚ö†Ô∏è Your journal is empty. Complete some activities and add notes first!');
                return;
            }

            // Sort by day
            journal.sort((a, b) => a.day - b.day);

            // Build text content
            let content = `
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                               ‚ïë
‚ïë        COACH MANLAW - 90-DAY TRANSFORMATION JOURNAL          ‚ïë
‚ïë        Employee to Entrepreneur Journey                      ‚ïë
‚ïë                                                               ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

Generated: ${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
Total Entries: ${journal.length}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

`;

            journal.forEach((entry, index) => {
                const date = new Date(entry.date).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                content += `
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
ENTRY ${index + 1} | DAY ${entry.day} | ${entry.type.toUpperCase()}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

Lesson: ${entry.lessonTitle}
Date: ${date}
Stage: Stage ${entry.stageInfo.stage} - ${entry.stageInfo.name}

${entry.content}

`;
            });

            content += `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

"I am a Legacy Builder, You are a Legacy Builder,
and Together we are Builders of Legacies."

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                www.z2blegacy.com
                Coach Manlaw - Legacy Builder Programme
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
`;

            // Create blob and download
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Coach_Manlaw_Journal_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            addCoachMessage('‚úÖ Journal downloaded successfully! Your transformation story is saved.');
        }

        // Clear journal (with confirmation)
        function clearJournal() {
            if (confirm('‚ö†Ô∏è Are you sure you want to clear your entire journal? This cannot be undone!\n\nTip: Download your journal first to keep a backup.')) {
                localStorage.removeItem('coach_journal');
                closeJournal();
                addCoachMessage('üóëÔ∏è Journal cleared. Your journal entries have been deleted.');
            }
        }

        // ==================== SOCIAL SHARING ====================

        // Show social sharing modal for milestones
        function showSocialShare(day) {
            const stageInfo = getCurrentStage(day);
            const lesson = getLessonByDay(day);

            let milestone = '';
            let shareText = '';

            if (day === 1) {
                milestone = 'üöÄ Started My Transformation!';
                shareText = `I just started my 90-day transformation from Employee to Entrepreneur with Coach Manlaw! Day 1 complete. üí™ #CoachManlaw #LegacyBuilder #Entrepreneur`;
            } else if (day === 13) {
                milestone = `üéâ Stage 1 Complete: Awakening!`;
                shareText = `Just completed Stage 1 of my transformation! I'm awakening to the employee trap and stepping into my entrepreneur identity. Day 13/90 ‚úÖ #CoachManlaw #Awakening #LegacyBuilder`;
            } else if (day === 26) {
                milestone = `üî• Stage 2 Complete: Reprogrammed!`;
                shareText = `Mind reprogrammed! Just finished Stage 2 of my 90-day transformation. Employee mindset ‚Üí Entrepreneur thinking. Day 26/90 ‚úÖ #CoachManlaw #MindsetShift #Entrepreneur`;
            } else if (day === 39) {
                milestone = `üíé Stage 3 Complete: Purpose Discovered!`;
                shareText = `Found my profitable purpose! Stage 3 complete. I know my zone of genius and ready to create value. Day 39/90 ‚úÖ #CoachManlaw #Purpose #LegacyBuilder`;
            } else if (day === 52) {
                milestone = `üí∞ Stage 4 Complete: First Income!`;
                shareText = `Generated my first entrepreneurial income! Stage 4 complete. From employee to earner. Day 52/90 ‚úÖ #CoachManlaw #FirstSale #Entrepreneur`;
            } else if (day === 65) {
                milestone = `‚öôÔ∏è Stage 5 Complete: Systems Built!`;
                shareText = `Business systems built! Stage 5 complete. Working ON the business, not just IN it. Day 65/90 ‚úÖ #CoachManlaw #Systems #BusinessOwner`;
            } else if (day === 78) {
                milestone = `üåç Stage 6 Complete: Team Activated!`;
                shareText = `Built my team and community! Stage 6 complete. Multiplying impact through others. Day 78/90 ‚úÖ #CoachManlaw #Leadership #LegacyBuilder`;
            } else if (day === 90) {
                milestone = `üëë TRANSFORMATION COMPLETE!`;
                shareText = `I DID IT! 90 days complete. From employee to entrepreneur. Legacy secured! üéâüî•üí™ Thank you Coach Manlaw! #CoachManlaw #90DayChallenge #Entrepreneur #LegacyBuilder`;
            } else {
                milestone = `Day ${day} Complete!`;
                shareText = `Day ${day}/90 complete in my transformation journey with Coach Manlaw! Building my legacy one day at a time. üí™ #CoachManlaw #LegacyBuilder`;
            }

            addCoachMessage(`
                <strong>${milestone}</strong><br><br>
                <div style="background: rgba(255,215,0,0.1); padding: 1rem; border-radius: 10px; border-left: 4px solid var(--gold); margin: 1rem 0;">
                    <strong>üì± Share Your Achievement!</strong><br><br>
                    <em style="font-size: 0.9rem;">"${shareText}"</em>
                </div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button onclick="shareToFacebook('${encodeURIComponent(shareText)}')" style="flex: 1; min-width: 120px; padding: 0.8rem; background: linear-gradient(135deg, #1877F2, #0C5FAC); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
                        <i class="fab fa-facebook"></i> Facebook
                    </button>
                    <button onclick="shareToTwitter('${encodeURIComponent(shareText)}')" style="flex: 1; min-width: 120px; padding: 0.8rem; background: linear-gradient(135deg, #1DA1F2, #0C85D0); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
                        <i class="fab fa-twitter"></i> Twitter
                    </button>
                    <button onclick="copyShareText('${shareText.replace(/'/g, "\\'")}')" style="flex: 1; min-width: 120px; padding: 0.8rem; background: linear-gradient(135deg, var(--gold), var(--orange)); border: none; border-radius: 8px; color: var(--navy-blue); font-weight: 600; cursor: pointer;">
                        <i class="fas fa-copy"></i> Copy Text
                    </button>
                </div>
            `);
        }

        // Share to Facebook
        function shareToFacebook(text) {
            const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent('https://z2blegacy.com')}&quote=${text}`;
            window.open(url, '_blank', 'width=600,height=400');
        }

        // Share to Twitter
        function shareToTwitter(text) {
            const url = `https://twitter.com/intent/tweet?text=${text}&url=${encodeURIComponent('https://z2blegacy.com')}`;
            window.open(url, '_blank', 'width=600,height=400');
        }

        // Copy share text to clipboard
        function copyShareText(text) {
            navigator.clipboard.writeText(text).then(() => {
                addCoachMessage('‚úÖ Text copied to clipboard! Paste it anywhere you want to share your achievement.');
            }).catch(() => {
                addCoachMessage('‚ö†Ô∏è Could not copy text. Please copy it manually from the message above.');
            });
        }

        // Navigate to previous day
        function previousDay() {
            if (currentDay > 1) {
                currentDay--;
                localStorage.setItem('coach_current_day', currentDay);
                updateCurrentLesson();
                updateJourneyDay();
                renderLessonOverview(); // Update lesson overview
                closeLessonModal();
            }
        }

        // Navigate to next day
        function nextDay() {
            if (currentDay < 90) {
                // Check if FAM user trying to go beyond lesson 7
                if (!canAccessLesson(currentDay + 1)) {
                    showUpgradeNudge('Lessons 8-90', 'Bronze');
                    return;
                }

                currentDay++;
                localStorage.setItem('coach_current_day', currentDay);
                updateCurrentLesson();
                updateJourneyDay();
                renderLessonOverview(); // Update lesson overview
                closeLessonModal();
            }
        }

        // Show progress dashboard
        function showProgress() {
            updateProgressDashboard();
            document.getElementById('progressModal').classList.add('show');
        }

        // Close progress modal
        function closeProgress() {
            document.getElementById('progressModal').classList.remove('show');
        }

        // Show 90-Day Content List
        function show90DayList() {
            // Ensure curriculum is loaded
            if (typeof MANLAW_CURRICULUM !== 'undefined' && !curriculum) {
                curriculum = MANLAW_CURRICULUM;
                console.log('‚úÖ Curriculum loaded for 90-day list');
                renderLessonOverview(); // Re-render with loaded curriculum
            }

            const roadmapSection = document.getElementById('roadmapSection');
            const chatMessages = document.getElementById('chatMessages');

            if (roadmapSection && chatMessages) {
                // Scroll the chat messages container to show the roadmap
                const roadmapTop = roadmapSection.offsetTop;
                chatMessages.scrollTo({
                    top: roadmapTop - 20, // 20px offset for better visibility
                    behavior: 'smooth'
                });

                // Add visual highlight effect
                roadmapSection.style.animation = 'pulse 1s ease-in-out';
                setTimeout(() => {
                    roadmapSection.style.animation = '';
                }, 1000);

                // Send confirmation message
                addCoachMessage(`
                    <strong>üìö 90-Day Content List</strong><br><br>
                    Scrolling to your complete transformation roadmap! All 90 lessons are organized by the 7 transformation stages.<br><br>
                    üîí Locked lessons will unlock as you complete previous lessons.<br>
                    ‚úÖ Completed lessons show a checkmark.<br>
                    üîì Click any unlocked lesson to start learning!<br><br>
                    <em>Remember: Trust the process. Sequential learning ensures lasting transformation.</em>
                `);
            } else {
                // If roadmap section not found, something is wrong
                console.error('‚ùå Roadmap section not found!', { roadmapSection: !!roadmapSection, chatMessages: !!chatMessages });
                addCoachMessage('üìö Loading your 90-day content list... Please refresh the page if the list doesn\'t appear.');

                // Try to render the overview anyway
                if (typeof renderLessonOverview === 'function') {
                    renderLessonOverview();
                }
            }
        }

        // Update progress dashboard
        function updateProgressDashboard() {
            // Overall progress
            document.getElementById('progressDay').textContent = currentDay;
            document.getElementById('progressPercent').textContent = Math.round((currentDay / 90) * 100) + '%';
            document.getElementById('progressCompleted').textContent = completedLessons.length;

            // Phase progress
            const phase1Lessons = completedLessons.filter(d => d >= 1 && d <= 20);
            const phase2Lessons = completedLessons.filter(d => d >= 21 && d <= 35);
            const phase3Lessons = completedLessons.filter(d => d >= 36 && d <= 50);
            const phase4Lessons = completedLessons.filter(d => d >= 51 && d <= 65);

            const phase1Percent = Math.round((phase1Lessons.length / 20) * 100);
            const phase2Percent = Math.round((phase2Lessons.length / 15) * 100);
            const phase3Percent = Math.round((phase3Lessons.length / 15) * 100);
            const phase4Percent = Math.round((phase4Lessons.length / 15) * 100);

            document.getElementById('phase1Progress').textContent = phase1Percent + '%';
            document.getElementById('phase2Progress').textContent = phase2Percent + '%';
            document.getElementById('phase3Progress').textContent = phase3Percent + '%';
            document.getElementById('phase4Progress').textContent = phase4Percent + '%';

            document.getElementById('phase1Bar').style.width = phase1Percent + '%';
            document.getElementById('phase2Bar').style.width = phase2Percent + '%';
            document.getElementById('phase3Bar').style.width = phase3Percent + '%';
            document.getElementById('phase4Bar').style.width = phase4Percent + '%';

            // BTSS history
            const historyDiv = document.getElementById('btssHistory');
            if (btssHistory.length > 0) {
                let historyHTML = '<div style="display: grid; gap: 0.8rem;">';
                btssHistory.forEach((record, index) => {
                    const date = new Date(record.date).toLocaleDateString();
                    historyHTML += `
                        <div style="background: rgba(255,255,255,0.05); padding: 0.8rem; border-radius: 8px;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">Assessment ${index + 1} - ${date}</div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.85rem;">
                                <div>üß† Mindset: ${record.mindset}%</div>
                                <div>üí∏ Money: ${record.money}%</div>
                                <div>‚öôÔ∏è Legacy: ${record.legacy}%</div>
                                <div>üåç Movement: ${record.movement}%</div>
                            </div>
                        </div>
                    `;
                });
                historyHTML += '</div>';
                historyDiv.innerHTML = historyHTML;
            }
        }

        // Get stage overview details
        function getStageOverview(stage) {
            const overviews = {
                1: {
                    legPhase: "üß† MINDSET MYSTERY - Awakening & Reprogramming Your Mind",
                    description: "Realize the trap. Recognize job security is an illusion. Hard work alone won't create freedom.",
                    focus: "Awareness ‚Üí Financial self-realization",
                    keyLearnings: [
                        "Identify the employee trap and psychological chains of employment",
                        "Recognize that job security is an illusion",
                        "Understand that hard work alone won't create freedom",
                        "Begin shifting from employee to entrepreneur mindset"
                    ]
                },
                2: {
                    legPhase: "üß† MINDSET MYSTERY - Awakening & Reprogramming Your Mind",
                    description: "Unlearn employee habits (fear, dependency, trading time for money). Reprogram for growth, risk, leadership.",
                    focus: "Unlearning ‚Üí Building a Money Mindset",
                    keyLearnings: [
                        "Identify and challenge limiting employee beliefs",
                        "Develop calculated risk-taking skills",
                        "Build self-agency and independence",
                        "Adopt abundance thinking over scarcity mindset"
                    ]
                },
                3: {
                    legPhase: "üí∏ MONEY MOVES - From Value Discovery to First Income",
                    description: "Identify your purpose, passions, strengths. Find your profitable niche‚Äîyour true path as a value creator.",
                    focus: "Self-awareness ‚Üí Profitable purpose",
                    keyLearnings: [
                        "Discover your zone of genius and transferable skills",
                        "Identify market needs you can solve",
                        "Define your unique value proposition",
                        "Select and validate your profitable niche"
                    ]
                },
                4: {
                    legPhase: "üí∏ MONEY MOVES - From Value Discovery to First Income",
                    description: "Test ideas through small offers or side hustles. Learn by doing. Overcome fear through execution.",
                    focus: "Action ‚Üí First income stream",
                    keyLearnings: [
                        "Launch your Minimum Viable Offer (MVO)",
                        "Acquire your first customer",
                        "Generate your first entrepreneurial income",
                        "Learn from market feedback and iterate"
                    ]
                },
                5: {
                    legPhase: "‚öôÔ∏è LEGACY MISSIONS - Building Systems That Work For You",
                    description: "Move from hustling to structuring. Build systems, automations, processes that create leverage and consistency.",
                    focus: "Self-employment ‚Üí Business ownership",
                    keyLearnings: [
                        "Document your core business processes",
                        "Implement marketing, sales, and delivery systems",
                        "Create SOPs (Standard Operating Procedures)",
                        "Build automation that works without constant personal effort"
                    ]
                },
                6: {
                    legPhase: "üåç MOMENTUM MOVEMENT - From Solo Success to Generational Impact",
                    description: "Shift from working IN the business to working ON it. Build teams, collaborations, communities that multiply your impact.",
                    focus: "Leadership ‚Üí Community growth",
                    keyLearnings: [
                        "Build and lead your first team members",
                        "Develop delegation and leadership skills",
                        "Create strategic partnerships and collaborations",
                        "Build community and expand market reach"
                    ]
                },
                7: {
                    legPhase: "üåç MOMENTUM MOVEMENT - From Solo Success to Generational Impact",
                    description: "Transcend personal success. Focus on generational impact, mentorship, contribution.",
                    focus: "Purpose-driven leadership ‚Üí Legacy creation",
                    keyLearnings: [
                        "Create systems that outlive you",
                        "Develop succession and legacy plans",
                        "Become a mentor and industry guide",
                        "Build generational wealth and lasting impact"
                    ]
                }
            };
            return overviews[stage] || overviews[1];
        }

        // Get current stage info based on day
        function getCurrentStage(day) {
            const stages = [
                {
                    stage: 1,
                    name: "Awakening",
                    subtitle: "The Problem",
                    dayRange: [1, 13],
                    leg: "üß† Mindset Mystery",
                    quote: '"I\'m not building my dream. I\'m helping someone else build theirs."',
                    focus: "Realize the employee trap"
                },
                {
                    stage: 2,
                    name: "Reprogramming",
                    dayRange: [14, 26],
                    leg: "üß† Mindset Mystery",
                    quote: '"If I don\'t change my thinking, I\'ll repeat the same cycle."',
                    focus: "Reset mindset for entrepreneurship"
                },
                {
                    stage: 3,
                    name: "Discovery",
                    dayRange: [27, 39],
                    leg: "üí∏ Money Moves",
                    quote: '"What do I have that can solve problems or create value?"',
                    focus: "Find your profitable purpose"
                },
                {
                    stage: 4,
                    name: "Activation",
                    dayRange: [40, 52],
                    leg: "üí∏ Money Moves",
                    quote: '"Done is better than perfect. Action creates clarity."',
                    focus: "Generate first entrepreneurial income"
                },
                {
                    stage: 5,
                    name: "Systemization",
                    dayRange: [53, 65],
                    leg: "‚öôÔ∏è Legacy Missions",
                    quote: '"I don\'t want to work harder‚ÄîI want to build a system that works for me."',
                    focus: "Build systems that work without you"
                },
                {
                    stage: 6,
                    name: "Expansion",
                    dayRange: [66, 78],
                    leg: "üåç Momentum Movement",
                    quote: '"I grow by helping others grow."',
                    focus: "Scale through teams and community"
                },
                {
                    stage: 7,
                    name: "Legacy",
                    dayRange: [79, 90],
                    leg: "üåç Momentum Movement",
                    quote: '"My purpose is to create systems that outlive me."',
                    focus: "Create generational impact"
                }
            ];

            for (const stageInfo of stages) {
                if (day >= stageInfo.dayRange[0] && day <= stageInfo.dayRange[1]) {
                    return stageInfo;
                }
            }

            // Default to stage 1 if out of range
            return stages[0];
        }

        // Update current stage display
        function updateCurrentStage() {
            const stageInfo = getCurrentStage(currentDay);

            document.getElementById('stageNumber').textContent = `Stage ${stageInfo.stage}`;
            document.getElementById('stageName').textContent = stageInfo.name;

            // Update subtitle if exists
            const subtitleEl = document.getElementById('stageSubtitle');
            if (subtitleEl) {
                subtitleEl.textContent = stageInfo.subtitle ? `- ${stageInfo.subtitle}` : '';
            }

            document.getElementById('stageLeg').textContent = stageInfo.leg;
            document.getElementById('stageQuote').textContent = stageInfo.quote;

            // Update header with stage info
            const lesson = getLessonByDay(currentDay);
            if (lesson) {
                document.getElementById('headerStatus').textContent =
                    `Day ${currentDay} ‚Ä¢ Stage ${stageInfo.stage}: ${stageInfo.name} ‚Ä¢ ${stageInfo.leg}`;
            } else {
                document.getElementById('headerStatus').textContent =
                    `Day ${currentDay} ‚Ä¢ Stage ${stageInfo.stage}: ${stageInfo.name}`;
            }

            // Show milestone celebration if completing a stage
            const isStageComplete = currentDay === stageInfo.dayRange[1];
            if (isStageComplete && !localStorage.getItem(`stage${stageInfo.stage}_celebrated`)) {
                setTimeout(() => {
                    const milestones = [
                        "üéâ Stage 1 Complete! You've Awakened!",
                        "üéâ Stage 2 Complete! Mind Reprogrammed!",
                        "üéâ Stage 3 Complete! Purpose Discovered!",
                        "üéâ Stage 4 Complete! First Income Generated!",
                        "üéâ Stage 5 Complete! Systems Built!",
                        "üéâ Stage 6 Complete! Team & Community Established!",
                        "üéâ Stage 7 Complete! Legacy Secured! YOU ARE AN ENTREPRENEUR!"
                    ];
                    addCoachMessage(`
                        <strong>${milestones[stageInfo.stage - 1]}</strong><br><br>
                        Congratulations! You've completed <strong>Stage ${stageInfo.stage}: ${stageInfo.name}</strong>.<br><br>
                        ${stageInfo.stage < 7 ? `üöÄ Ready for <strong>Stage ${stageInfo.stage + 1}</strong>? Let's keep building!` : 'üëë You did it! From employee to entrepreneur in 90 days. Welcome to your new life!'}
                    `);
                    localStorage.setItem(`stage${stageInfo.stage}_celebrated`, 'true');
                }, 2000);
            }
        }

        // Update journey day
        function updateJourneyDay() {
            document.getElementById('statsDay').textContent = `Day ${currentDay}`;
            updateCurrentStage(); // Update stage info
        }

        // Setup slider listeners
        function setupSliderListeners() {
            console.log('Setting up slider listeners...');

            const sliders = ['mindset', 'money', 'legacy', 'movement'];
            sliders.forEach(name => {
                const slider = document.getElementById(name + 'Slider');
                const value = document.getElementById(name + 'Value');
                if (slider && value) {
                    slider.oninput = () => {
                        value.textContent = slider.value;
                    };
                    console.log(`Slider ${name} initialized`);
                } else {
                    console.error(`Slider ${name} not found`);
                }
            });

            // Set up submit button with multiple methods
            console.log('Setting up submit button...');
            const submitBtn = document.getElementById('submitAssessmentBtn');
            if (submitBtn) {
                // Remove any existing listeners
                const newBtn = submitBtn.cloneNode(true);
                submitBtn.parentNode.replaceChild(newBtn, submitBtn);

                // Add click listener
                newBtn.addEventListener('click', function(e) {
                    console.log('=== SUBMIT BUTTON CLICKED ===');
                    e.stopPropagation();
                    handleAssessmentSubmit();
                }, true);

                // Add mousedown listener as backup
                newBtn.addEventListener('mousedown', function(e) {
                    console.log('Submit button mousedown');
                }, true);

                console.log('Submit button listeners attached');
            } else {
                console.error('Submit button not found!');
            }
        }

        // Separate handler function
        function handleAssessmentSubmit() {
            console.log('handleAssessmentSubmit called');

            // Get values
            const mindsetVal = document.getElementById('mindsetSlider')?.value || 50;
            const moneyVal = document.getElementById('moneySlider')?.value || 50;
            const legacyVal = document.getElementById('legacySlider')?.value || 50;
            const movementVal = document.getElementById('movementSlider')?.value || 50;

            console.log('Values:', {mindsetVal, moneyVal, legacyVal, movementVal});

            // Create scores object
            const scores = {
                mindset: parseInt(mindsetVal),
                money: parseInt(moneyVal),
                legacy: parseInt(legacyVal),
                movement: parseInt(movementVal),
                date: new Date().toISOString(),
                day: currentDay
            };

            // Update global variable
            btssScores = scores;

            // Save
            localStorage.setItem('coach_btss_scores', JSON.stringify(scores));

            // Add to history
            btssHistory.push(scores);
            localStorage.setItem('coach_btss_history', JSON.stringify(btssHistory));

            console.log('Assessment saved:', scores);

            // Update UI
            loadBTSSScores();

            // Close modal
            closeAssessment();

            // Calculate overall
            const overall = Math.round((scores.mindset + scores.money + scores.legacy + scores.movement) / 4);

            // Get weakest leg
            const legs = [
                { name: 'Mindset Mystery', score: scores.mindset },
                { name: 'Money Moves', score: scores.money },
                { name: 'Legacy Missions', score: scores.legacy },
                { name: 'Momentum Movement', score: scores.movement }
            ];
            const weakestLeg = legs.reduce((min, leg) => leg.score < min.score ? leg : min, legs[0]);

            // Send message
            const message = `
                <strong>BTSS Assessment Complete! üéØ</strong><br><br>
                <strong>Your Scores:</strong><br>
                üß† Mindset Mystery: ${scores.mindset}/100<br>
                üí∏ Money Moves: ${scores.money}/100<br>
                ‚öôÔ∏è Legacy Missions: ${scores.legacy}/100<br>
                üåç Momentum Movement: ${scores.movement}/100<br><br>
                <strong>Overall BTSS: ${overall}%</strong><br>
                Your weakest leg is <strong>${weakestLeg.name}</strong>. Remember: a table is only as strong as its weakest leg! Let's focus on strengthening this area to build your billion-dollar empire. üí™
            `;

            addCoachMessage(message);

            console.log('Assessment complete!');
        }

        // Load BTSS scores
        function loadBTSSScores() {
            if (!btssScores) return;

            document.getElementById('mindsetScore').textContent = btssScores.mindset;
            document.getElementById('moneyScore').textContent = btssScores.money;
            document.getElementById('legacyScore').textContent = btssScores.legacy;
            document.getElementById('movementScore').textContent = btssScores.movement;

            document.getElementById('mindsetBar').style.width = btssScores.mindset + '%';
            document.getElementById('moneyBar').style.width = btssScores.money + '%';
            document.getElementById('legacyBar').style.width = btssScores.legacy + '%';
            document.getElementById('movementBar').style.width = btssScores.movement + '%';

            const overall = Math.round((btssScores.mindset + btssScores.money + btssScores.legacy + btssScores.movement) / 4);
            document.getElementById('statsOverall').textContent = overall + '%';
        }

        // Open assessment
        function openAssessment() {
            document.getElementById('assessmentModal').classList.add('show');
        }

        // Close assessment
        function closeAssessment() {
            document.getElementById('assessmentModal').classList.remove('show');
        }

        // Submit assessment
        function submitAssessment() {
            try {
                console.log('submitAssessment called');

                // Get slider elements
                const mindsetSlider = document.getElementById('mindsetSlider');
                const moneySlider = document.getElementById('moneySlider');
                const legacySlider = document.getElementById('legacySlider');
                const movementSlider = document.getElementById('movementSlider');

                // Check if elements exist
                if (!mindsetSlider || !moneySlider || !legacySlider || !movementSlider) {
                    console.error('One or more sliders not found!');
                    alert('Error: Assessment sliders not found. Please refresh the page and try again.');
                    return;
                }

                // Get values
                btssScores = {
                    mindset: parseInt(mindsetSlider.value),
                    money: parseInt(moneySlider.value),
                    legacy: parseInt(legacySlider.value),
                    movement: parseInt(movementSlider.value),
                    date: new Date().toISOString(),
                    day: currentDay
                };

                console.log('BTSS Scores:', btssScores);

                // Validate scores
                if (isNaN(btssScores.mindset) || isNaN(btssScores.money) || isNaN(btssScores.legacy) || isNaN(btssScores.movement)) {
                    console.error('Invalid scores detected');
                    alert('Error: Invalid assessment values. Please try again.');
                    return;
                }

                // Save current scores
                localStorage.setItem('coach_btss_scores', JSON.stringify(btssScores));

                // Add to history
                btssHistory.push(btssScores);
                localStorage.setItem('coach_btss_history', JSON.stringify(btssHistory));

                console.log('Assessment saved successfully');

                // Update UI
                loadBTSSScores();
                closeAssessment();

                // Send confirmation message
                const overall = Math.round((btssScores.mindset + btssScores.money + btssScores.legacy + btssScores.movement) / 4);
                const weakest = getWeakestLeg();

                // Check for improvement if previous assessment exists
                let improvementMsg = '';
                if (btssHistory.length > 1) {
                    const previous = btssHistory[btssHistory.length - 2];
                    const prevOverall = Math.round((previous.mindset + previous.money + previous.legacy + previous.movement) / 4);
                    const improvement = overall - prevOverall;
                    if (improvement > 0) {
                        improvementMsg = `<br><strong>üìà You've improved ${improvement} points since your last assessment!</strong><br>`;
                    }
                }

                addCoachMessage(`
                    <strong>BTSS Assessment Complete! üéØ</strong><br><br>
                    <strong>Your Scores:</strong><br>
                    üß† Mindset Mystery: ${btssScores.mindset}/100<br>
                    üí∏ Money Moves: ${btssScores.money}/100<br>
                    ‚öôÔ∏è Legacy Missions: ${btssScores.legacy}/100<br>
                    üåç Momentum Movement: ${btssScores.movement}/100<br><br>
                    <strong>Overall BTSS: ${overall}%</strong>${improvementMsg}<br>
                    Your weakest leg is <strong>${weakest.name}</strong>. Remember: a table is only as strong as its weakest leg! Let's focus on strengthening this area to build your billion-dollar empire. üí™
                `);

                console.log('Assessment message added to chat');

            } catch (error) {
                console.error('Error in submitAssessment:', error);
                alert('An error occurred while submitting the assessment: ' + error.message + '\n\nPlease try again or refresh the page.');
            }
        }

        // Get weakest leg
        function getWeakestLeg() {
            if (!btssScores) return null;
            const legs = [
                { name: 'Mindset Mystery', score: btssScores.mindset, icon: 'üß†' },
                { name: 'Money Moves', score: btssScores.money, icon: 'üí∏' },
                { name: 'Legacy Missions', score: btssScores.legacy, icon: '‚öôÔ∏è' },
                { name: 'Momentum Movement', score: btssScores.movement, icon: 'üåç' }
            ];
            return legs.reduce((min, leg) => leg.score < min.score ? leg : min);
        }

        // Show settings
        function showSettings() {
            document.getElementById('settingsModal').classList.add('show');
        }

        // Close settings
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        // Open Activity Center
        function openActivity() {
            document.getElementById('activityModal').classList.add('show');
        }

        // Close Activity Center
        function closeActivity() {
            document.getElementById('activityModal').classList.remove('show');
        }

        // Submit Activity Response
        function submitActivityResponse() {
            const response = document.getElementById('activityResponseInput').value.trim();

            if (!response) {
                alert('Please enter your response before submitting.');
                return;
            }

            // Here you would normally send to Coach Manlaw AI for feedback
            console.log('Activity Response:', response);

            // Show success message
            alert('‚úÖ Response submitted successfully!\n\nCoach Manlaw will review your activity and provide personalized feedback.');

            // Clear the input
            document.getElementById('activityResponseInput').value = '';

            // Close modal
            closeActivity();

            // You could also send this to the chat as a message to Coach Manlaw
            sendMessage('Activity Response: ' + response);
        }

        // Save settings
        function saveSettings() {
            const apiKey = document.getElementById('claudeKey').value.trim();
            const model = document.getElementById('aiModel').value;

            if (apiKey) {
                localStorage.setItem('coach_api_key', apiKey);
            }
            localStorage.setItem('coach_ai_model', model);

            alert('‚úÖ Settings saved!');
            closeSettings();
        }

        // Load settings
        function loadSettings() {
            const apiKey = localStorage.getItem('coach_api_key');
            const model = localStorage.getItem('coach_ai_model') || 'claude-sonnet-4-20250514';

            if (apiKey) {
                document.getElementById('claudeKey').value = apiKey;
            }
            document.getElementById('aiModel').value = model;
        }

        // Get current time
        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        // Add message
        function addMessage(text, isUser = false) {
            const message = document.createElement('div');
            message.className = `message ${isUser ? 'user' : 'coach'}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = isUser ? 'üë§' : 'üéØ';

            const content = document.createElement('div');
            content.className = 'message-content';
            content.innerHTML = `
                <div class="message-text">${text}</div>
                <div class="message-time">${getCurrentTime()}</div>
            `;

            if (isUser) {
                message.appendChild(content);
                message.appendChild(avatar);
            } else {
                message.appendChild(avatar);
                message.appendChild(content);
            }

            const chatMessages = document.getElementById('chatMessages');
            const typingIndicator = document.getElementById('typingIndicator');
            chatMessages.insertBefore(message, typingIndicator);
            scrollToBottom();

            // Save to history
            chatHistory.push({
                text,
                isUser,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('coach_chat_history', JSON.stringify(chatHistory));
        }

        // Add coach message (shorthand)
        function addCoachMessage(text) {
            addMessage(text, false);
        }

        // Scroll to bottom
        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Show typing indicator
        function showTyping() {
            document.getElementById('typingIndicator').classList.add('active');
            scrollToBottom();
        }

        // Hide typing indicator
        function hideTyping() {
            document.getElementById('typingIndicator').classList.remove('active');
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text) return;

            // SECURITY: API key is now handled server-side, no client-side check needed

            // Add user message
            addMessage(text, true);
            input.value = '';

            // Show typing
            showTyping();
            document.getElementById('sendBtn').disabled = true;

            try {
                // Build context
                const systemPrompt = buildSystemPrompt();
                // SECURITY: API key parameter no longer needed - handled by backend
                const response = await callClaudeAPI(systemPrompt, text, null);

                hideTyping();
                addCoachMessage(response);

            } catch (error) {
                hideTyping();
                addCoachMessage(`Sorry, I encountered an error: ${error.message}. Please check your API key and try again.`);
            }

            document.getElementById('sendBtn').disabled = false;
            input.focus();
        }

        // Build system prompt
        function buildSystemPrompt() {
            const weakest = btssScores ? getWeakestLeg() : null;
            const overall = btssScores ? Math.round((btssScores.mindset + btssScores.money + btssScores.legacy + btssScores.movement) / 4) : null;
            const currentLesson = getLessonByDay(currentDay);
            const lessonsCompleted = completedLessons.length;
            const completionRate = Math.round((lessonsCompleted / 75) * 100);

            // Get app recommendation for current lesson
            let appRecommendation = '';
            if (currentLesson && currentLesson.appConnection) {
                appRecommendation = `\n- Recommended App for Today: ${currentLesson.appConnection.app} - ${currentLesson.appConnection.how}`;
            }

            return `You are Coach Manlaw, a powerhouse AI billionaire coach for the Zero2Billionaires (Z2B) platform.

CURRENT CURRICULUM CONTEXT:
${currentLesson ? `
- Current Day: ${currentDay} of 90
- Current Lesson: "${currentLesson.title}"
- Week ${currentLesson.week}: ${currentLesson.theme}
- Phase: ${currentLesson.phaseTitle}
- Focus Area: ${currentLesson.btssImpact.toUpperCase()}
- Today's Content: ${currentLesson.content.substring(0, 150)}...
- Today's Activity: ${currentLesson.activity}
- Today's Assignment: ${currentLesson.assignment}${appRecommendation}
- Lessons Completed: ${lessonsCompleted}/75 (${completionRate}% of program)
` : '- No curriculum loaded yet'}

IMPORTANT: You are teaching a structured 90-day transformation program. Always be aware of:
1. What day the member is on in their journey
2. What lesson they're currently working on
3. Whether they've completed today's activity and assignment
4. Which phase and leg of the table they're focusing on
5. How their progress aligns with the curriculum

When coaching:
- Reference their current lesson naturally in conversation
- Encourage them to complete today's activity/assignment if they haven't
- Connect their questions to the current curriculum focus
- Remind them of app recommendations when relevant
- Celebrate milestones (Day 20, 35, 50, 65, 75)
- If they seem stuck, suggest reviewing or completing the current day's lesson before moving ahead

YOUR PERSONALITY FRAMEWORK (Coach Manlaw DNA):
- 15% Biblical Principles - Grounded wisdom from Proverbs, Matthew, Philippians. Faith as foundation, not just motivation.
- 10% Humor & Wit - Lighthearted observations that cut through overwhelm. Make success feel attainable and fun.
- 25% Deep Psychology - Understanding human behavior, habits, beliefs, and mental models. Master of mindset transformation.
- 25% Visionary Leadership - Painting billion-dollar futures. Helping Legacy Builders see 10x beyond their current vision.
- 25% Strategic Business Execution - No fluff. Actionable steps, systems, frameworks, and tactical moves that generate results.

YOUR MISSION:
Transform employees into Legacy Builders who build Billionaire Mindsets, Money Systems, Movements, and Legacies using the Four Legs of a Billionaire Table framework.

THE FOUR LEGS:
1. üß† Mindset Mystery - Identity transformation, belief systems, vision clarity, spiritual alignment, mental wealth
2. üí∏ Money Moves - Financial intelligence, multiple income streams, wealth multiplication, marketing mastery, sales systems
3. ‚öôÔ∏è Legacy Missions - Scalable systems, automation, purpose-driven business, delegation, time leverage, management excellence
4. üåç Momentum Movement - Impact creation, influence amplification, community building, leadership development, movement creation

USER CONTEXT:
${btssScores ? `
- Current BTSS Scores:
  ‚Ä¢ Mindset Mystery: ${btssScores.mindset}/100
  ‚Ä¢ Money Moves: ${btssScores.money}/100
  ‚Ä¢ Legacy Missions: ${btssScores.legacy}/100
  ‚Ä¢ Momentum Movement: ${btssScores.movement}/100
- Overall BTSS: ${overall}%
- Weakest Leg: ${weakest.name} (${weakest.score}/100) ‚Üê PRIORITY FOCUS
` : '- No BTSS assessment yet (encourage them to take it!)'}

COACHING STYLE:
- Speak with warmth, authority, and wit (2-3 concise paragraphs)
- Use emojis strategically for emphasis
- Blend Biblical wisdom seamlessly with business strategy
- Challenge limiting beliefs with compassion + humor
- Provide specific, actionable tactical steps (not just inspiration)
- Celebrate small wins like they're billion-dollar victories
- Focus 60% of coaching on strengthening the weakest leg
- Drop Scripture naturally when it fits (Proverbs for wisdom, Matthew for mission, Philippians for mindset)
- Be conversational, not corporate. Be mentor, not machine.

COMMUNICATION PATTERNS:
- Start responses with affirmation or light humor
- Use analogies and stories to illustrate complex concepts
- Ask provocative questions that trigger breakthrough thinking
- Give 1-3 specific action steps in every response
- End with empowering statement or challenge

CORE PHILOSOPHY:
"I am a Legacy Builder, You are a Legacy Builder, and Together we are Builders of Legacies."

KEY PRINCIPLES:
- You must be rich in thought before you're rich in bank balance
- Don't chase money‚Äîbuild systems that multiply it while you sleep
- Your weakest leg determines your table's stability‚Äîfix it first
- Every employee has a billionaire inside‚Äîwake them up
- When mission becomes movement, influence becomes infinite
- Legacy isn't what you build‚Äîit's what outlives you

TACTICAL FRAMEWORKS TO REFERENCE:
- BTSS Assessment (measure before you manage)
- Four Income Streams Model (earned, profit, passive, portfolio)
- 80/20 Delegation Framework (automate/delegate 80%, focus on 20%)
- Network Effect Multiplication (1 person ‚Üí 10 ‚Üí 100 ‚Üí 1000)
- Faith-Driven Decision Matrix (alignment + strategy = unstoppable)

Respond as Coach Manlaw would - sharp, strategic, faith-filled, funny when appropriate, and always actionable!`;
        }

        // Call AI API via backend proxy (prevents CORS issues)
        async function callClaudeAPI(systemPrompt, userMessage, apiKey) {
            try {
                // SECURITY: Use Railway backend - API key is handled server-side
                const API_BASE_URL = 'https://z2b-production-3cd3.up.railway.app/api';
                const proxyUrl = `${API_BASE_URL}/coach/chat`;

                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        // SECURITY: API key NOT sent from frontend - handled by backend
                        systemPrompt: systemPrompt,
                        userMessage: userMessage
                    })
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({ error: 'API request failed' }));
                    throw new Error(error.error || 'API request failed');
                }

                const data = await response.json();

                if (data.content && data.content[0] && data.content[0].text) {
                    return data.content[0].text.trim();
                } else {
                    throw new Error('Invalid response from AI service');
                }

            } catch (error) {
                console.error('AI service error:', error);
                throw error;
            }
        }

        // Send quick message
        function sendQuickMessage(text) {
            document.getElementById('messageInput').value = text;
            sendMessage();
        }

        // Handle key press
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // ===== AUDIO & VIDEO LEARNING MODES =====

        // Set learning mode
        function setLearningMode(mode) {
            // Check tier access
            if (mode === 'listen' && !canAccessAudio()) {
                showUpgradeNudge('Audio Learning Mode', 'Copper');
                return;
            }

            if (mode === 'watch' && !canAccessVideo()) {
                showUpgradeNudge('Video Learning Mode', 'Silver');
                return;
            }

            learningMode = mode;
            localStorage.setItem('coach_learning_mode', mode);

            // Update button styles
            ['read', 'listen', 'watch'].forEach(m => {
                const btn = document.getElementById('mode' + m.charAt(0).toUpperCase() + m.slice(1));
                if (m === mode) {
                    btn.style.background = 'linear-gradient(135deg, var(--gold), var(--orange))';
                    btn.style.color = 'var(--navy-blue)';
                } else {
                    btn.style.background = '';
                    btn.style.color = '';
                }
            });

            // Show/hide relevant sections
            const contentSections = ['modalLessonContent', 'modalLessonActivity', 'modalLessonAssignment'];
            const audioPlayer = document.getElementById('audioPlayer');
            const videoPlayer = document.getElementById('videoPlayer');

            if (mode === 'read') {
                contentSections.forEach(id => document.getElementById(id).closest('.assessment-item').style.display = 'block');
                audioPlayer.style.display = 'none';
                videoPlayer.style.display = 'none';
                stopAudio();
                stopAnimation();
            } else if (mode === 'listen') {
                // Show BOTH content and audio player so user can read while listening
                contentSections.forEach(id => document.getElementById(id).closest('.assessment-item').style.display = 'block');
                audioPlayer.style.display = 'block';
                videoPlayer.style.display = 'none';
                stopAnimation();
                prepareAudio();
            } else if (mode === 'watch') {
                contentSections.forEach(id => document.getElementById(id).closest('.assessment-item').style.display = 'none');
                audioPlayer.style.display = 'none';
                videoPlayer.style.display = 'block';
                stopAudio();
                startAnimation();
            }
        }

        // Helper function to strip HTML tags from text
        function stripHtmlTags(html) {
            if (!html) return '';
            // Create a temporary element to parse HTML
            const temp = document.createElement('div');
            temp.innerHTML = html;
            // Get text content without HTML tags
            return temp.textContent || temp.innerText || '';
        }

        // Prepare audio for lesson
        function prepareAudio() {
            const lesson = getLessonByDay(currentDay);
            if (!lesson) return;

            console.log('üéµ Preparing audio for lesson:', lesson.title);

            // Get current stage info for context
            const stageInfo = getCurrentStage(currentDay);
            const overview = getStageOverview(stageInfo.stage);

            // Build stage overview narration (clean text)
            const stageOverviewText = `
                ${stripHtmlTags(overview.legPhase)}.
                Stage ${stageInfo.stage}: ${stripHtmlTags(stageInfo.name)}. ${stripHtmlTags(stageInfo.quote)}
                ${stripHtmlTags(overview.description)}
                Focus: ${stripHtmlTags(overview.focus)}
            `;

            // Combine lesson text with stage context and overview (EXCLUDING activity and assignment)
            // Strip all HTML tags for clean audio
            const fullText = `
                Welcome to Day ${currentDay} of your 90-day transformation journey.

                Let me remind you where you are in your transformation:
                ${stageOverviewText}

                Today's lesson: ${stripHtmlTags(lesson.title)}.

                ${stripHtmlTags(lesson.content)}

                This is the end of today's lesson. Now, test your understanding with the comprehension check, then complete the activity and assignment below to progress to the next lesson in your transformation journey. Understanding comes before action, Legacy Builder!
            `;

            currentUtterance = new SpeechSynthesisUtterance(fullText);

            // Restore user's preferred speed or use default
            const savedSpeed = parseFloat(localStorage.getItem('coach_audio_speed')) || 0.9;
            currentUtterance.rate = savedSpeed;
            currentUtterance.pitch = 1.0;
            currentUtterance.volume = 1.0;

            // Update speed display
            const speedDisplay = document.getElementById('speedDisplay');
            if (speedDisplay) {
                speedDisplay.textContent = savedSpeed + 'x';
            }

            console.log('üéµ Audio speed set to:', savedSpeed + 'x');

            // Initialize audio timing
            audioTotalChars = fullText.length;
            audioCurrentChar = 0;
            audioEstimatedDuration = estimateAudioDuration(audioTotalChars, savedSpeed);

            // Update initial time display
            const timeEl = document.getElementById('audioTime');
            if (timeEl) {
                timeEl.textContent = `0:00 / ${formatTime(audioEstimatedDuration)}`;
            }

            console.log(`üìä Estimated duration: ${formatTime(audioEstimatedDuration)} (${audioTotalChars} characters)`);

            // Wait for voices to load and select based on user preference
            let voiceSelected = false;

            const selectBestVoice = () => {
                const voices = speechSynthesis.getVoices();
                console.log('üé§ Available voices:', voices.length);

                if (voices.length > 0 && !voiceSelected) {
                    // Log all available voices for debugging
                    console.log('üåç All voices:', voices.map(v => `${v.name} (${v.lang})`).join(', '));

                    let preferredVoice = null;

                    // Select voice based on user preference
                    if (selectedVoiceType === 'luke') {
                        // Luke - South African male voice
                        preferredVoice =
                            voices.find(v => v.name.includes('Luke') && v.lang.startsWith('en')) ||
                            voices.find(v => v.lang === 'en-ZA' && !v.name.toLowerCase().includes('female')) ||
                            voices.find(v => v.lang === 'en-ZA') ||
                            voices.find(v => v.name.includes('Thabo') && v.lang.startsWith('en')) ||
                            voices.find(v => v.name.includes('Google UK English Male')) ||
                            voices.find(v => v.name.includes('Microsoft David')) ||
                            voices.find(v => v.lang.startsWith('en-GB'));

                        console.log('üé§ Luke voice mode selected');
                    } else if (selectedVoiceType === 'female') {
                        // Female - South African/African female voice
                        preferredVoice =
                            voices.find(v => v.lang === 'en-ZA' && v.name.toLowerCase().includes('female')) ||
                            voices.find(v => v.name.includes('Ayanda') && v.lang.startsWith('en')) ||
                            voices.find(v => v.name.includes('Lerato') && v.lang.startsWith('en')) ||
                            voices.find(v => v.name.includes('Google UK English Female')) ||
                            voices.find(v => v.name.includes('Microsoft Zira')) ||
                            voices.find(v => v.name.includes('Microsoft Hazel')) ||
                            voices.find(v => v.lang.startsWith('en-GB') && v.name.toLowerCase().includes('female')) ||
                            voices.find(v => v.lang.startsWith('en') && v.name.toLowerCase().includes('female'));

                        console.log('üé§ Female voice (Ayanda) mode selected');
                    } else if (selectedVoiceType === 'manlaw') {
                        // ZYNTH cloned voice - check if available, otherwise fallback to Luke
                        const zynthVoice = localStorage.getItem('zynth_profile_complete');

                        if (zynthVoice === 'true') {
                            console.log('üé§ ZYNTH cloned voice available - will use for generation');
                            isUsingZynthVoice = true;
                            // Note: ZYNTH voice will be used via backend, but we still need a voice for browser TTS fallback
                        } else {
                            console.log('‚ö†Ô∏è ZYNTH voice not available - using Luke as fallback');
                            isUsingZynthVoice = false;
                        }

                        // Fallback to Luke for browser TTS
                        preferredVoice =
                            voices.find(v => v.name.includes('Luke') && v.lang.startsWith('en')) ||
                            voices.find(v => v.lang === 'en-ZA' && !v.name.toLowerCase().includes('female')) ||
                            voices.find(v => v.name.includes('Thabo') && v.lang.startsWith('en')) ||
                            voices.find(v => v.name.includes('Google UK English Male')) ||
                            voices.find(v => v.lang.startsWith('en-GB'));
                    }

                    // Apply preferred voice or fallback
                    if (preferredVoice) {
                        currentUtterance.voice = preferredVoice;
                        console.log('‚úÖ Selected voice:', preferredVoice.name, '(' + preferredVoice.lang + ')');
                        voiceSelected = true;
                    } else {
                        // Last resort fallback
                        const fallbackVoice = voices.find(v => v.lang.startsWith('en'));
                        if (fallbackVoice) {
                            currentUtterance.voice = fallbackVoice;
                            console.log('‚ö†Ô∏è Using fallback voice:', fallbackVoice.name);
                            voiceSelected = true;
                        } else {
                            console.log('‚ö†Ô∏è No voice found, using system default');
                        }
                    }
                }
            };

            // Try to select voice immediately
            selectBestVoice();

            // If voices aren't loaded yet, wait for them
            if (speechSynthesis.getVoices().length === 0) {
                speechSynthesis.onvoiceschanged = selectBestVoice;
            }

            // Update progress during playback
            currentUtterance.onboundary = (event) => {
                // Track current character position
                audioCurrentChar = event.charIndex;

                // Update progress bar
                const progress = (event.charIndex / fullText.length) * 100;
                const progressBar = document.getElementById('audioProgressBar');
                if (progressBar) {
                    progressBar.style.width = progress + '%';
                }

                // Update handle position
                const handle = document.getElementById('audioProgressHandle');
                if (handle) {
                    handle.style.left = progress + '%';
                }
            };

            currentUtterance.onstart = () => {
                console.log('üéµ Audio playback started');
                isAudioPlaying = true;
                audioStartTime = Date.now();

                // Start progress interval for time updates
                if (audioProgressInterval) {
                    clearInterval(audioProgressInterval);
                }
                audioProgressInterval = setInterval(updateAudioTime, 500); // Update every 500ms

                // Initial time update
                updateAudioTime();
            };

            currentUtterance.onend = () => {
                console.log('üéµ Audio playback ended');
                isAudioPlaying = false;

                // Clear progress interval
                if (audioProgressInterval) {
                    clearInterval(audioProgressInterval);
                    audioProgressInterval = null;
                }

                const playBtn = document.getElementById('playPauseBtn');
                const progressBar = document.getElementById('audioProgressBar');
                const progressText = document.getElementById('audioProgress');
                const timeDisplay = document.getElementById('audioTime');

                if (playBtn) playBtn.innerHTML = '<i class="fas fa-play"></i>';
                if (progressBar) progressBar.style.width = '100%';
                if (progressText) progressText.textContent = 'Completed!';
                if (timeDisplay) timeDisplay.textContent = `${formatTime(audioEstimatedDuration)} / ${formatTime(audioEstimatedDuration)}`;

                // Reset after a moment
                setTimeout(() => {
                    if (progressBar) progressBar.style.width = '0%';
                    if (progressText) progressText.textContent = 'Ready to play';
                    if (timeDisplay) timeDisplay.textContent = `0:00 / ${formatTime(audioEstimatedDuration)}`;
                }, 2000);
            };

            currentUtterance.onerror = (event) => {
                console.error('‚ùå Audio error:', event.error);
                alert('Audio playback error: ' + event.error);
                isAudioPlaying = false;
                const playBtn = document.getElementById('playPauseBtn');
                if (playBtn) playBtn.innerHTML = '<i class="fas fa-play"></i>';
            };

            console.log('‚úÖ Audio prepared successfully');
        }

        // Toggle audio play/pause
        function toggleAudio() {
            console.log('üéµ Toggle audio called, current state:', isAudioPlaying);

            // Prepare audio if not yet prepared
            if (!currentUtterance) {
                console.log('üìù Preparing audio for first time...');
                prepareAudio();

                // Give it a moment to prepare
                setTimeout(() => {
                    if (currentUtterance) {
                        speechSynthesis.speak(currentUtterance);
                        isAudioPlaying = true;
                        document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-pause"></i>';
                    }
                }, 100);
                return;
            }

            if (isAudioPlaying) {
                // Pause
                console.log('‚è∏Ô∏è Pausing audio...');
                speechSynthesis.pause();
                isAudioPlaying = false;
                document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-play"></i>';
            } else {
                // Resume or play
                if (speechSynthesis.paused) {
                    console.log('‚ñ∂Ô∏è Resuming audio...');
                    speechSynthesis.resume();
                } else {
                    console.log('‚ñ∂Ô∏è Starting audio...');
                    speechSynthesis.speak(currentUtterance);
                }
                isAudioPlaying = true;
                document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-pause"></i>';
            }
        }

        // Stop audio
        function stopAudio() {
            console.log('üõë Stopping audio...');
            if (speechSynthesis.speaking || speechSynthesis.pending) {
                speechSynthesis.cancel();
            }
            isAudioPlaying = false;
            currentUtterance = null; // Clear utterance
            if (document.getElementById('playPauseBtn')) {
                document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-play"></i>';
            }
            if (document.getElementById('audioProgressBar')) {
                document.getElementById('audioProgressBar').style.width = '0%';
            }
            if (document.getElementById('audioProgress')) {
                document.getElementById('audioProgress').textContent = 'Ready to play';
            }
            if (document.getElementById('audioTime')) {
                document.getElementById('audioTime').textContent = '0:00 / 0:00';
            }

            // Clear progress interval
            if (audioProgressInterval) {
                clearInterval(audioProgressInterval);
                audioProgressInterval = null;
            }

            // Reset audio timing
            audioCurrentChar = 0;
            audioStartTime = 0;
        }

        // Format seconds to MM:SS
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Estimate audio duration based on text length and speech rate
        function estimateAudioDuration(textLength, rate = 0.9) {
            // Average speaking rate is ~150 words per minute at 1.0x speed
            // Adjust for speech rate
            const wordsPerMinute = 150 * rate;
            const charsPerWord = 5; // Average
            const words = textLength / charsPerWord;
            const durationMinutes = words / wordsPerMinute;
            return durationMinutes * 60; // Convert to seconds
        }

        // Update time display during playback
        function updateAudioTime() {
            if (!isAudioPlaying || !audioTotalChars) return;

            const elapsed = (Date.now() - audioStartTime) / 1000;
            const progress = (audioCurrentChar / audioTotalChars) * 100;
            const estimatedElapsed = (audioEstimatedDuration * progress) / 100;
            const remaining = Math.max(0, audioEstimatedDuration - estimatedElapsed);

            // Update time display
            const timeEl = document.getElementById('audioTime');
            if (timeEl) {
                timeEl.textContent = `${formatTime(estimatedElapsed)} / ${formatTime(audioEstimatedDuration)}`;
            }

            // Update progress text
            const progressEl = document.getElementById('audioProgress');
            if (progressEl) {
                progressEl.textContent = `Playing... ${Math.round(progress)}%`;
            }

            // Show/hide progress handle
            const handle = document.getElementById('audioProgressHandle');
            if (handle) {
                handle.style.opacity = progress > 0 ? '1' : '0';
            }
        }

        // Seek to position (not fully supported by Speech Synthesis API, but we try)
        function seekAudio(event) {
            // Note: Web Speech API doesn't support true seeking
            // This is a visual-only feature for now
            alert('Seeking is not supported by the browser speech engine.\n\nYou can use the speed controls to adjust playback pace.');
        }

        // Voice selection variables
        let selectedVoiceType = localStorage.getItem('coach_voice_type') || 'manlaw'; // 'manlaw', 'luke', 'female'
        let isUsingZynthVoice = false;

        // Select voice type
        function selectVoice(voiceType) {
            console.log('üé§ Selecting voice:', voiceType);

            selectedVoiceType = voiceType;
            localStorage.setItem('coach_voice_type', voiceType);

            // Update button styles
            const buttons = {
                'manlaw': document.getElementById('voiceManlaw'),
                'luke': document.getElementById('voiceLuke'),
                'female': document.getElementById('voiceFemale')
            };

            // Reset all buttons
            Object.keys(buttons).forEach(key => {
                if (buttons[key]) {
                    buttons[key].style.background = 'rgba(255,255,255,0.1)';
                    buttons[key].style.borderColor = 'rgba(255,255,255,0.2)';
                }
            });

            // Highlight selected button
            if (buttons[voiceType]) {
                buttons[voiceType].style.background = 'linear-gradient(135deg, var(--cyber-purple), #9347E0)';
                buttons[voiceType].style.borderColor = 'var(--cyber-purple)';
            }

            // Update status text
            const statusText = document.getElementById('voiceStatusText');
            if (statusText) {
                const statusMessages = {
                    'manlaw': 'Using ZYNTH cloned voice (Manlaw)',
                    'luke': 'Using Luke (South African male voice)',
                    'female': 'Using Ayanda (South African female voice)'
                };
                statusText.textContent = statusMessages[voiceType] || 'Voice selected';
            }

            // Update intro button text
            updateIntroButtonText();

            // If audio is currently playing, stop and reprepare with new voice
            if (isAudioPlaying || currentUtterance) {
                stopAudio();
                alert(`Voice changed to ${voiceType === 'manlaw' ? 'ZYNTH Manlaw' : voiceType === 'luke' ? 'Luke' : 'Ayanda'}!\n\nClick play to hear the lesson in the new voice.`);
            }
        }

        // Initialize voice selection on page load
        function initializeVoiceSelection() {
            // Set initial button state
            selectVoice(selectedVoiceType);

            // Update intro button text
            updateIntroButtonText();
        }

        // Update intro button text based on selected voice
        function updateIntroButtonText() {
            const introText = document.getElementById('introAudioText');
            if (introText) {
                const voiceNames = {
                    'manlaw': 'Listen to Introduction (Manlaw ZYNTH)',
                    'luke': 'Listen to Introduction (Luke)',
                    'female': 'Listen to Introduction (Ayanda)'
                };
                introText.textContent = voiceNames[selectedVoiceType] || 'Listen to Introduction';
            }
        }

        // Set audio playback speed
        function setAudioSpeed(speed) {
            console.log('‚ö° Setting audio speed to:', speed);

            // Update display
            const speedDisplay = document.getElementById('speedDisplay');
            if (speedDisplay) {
                speedDisplay.textContent = speed + 'x';
            }

            // Update current utterance if it exists
            if (currentUtterance) {
                const wasPlaying = isAudioPlaying;

                // Stop current playback
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                }

                // Update rate
                currentUtterance.rate = speed;

                // Resume if it was playing
                if (wasPlaying) {
                    setTimeout(() => {
                        speechSynthesis.speak(currentUtterance);
                        isAudioPlaying = true;
                        document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-pause"></i>';
                    }, 100);
                }
            }

            // Save preference
            localStorage.setItem('coach_audio_speed', speed);

            // Update button styles
            const buttons = document.querySelectorAll('#audioPlayer button[onclick^="setAudioSpeed"]');
            buttons.forEach(btn => {
                const btnSpeed = parseFloat(btn.textContent);
                if (btnSpeed === speed) {
                    btn.style.background = 'linear-gradient(135deg, var(--gold), var(--orange))';
                    btn.style.color = 'var(--navy-blue)';
                    btn.style.border = 'none';
                    btn.style.fontWeight = '600';
                } else {
                    btn.style.background = 'rgba(255,255,255,0.1)';
                    btn.style.color = 'white';
                    btn.style.border = '1px solid rgba(255,255,255,0.2)';
                    btn.style.fontWeight = 'normal';
                }
            });

            console.log('‚úÖ Audio speed set successfully');
        }

        // Start animated lesson presentation
        function startAnimation() {
            const lesson = getLessonByDay(currentDay);
            if (!lesson) return;

            animationPaused = false;
            const container = document.getElementById('animatedLesson');

            // Create animated slides
            const slides = [
                { type: 'title', content: `Day ${currentDay}`, subtext: lesson.title, duration: 3000 },
                { type: 'text', content: lesson.content, duration: 8000 },
                { type: 'activity', content: lesson.activity, duration: 6000 },
                { type: 'assignment', content: lesson.assignment, duration: 6000 },
                { type: 'complete', content: 'Lesson Complete!', subtext: 'Mark as complete when ready', duration: 3000 }
            ];

            let currentSlide = 0;

            function showSlide() {
                if (animationPaused) return;

                const slide = slides[currentSlide];
                container.innerHTML = '';

                if (slide.type === 'title') {
                    container.innerHTML = `
                        <div style="animation: fadeInUp 1s ease;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">${lesson.phaseTitle.includes('üß†') ? 'üß†' : lesson.phaseTitle.includes('üí∏') ? 'üí∏' : lesson.phaseTitle.includes('‚öôÔ∏è') ? '‚öôÔ∏è' : 'üåç'}</div>
                            <div style="font-size: 1.2rem; color: var(--orange); font-weight: 600; margin-bottom: 0.5rem;">${slide.content}</div>
                            <div style="font-size: 1.8rem; color: var(--gold); font-weight: 700;">${slide.subtext}</div>
                        </div>
                    `;
                } else if (slide.type === 'text') {
                    container.innerHTML = `
                        <div style="animation: fadeInUp 1s ease;">
                            <div style="font-size: 1.2rem; color: var(--gold); font-weight: 600; margin-bottom: 1.5rem;">üìñ Content</div>
                            <div style="font-size: 1rem; line-height: 1.8; text-align: left; max-width: 600px; margin: 0 auto;">${slide.content}</div>
                        </div>
                    `;
                } else if (slide.type === 'activity') {
                    container.innerHTML = `
                        <div style="animation: fadeInUp 1s ease;">
                            <div style="font-size: 1.2rem; color: var(--success); font-weight: 600; margin-bottom: 1.5rem;">üéØ Activity</div>
                            <div style="font-size: 1.1rem; line-height: 1.8; text-align: left; max-width: 600px; margin: 0 auto;">${slide.content}</div>
                        </div>
                    `;
                } else if (slide.type === 'assignment') {
                    container.innerHTML = `
                        <div style="animation: fadeInUp 1s ease;">
                            <div style="font-size: 1.2rem; color: var(--purple); font-weight: 600; margin-bottom: 1.5rem;">üìù Assignment</div>
                            <div style="font-size: 1.1rem; line-height: 1.8; text-align: left; max-width: 600px; margin: 0 auto;">${slide.content}</div>
                        </div>
                    `;
                } else if (slide.type === 'complete') {
                    container.innerHTML = `
                        <div style="animation: zoomIn 0.8s ease;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">üéâ</div>
                            <div style="font-size: 2rem; color: var(--gold); font-weight: 700; margin-bottom: 0.5rem;">${slide.content}</div>
                            <div style="font-size: 1rem; opacity: 0.8;">${slide.subtext}</div>
                        </div>
                    `;
                }

                currentSlide++;
                if (currentSlide < slides.length) {
                    animationInterval = setTimeout(showSlide, slide.duration);
                } else {
                    currentSlide = 0; // Loop back
                }
            }

            showSlide();

            // Add CSS animations
            if (!document.getElementById('animationStyles')) {
                const style = document.createElement('style');
                style.id = 'animationStyles';
                style.textContent = `
                    @keyframes fadeInUp {
                        from {
                            opacity: 0;
                            transform: translateY(30px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                    @keyframes zoomIn {
                        from {
                            opacity: 0;
                            transform: scale(0.5);
                        }
                        to {
                            opacity: 1;
                            transform: scale(1);
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // Pause animation
        function pauseAnimation() {
            animationPaused = !animationPaused;
            const btn = document.getElementById('pauseAnimBtn');
            if (animationPaused) {
                clearTimeout(animationInterval);
                btn.innerHTML = '<i class="fas fa-play"></i> Resume';
            } else {
                btn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                startAnimation();
            }
        }

        // Restart animation
        function restartAnimation() {
            stopAnimation();
            startAnimation();
        }

        // Alias for backward compatibility
        const playAnimatedLesson = startAnimation;

        // Stop animation
        function stopAnimation() {
            if (animationInterval) {
                clearTimeout(animationInterval);
                animationInterval = null;
            }
            animationPaused = false;
        }

        // Update viewLesson to initialize learning mode
        const originalViewLesson = viewLesson;
        viewLesson = function() {
            originalViewLesson();
            // Set initial learning mode
            setLearningMode(learningMode);
        };

        // ===== VIDZIE VIDEO COACHING INTEGRATION =====

        const API_BASE_URL = 'https://z2b-production-3cd3.up.railway.app/api';
        let currentCoachingVideoId = null;
        let currentCoachingVideoUrl = null;

        // Generate coaching video using VIDZIE
        async function generateCoachingVideo() {
            const lesson = getLessonByDay(currentDay);
            if (!lesson) {
                alert('No lesson found for current day');
                return;
            }

            // Check for auth token, or create demo token for LIFETIME users
            let authToken = localStorage.getItem('z2b_auth_token');
            if (!authToken) {
                // Check if user is initialized as LIFETIME tier
                const user = JSON.parse(localStorage.getItem('z2b_current_user') || '{}');
                if (user.tier === 'LIFETIME') {
                    // Create demo auth token for LIFETIME tier users
                    authToken = 'demo_lifetime_' + user.id + '_' + Date.now();
                    localStorage.setItem('z2b_auth_token', authToken);
                    console.log('‚úÖ Created demo auth token for LIFETIME user');
                } else {
                    alert('Please login to generate video lessons');
                    return;
                }
            }

            try {
                // Disable button and show progress
                const btn = document.getElementById('btnGenerateCoachVideo');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
                document.getElementById('videoGenerationProgress').style.display = 'block';

                // Get current stage info for context
                const stageInfo = getCurrentStage(currentDay);
                console.log('üé• Generating stage-aware video for Day', currentDay, '- Stage', stageInfo.stage + ':', stageInfo.name);

                // Create stage-aware video script from lesson
                const videoScript = `
Hi! I'm Coach Manlaw, your guide from employee to entrepreneur!

Welcome to Day ${currentDay} of your 90-day transformation journey.

You are in Stage ${stageInfo.stage}: ${stageInfo.name}. This is where you ${stageInfo.focus}.

Right now, we're focusing on ${stageInfo.leg}.

Today's lesson is: ${lesson.title}.

${lesson.content}

Now, here's your activity for today: ${lesson.activity}

And your assignment: ${lesson.assignment}

Remember, Legacy Builder: You're on ${lesson.phaseTitle.split(':')[0]}, and this stage is about ${lesson.theme}.

Stage ${stageInfo.stage} is critical to your transformation. Stay focused, keep building, and let's make today count!

I am a Legacy Builder, You are a Legacy Builder, and Together we are Builders of Legacies!
                `.trim();

                // Use Coach Manlaw avatar (professional male)
                const coachAvatar = 'https://api.dicebear.com/7.x/avataaars/svg?seed=CoachManlaw&style=circle';

                // Generate video with VIDZIE API

                const response = await fetch(`${API_BASE_URL}/vidzie/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        videoName: `Coach Manlaw - Day ${currentDay} - Stage ${stageInfo.stage}: ${stageInfo.name} - ${lesson.title}`,
                        description: `Stage ${stageInfo.stage} (${stageInfo.name}) - Day ${currentDay} of 90-day transformation: ${lesson.title}`,
                        videoType: 'coaching',
                        purpose: 'coach-manlaw',
                        sourceImage: coachAvatar,
                        script: videoScript.substring(0, 5000), // Limit to 5000 chars
                        voiceId: 'en-ZA-LukeNeural', // South African male voice (African accent)
                        settings: {
                            resolution: 'HD',
                            stage: stageInfo.stage,
                            stageName: stageInfo.name
                        }
                    })
                });

                const data = await response.json();

                if (data.success) {
                    currentCoachingVideoId = data.data.videoId;

                    // Poll for video completion
                    pollCoachingVideoStatus(currentCoachingVideoId);
                } else {
                    throw new Error(data.message || 'Failed to generate video');
                }

            } catch (error) {
                console.error('Video generation error:', error);

                // Provide helpful error message
                let errorMsg = error.message;
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMsg = 'Cannot connect to video generation server.\n\n' +
                               'The backend server needs to be running at https://z2b-production-3cd3.up.railway.app\n\n' +
                               'For now, use the animated slides in Watch mode, or use Listen mode with audio narration.';
                }

                alert('Error generating video:\n\n' + errorMsg);

                // Reset button
                const btn = document.getElementById('btnGenerateCoachVideo');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i> Generate Video Lesson';
                document.getElementById('videoGenerationProgress').style.display = 'none';
            }
        }

        // Poll for coaching video completion
        async function pollCoachingVideoStatus(videoId, attempts = 0) {
            const maxAttempts = 60; // 5 minutes
            const authToken = localStorage.getItem('z2b_auth_token');

            try {
                const response = await fetch(`${API_BASE_URL}/vidzie/video/${videoId}/status`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const { status, progress, videoUrl } = data.data;

                    // Update progress bar
                    document.getElementById('videoGenProgressBar').style.width = progress + '%';

                    if (status === 'completed' && videoUrl) {
                        // Video is ready!
                        currentCoachingVideoUrl = videoUrl;
                        displayCoachingVideo(videoUrl);

                        // Reset button
                        const btn = document.getElementById('btnGenerateCoachVideo');
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-check"></i> Video Generated!';
                        document.getElementById('videoGenerationProgress').style.display = 'none';

                        // Send success message to chat
                        const stageInfo = getCurrentStage(currentDay);
                        addCoachMessage(`
                            <strong>üé• Your Video Lesson is Ready!</strong><br><br>
                            I've created a personalized video lesson for Day ${currentDay} - Stage ${stageInfo.stage}: ${stageInfo.name}.<br><br>
                            This video covers your current transformation stage and includes all the guidance you need for today's lesson.<br><br>
                            <em>Pro tip: Download it to your device so you can watch offline anytime!</em>
                        `);

                        return;
                    }

                    if (status === 'failed') {
                        throw new Error('Video generation failed');
                    }

                    // Continue polling
                    if (attempts < maxAttempts) {
                        setTimeout(() => pollCoachingVideoStatus(videoId, attempts + 1), 5000);
                    } else {
                        throw new Error('Video generation timeout');
                    }
                }

            } catch (error) {
                console.error('Poll video error:', error);
                alert('Video generation failed: ' + error.message);

                // Reset button
                const btn = document.getElementById('btnGenerateCoachVideo');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i> Generate Video Lesson';
                document.getElementById('videoGenerationProgress').style.display = 'none';
            }
        }

        // Display coaching video
        function displayCoachingVideo(videoUrl) {
            const videoSection = document.getElementById('generatedVideoSection');
            const videoSource = document.getElementById('videoSource');
            const videoPlayer = document.getElementById('coachingVideoPlayer');
            const generateSection = document.getElementById('videoGenerateSection');
            const animatedSection = document.getElementById('animatedLesson');

            // Hide generate section and animation
            generateSection.style.display = 'none';
            animatedSection.style.display = 'none';
            stopAnimation();

            // Show video
            videoSource.src = videoUrl;
            videoPlayer.load();
            videoSection.style.display = 'block';
        }

        // Download coaching video
        async function downloadCoachingVideo() {
            if (!currentCoachingVideoUrl) {
                alert('No video available to download');
                return;
            }

            try {
                // Track download
                const authToken = localStorage.getItem('z2b_auth_token');
                if (currentCoachingVideoId && authToken) {
                    await fetch(`${API_BASE_URL}/vidzie/video/${currentCoachingVideoId}/download`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                }

                // Download video with stage info in filename
                const lesson = getLessonByDay(currentDay);
                const stageInfo = getCurrentStage(currentDay);
                const link = document.createElement('a');
                link.href = currentCoachingVideoUrl;
                link.download = `Coach-Manlaw-Day-${currentDay}-Stage-${stageInfo.stage}-${stageInfo.name}-${lesson.title.replace(/[^a-z0-9]/gi, '-')}.mp4`;
                link.click();

                addCoachMessage('‚úÖ Video downloaded! Keep building, Legacy Builder!');

            } catch (error) {
                console.error('Download error:', error);
                alert('Error downloading video: ' + error.message);
            }
        }

        // Share coaching video
        async function shareCoachingVideo() {
            if (!currentCoachingVideoId) {
                alert('No video available to share');
                return;
            }

            try {
                const authToken = localStorage.getItem('z2b_auth_token');

                const response = await fetch(`${API_BASE_URL}/vidzie/video/${currentCoachingVideoId}/share`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const shareUrl = data.data.shareUrl;

                    // Copy to clipboard
                    navigator.clipboard.writeText(shareUrl);

                    addCoachMessage(`
                        <strong>üîó Share Link Created!</strong><br><br>
                        Link copied to clipboard: <a href="${shareUrl}" target="_blank" style="color: var(--gold);">${shareUrl}</a><br><br>
                        Share this lesson with your team, accountability partner, or anyone building their legacy!
                    `);
                } else {
                    throw new Error(data.message || 'Failed to create share link');
                }

            } catch (error) {
                console.error('Share error:', error);
                alert('Error sharing video: ' + error.message);
            }
        }

        // ===== INITIALIZATION =====

        // Initialize page on load
        function initializePage() {
            console.log('üéØ Coach ManLaw: Initializing...');

            // Initialize user as PLATINUM tier if not already set
            const storedUser = localStorage.getItem('z2b_current_user');
            if (!storedUser || JSON.parse(storedUser).tier !== 'PLATINUM') {
                console.log('üîß Initializing user as PLATINUM tier (Platinum Legacy Builder)');
                const platinumUser = {
                    id: 'user_mokoro_manana',
                    name: 'Mokoro Manana',
                    email: 'mokoro.manana@z2b.co.za',
                    phone: '+27 77 490 1639',
                    tier: 'PLATINUM',
                    tierName: 'Platinum Legacy Builder',
                    aiFuel: 999999, // Unlimited AI Fuel for testing
                    aiFuelDaily: 165, // 165 AI Fuel per day
                    pvPoints: 249, // 249 PV Points
                    ispCommission: 45, // 45% ISP Commission
                    joinDate: new Date().toISOString(),
                    isDemo: false,
                    legacyBuilder: true, // Premium Legacy Builder status
                    features: {
                        allApps: true,
                        unlimitedAiFuel: true,
                        tscGenerations: 10,
                        tpbGenerations: 10,
                        tliGenerations: 10,
                        qpbEligible: true,
                        ceoEligible: true,
                        marketplaceSales: true
                    }
                };
                localStorage.setItem('z2b_current_user', JSON.stringify(platinumUser));
                // Update userTier variable
                userTier = getUserTier();
                console.log('‚úÖ User initialized:', platinumUser.name, '- Tier:', userTier);
            } else {
                console.log('‚úÖ User already initialized:', JSON.parse(storedUser).name);
            }

            // Load curriculum
            if (typeof MANLAW_CURRICULUM !== 'undefined') {
                curriculum = MANLAW_CURRICULUM;
                console.log('‚úÖ Curriculum loaded from MANLAW_CURRICULUM');
            } else {
                console.warn('‚ö†Ô∏è MANLAW_CURRICULUM not loaded yet');
            }

            // Update displays
            updateCurrentLesson();
            updateJourneyDay();
            if (btssScores) {
                updateBTSSDisplay();
            }

            // Lesson overview will be rendered after curriculum loads (see script block after curriculum file)
            console.log('‚è≥ Waiting for curriculum to load before rendering lesson overview...');

            // Set welcome time
            const now = new Date();
            document.getElementById('welcomeTime').textContent =
                now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

            // Initialize voice selection
            initializeVoiceSelection();

            console.log('‚úÖ Coach ManLaw: Ready!');
            console.log('üî¢ VERSION: 2.0 - Music & Lesson Audio FIXED (2025-01-10)');
            console.log('Current Day:', currentDay);
            console.log('Functions available:', {
                viewLesson: typeof viewLesson,
                openAssessment: typeof openAssessment,
                showProgress: typeof showProgress
            });
        }

        // Run on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            initializePage();
        }

        // ====================================================================
        // CRITICAL FIX: Expose functions to global scope for onclick handlers
        // ====================================================================
        // All buttons use inline onclick attributes which execute in global scope.
        // These assignments make the functions accessible from window object.
        window.viewLesson = viewLesson;
        window.openAssessment = openAssessment;
        window.showProgress = showProgress;
        window.closeProgress = closeProgress;
        window.completeLesson = completeLesson;
        window.previousDay = previousDay;
        window.nextDay = nextDay;
        window.closeLessonModal = closeLessonModal;
        window.closeAssessment = closeAssessment;
        window.submitAssessment = submitAssessment;
        window.showSettings = showSettings;
        window.closeSettings = closeSettings;
        window.saveSettings = saveSettings;
        window.sendMessage = sendMessage;
        window.setLearningMode = setLearningMode;
        window.toggleAudio = toggleAudio;
        window.stopAudio = stopAudio;
        window.selectVoice = selectVoice;
        window.setAudioSpeed = setAudioSpeed;
        window.seekAudio = seekAudio;
        window.playAnimatedLesson = playAnimatedLesson;
        window.restartAnimation = restartAnimation;
        window.pauseAnimation = pauseAnimation;
        window.generateCoachingVideo = generateCoachingVideo;
        window.downloadCoachingVideo = downloadCoachingVideo;
        window.shareCoachingVideo = shareCoachingVideo;

        console.log('‚úÖ All functions exposed to global scope - buttons ready!');
    </script>

    <!-- Load Curriculum -->
    <script src="coach-manlaw-curriculum.js" onerror="console.warn('‚ö†Ô∏è Failed to load curriculum file')"></script>
    <script>
        // Reload curriculum after external script loads
        if (typeof MANLAW_CURRICULUM !== 'undefined' && typeof curriculum !== 'undefined') {
            curriculum = MANLAW_CURRICULUM;
            if (typeof updateCurrentLesson === 'function') {
                updateCurrentLesson();
            }
            // Now render the lesson overview with loaded curriculum
            if (typeof renderLessonOverview === 'function') {
                renderLessonOverview();
                console.log('‚úÖ Lesson overview rendered with curriculum data');
            }
            console.log('‚úÖ Curriculum loaded from external file');
        } else {
            console.warn('‚ö†Ô∏è Curriculum not available - buttons will still work with modals');
        }
    </script>
<!-- ========================================
     COACH MANLAW MUSIC PLAYER MODULE
     Add this entire section before </body> in coach-manlaw.html
     ========================================
-->

<!-- Floating Music Player -->
<div id="musicPlayerFloat" class="music-player-float" style="display: none;">
    <!-- Player Header -->
    <div class="music-player-header">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-music" style="color: var(--royal-gold);"></i>
            <span style="font-weight: 700; font-size: 1rem;">MUSIC PLAYER</span>
        </div>
        <div style="display: flex; gap: 0.5rem;">
            <button class="player-header-btn" onclick="minimizeMusicPlayer()" title="Minimize">
                <i class="fas fa-minus"></i>
            </button>
            <button class="player-header-btn" onclick="closeMusicPlayer()" title="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Mode Tabs -->
    <div class="audio-mode-tabs">
        <button class="mode-tab" id="lessonModeTab" onclick="switchAudioMode('lesson')">
            <i class="fas fa-book-reader"></i> Lesson Audio
        </button>
        <button class="mode-tab active" id="musicModeTab" onclick="switchAudioMode('music')">
            <i class="fas fa-headphones"></i> Background Music
        </button>
    </div>

    <!-- Lesson Audio Info Panel (shows when in Lesson mode) -->
    <div id="lessonAudioInfo" style="display: none; padding: 1rem; background: rgba(255, 215, 0, 0.1); border-left: 3px solid var(--royal-gold); margin: 1rem;">
        <div style="font-size: 0.85rem; color: var(--royal-gold); margin-bottom: 0.5rem;">
            <i class="fas fa-info-circle"></i> <strong>Lesson Audio Mode Active</strong>
        </div>
        <div style="font-size: 0.8rem; color: var(--white); opacity: 0.9; margin-bottom: 0.8rem;">
            Opens any lesson (Introduction, Morning, or Evening) and I'll automatically read it to you! Or click below to read current page.
        </div>
        <button onclick="readCurrentPage()" style="width: 100%; padding: 0.7rem; background: linear-gradient(135deg, var(--royal-gold), var(--royal-gold-dark)); border: none; border-radius: 8px; color: var(--royal-blue-deep); font-weight: 600; cursor: pointer;">
            <i class="fas fa-book-reader"></i> Read Current Page Now
        </button>
    </div>

    <!-- Playlist Status Panel (always visible) -->
    <div id="playlistStatus" style="padding: 0.8rem 1rem; background: rgba(0, 0, 0, 0.2); border-bottom: 1px solid rgba(255, 215, 0, 0.2); display: flex; justify-content: space-between; align-items: center;">
        <div style="font-size: 0.85rem;">
            <i class="fas fa-list"></i>
            <span id="playlistCount">0 tracks</span> in playlist
        </div>
        <button onclick="forceInitPlaylist()" style="padding: 0.4rem 0.8rem; background: rgba(255, 215, 0, 0.15); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 6px; color: var(--royal-gold); font-size: 0.75rem; cursor: pointer; font-weight: 600;" title="Click if playlist is empty">
            <i class="fas fa-sync"></i> Re-init
        </button>
    </div>

    <!-- Now Playing Display -->
    <div class="now-playing-section">
        <div class="album-art" id="albumArt">
            <i class="fas fa-music"></i>
        </div>
        <div class="track-info">
            <div class="track-title" id="currentTrackTitle">Select a track to play</div>
            <div class="track-artist" id="currentTrackArtist">Coach Manlaw Library</div>
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="progress-section">
        <div class="time-display">
            <span id="currentTime">0:00</span>
            <span id="totalTime">0:00</span>
        </div>
        <div class="progress-bar-container" onclick="seekMusic(event)">
            <div class="progress-bar" id="musicProgressBar"></div>
        </div>
    </div>

    <!-- Playback Controls -->
    <div class="playback-controls">
        <button class="control-btn" onclick="previousTrack()" title="Previous">
            <i class="fas fa-step-backward"></i>
        </button>
        <button class="control-btn play-btn" id="playPauseBtn" onclick="togglePlayPause()" title="Play/Pause">
            <i class="fas fa-play"></i>
        </button>
        <button class="control-btn" onclick="nextTrack()" title="Next">
            <i class="fas fa-step-forward"></i>
        </button>
        <button class="control-btn" id="shuffleBtn" onclick="toggleShuffle()" title="Shuffle">
            <i class="fas fa-random"></i>
        </button>
        <button class="control-btn" id="repeatBtn" onclick="toggleRepeat()" title="Repeat">
            <i class="fas fa-redo"></i>
        </button>
    </div>

    <!-- Volume Control -->
    <div class="volume-section">
        <button class="volume-btn" onclick="toggleMute()">
            <i class="fas fa-volume-up" id="volumeIcon"></i>
        </button>
        <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="60"
               oninput="setVolume(this.value)">
        <span id="volumeDisplay">60%</span>
    </div>

    <!-- Library Tabs -->
    <div class="library-tabs">
        <button class="lib-tab active" onclick="showLibraryTab('internal')">
            <i class="fas fa-compact-disc"></i> Library
        </button>
        <button class="lib-tab" onclick="showLibraryTab('upload')">
            <i class="fas fa-upload"></i> My Music
        </button>
        <button class="lib-tab" onclick="showLibraryTab('online')">
            <i class="fas fa-globe"></i> Online
        </button>
        <button class="lib-tab" onclick="showLibraryTab('playlist')">
            <i class="fas fa-list"></i> Playlist
        </button>
    </div>

    <!-- Library Content -->
    <div class="library-content">
        <!-- Internal Library -->
        <div id="internalLibrary" class="library-tab-content active">
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                <div class="library-search" style="flex: 1; margin-bottom: 0;">
                    <input type="text" placeholder="Search tracks..." id="librarySearch" oninput="filterTracks(this.value)">
                </div>
                <button onclick="addAllTracksToPlaylist()" style="padding: 0.7rem 1rem; background: linear-gradient(135deg, var(--royal-gold), var(--royal-gold-dark)); border: none; border-radius: 8px; color: var(--royal-blue-deep); font-weight: 600; cursor: pointer; white-space: nowrap;" title="Add all library tracks to playlist">
                    <i class="fas fa-plus-circle"></i> Add All
                </button>
            </div>
            <div id="trackList" class="track-list">
                <!-- Tracks will be populated by JavaScript -->
            </div>
        </div>

        <!-- Upload Music -->
        <div id="uploadLibrary" class="library-tab-content">
            <div class="upload-section">
                <div style="text-align: center; padding: 2rem;">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--royal-gold); margin-bottom: 1rem;"></i>
                    <h4 style="margin-bottom: 1rem;">Upload Your Music</h4>
                    <p style="opacity: 0.8; margin-bottom: 1.5rem; font-size: 0.9rem;">
                        Upload MP3, WAV, or OGG files from your device
                    </p>
                    <input type="file" id="musicFileInput" accept="audio/*" multiple style="display: none;" onchange="handleMusicUpload(event)">
                    <button class="upload-btn" onclick="document.getElementById('musicFileInput').click()">
                        <i class="fas fa-plus"></i> Choose Files
                    </button>
                </div>
                <div id="uploadedTracksList" class="track-list">
                    <!-- Uploaded tracks will appear here -->
                </div>
            </div>
        </div>

        <!-- Online Music -->
        <div id="onlineLibrary" class="library-tab-content">
            <div class="online-section">
                <h4><i class="fas fa-link"></i> Add Online Music</h4>
                <input type="text" placeholder="Paste YouTube or SoundCloud URL" id="onlineUrlInput" class="url-input">
                <button class="add-url-btn" onclick="addOnlineTrack()">
                    <i class="fas fa-plus"></i> Add Track
                </button>
                <div class="online-info">
                    <p><i class="fas fa-info-circle"></i> Supports YouTube and SoundCloud links</p>
                </div>
                <div id="onlineTracksList" class="track-list">
                    <!-- Online tracks will appear here -->
                </div>
            </div>
        </div>

        <!-- Current Playlist -->
        <div id="playlistLibrary" class="library-tab-content">
            <div class="playlist-header">
                <h4><i class="fas fa-list-music"></i> Current Playlist</h4>
                <button class="clear-playlist-btn" onclick="clearPlaylist()">
                    <i class="fas fa-trash"></i> Clear
                </button>
            </div>
            <div id="currentPlaylist" class="playlist-display">
                <!-- Current playlist will appear here -->
            </div>
        </div>
    </div>

    <!-- Hidden Audio Element -->
    <audio id="musicAudioPlayer" preload="metadata"></audio>

    <!-- Hidden YouTube Player -->
    <div id="ytPlayerContainer" style="display: none;">
        <div id="ytPlayer"></div>
    </div>
</div>

<!-- Minimized Player (Bottom Bar) -->
<div id="musicPlayerMinimized" class="music-player-minimized" style="display: none;">
    <div class="minimized-track-info">
        <i class="fas fa-music" style="color: var(--royal-gold); margin-right: 0.5rem;"></i>
        <span id="minimizedTrackTitle">No track playing</span>
    </div>
    <div class="minimized-controls">
        <button class="mini-btn" onclick="previousTrack()">
            <i class="fas fa-step-backward"></i>
        </button>
        <button class="mini-btn" id="miniPlayBtn" onclick="togglePlayPause()">
            <i class="fas fa-play"></i>
        </button>
        <button class="mini-btn" onclick="nextTrack()">
            <i class="fas fa-step-forward"></i>
        </button>
        <button class="mini-btn" onclick="expandMusicPlayer()">
            <i class="fas fa-expand"></i>
        </button>
    </div>
</div>

<!-- Music Player CSS -->
<style>
/* ========================================
   MUSIC PLAYER STYLES
   ======================================== */

.music-player-float {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 400px;
    max-height: 700px;
    background: linear-gradient(145deg, rgba(10, 31, 68, 0.98), rgba(3, 11, 31, 0.98));
    backdrop-filter: blur(20px);
    border: 2px solid var(--royal-gold);
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(255, 215, 0, 0.3);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: all 0.3s ease;
}

.music-player-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 107, 53, 0.05));
    border-bottom: 1px solid rgba(255, 215, 0, 0.3);
    cursor: move;
}

.player-header-btn {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: var(--royal-gold);
    width: 30px;
    height: 30px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.player-header-btn:hover {
    background: var(--royal-gold);
    color: var(--royal-blue-deep);
}

.audio-mode-tabs {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
    padding: 1rem;
    background: rgba(0, 0, 0, 0.2);
}

.mode-tab {
    padding: 0.8rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 215, 0, 0.2);
    border-radius: 10px;
    color: var(--white);
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 600;
    font-size: 0.85rem;
}

.mode-tab.active {
    background: linear-gradient(135deg, var(--royal-gold), var(--royal-gold-dark));
    color: var(--royal-blue-deep);
    border-color: var(--royal-gold);
}

.mode-tab:hover:not(.active) {
    background: rgba(255, 215, 0, 0.1);
}

.now-playing-section {
    padding: 1.5rem;
    display: flex;
    gap: 1rem;
    align-items: center;
    background: rgba(0, 0, 0, 0.2);
}

.album-art {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, var(--royal-gold), var(--royal-gold-dark));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: var(--royal-blue-deep);
    flex-shrink: 0;
}

.track-info {
    flex: 1;
    min-width: 0;
}

.track-title {
    font-weight: 700;
    font-size: 0.95rem;
    color: var(--royal-gold);
    margin-bottom: 0.3rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.track-artist {
    font-size: 0.8rem;
    color: var(--white);
    opacity: 0.7;
}

.progress-section {
    padding: 0 1.5rem 1rem;
}

.time-display {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: var(--royal-gold);
    margin-bottom: 0.5rem;
}

.progress-bar-container {
    width: 100%;
    height: 6px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
    cursor: pointer;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--royal-gold), var(--royal-gold-light));
    width: 0%;
    transition: width 0.1s linear;
}

.playback-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.5rem;
    background: rgba(0, 0, 0, 0.2);
}

.control-btn {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 215, 0, 0.3);
    color: var(--royal-gold);
    width: 45px;
    height: 45px;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
}

.control-btn.play-btn {
    width: 55px;
    height: 55px;
    background: linear-gradient(135deg, var(--royal-gold), var(--royal-gold-dark));
    color: var(--royal-blue-deep);
    border: none;
    font-size: 1.3rem;
}

.control-btn:hover {
    background: var(--royal-gold);
    color: var(--royal-blue-deep);
    transform: scale(1.1);
}

.control-btn.play-btn:hover {
    transform: scale(1.15);
}

.control-btn.active {
    background: var(--royal-gold);
    color: var(--royal-blue-deep);
}

.volume-section {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    padding: 0 1.5rem 1rem;
}

.volume-btn {
    background: none;
    border: none;
    color: var(--royal-gold);
    font-size: 1.2rem;
    cursor: pointer;
    transition: all 0.2s;
}

.volume-btn:hover {
    color: var(--royal-gold-light);
    transform: scale(1.1);
}

.volume-slider {
    flex: 1;
    height: 4px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
    outline: none;
    -webkit-appearance: none;
}

.volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px;
    height: 14px;
    background: var(--royal-gold);
    border-radius: 50%;
    cursor: pointer;
}

.volume-slider::-moz-range-thumb {
    width: 14px;
    height: 14px;
    background: var(--royal-gold);
    border-radius: 50%;
    cursor: pointer;
    border: none;
}

#volumeDisplay {
    font-size: 0.8rem;
    color: var(--royal-gold);
    min-width: 40px;
    text-align: right;
}

.library-tabs {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.3rem;
    padding: 0 1rem;
    background: rgba(0, 0, 0, 0.2);
}

.lib-tab {
    padding: 0.6rem 0.3rem;
    background: rgba(255, 255, 255, 0.05);
    border: none;
    border-bottom: 2px solid transparent;
    color: var(--white);
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.75rem;
    font-weight: 600;
    white-space: nowrap;
}

.lib-tab.active {
    color: var(--royal-gold);
    border-bottom-color: var(--royal-gold);
    background: rgba(255, 215, 0, 0.1);
}

.lib-tab:hover:not(.active) {
    background: rgba(255, 255, 255, 0.08);
}

.library-content {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    background: rgba(0, 0, 0, 0.3);
}

.library-tab-content {
    display: none;
}

.library-tab-content.active {
    display: block;
}

.library-search {
    margin-bottom: 1rem;
}

.library-search input {
    width: 100%;
    padding: 0.7rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 215, 0, 0.2);
    border-radius: 8px;
    color: var(--white);
    font-size: 0.9rem;
}

.track-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.track-item {
    padding: 0.8rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 215, 0, 0.1);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.track-item:hover {
    background: rgba(255, 215, 0, 0.1);
    border-color: var(--royal-gold);
}

.track-item.playing {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 107, 53, 0.1));
    border-color: var(--royal-gold);
}

.track-item-info {
    flex: 1;
    min-width: 0;
}

.track-item-title {
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--white);
    margin-bottom: 0.2rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.track-item-details {
    font-size: 0.75rem;
    color: var(--royal-gold);
    opacity: 0.8;
}

.track-item-actions {
    display: flex;
    gap: 0.5rem;
}

.track-action-btn {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: var(--royal-gold);
    width: 30px;
    height: 30px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.track-action-btn:hover {
    background: var(--royal-gold);
    color: var(--royal-blue-deep);
}

.upload-btn,
.add-url-btn {
    padding: 0.8rem 1.5rem;
    background: linear-gradient(135deg, var(--royal-gold), var(--royal-gold-dark));
    border: none;
    border-radius: 10px;
    color: var(--royal-blue-deep);
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
}

.upload-btn:hover,
.add-url-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
}

.url-input {
    width: 100%;
    padding: 0.8rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 215, 0, 0.2);
    border-radius: 10px;
    color: var(--white);
    margin-bottom: 1rem;
    font-size: 0.9rem;
}

.online-info {
    margin-top: 1rem;
    padding: 0.8rem;
    background: rgba(255, 215, 0, 0.05);
    border-left: 3px solid var(--royal-gold);
    border-radius: 5px;
    font-size: 0.8rem;
    color: var(--royal-gold);
}

.playlist-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.clear-playlist-btn {
    padding: 0.5rem 1rem;
    background: rgba(255, 68, 68, 0.2);
    border: 1px solid rgba(255, 68, 68, 0.5);
    border-radius: 8px;
    color: #FF4444;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
}

.clear-playlist-btn:hover {
    background: rgba(255, 68, 68, 0.3);
}

/* Minimized Player */
.music-player-minimized {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 60px;
    background: linear-gradient(145deg, rgba(10, 31, 68, 0.98), rgba(3, 11, 31, 0.98));
    backdrop-filter: blur(20px);
    border-top: 2px solid var(--royal-gold);
    z-index: 10000;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 2rem;
    box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.3);
}

.minimized-track-info {
    display: flex;
    align-items: center;
    color: var(--white);
    font-weight: 600;
}

.minimized-controls {
    display: flex;
    gap: 1rem;
}

.mini-btn {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 215, 0, 0.3);
    color: var(--royal-gold);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mini-btn:hover {
    background: var(--royal-gold);
    color: var(--royal-blue-deep);
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .music-player-float {
        width: 100%;
        bottom: 0;
        right: 0;
        left: 0;
        border-radius: 20px 20px 0 0;
        max-height: 80vh;
    }

    .playback-controls {
        gap: 0.5rem;
    }

    .control-btn {
        width: 40px;
        height: 40px;
    }

    .control-btn.play-btn {
        width: 50px;
        height: 50px;
    }
}

/* Scrollbar Styling */
.library-content::-webkit-scrollbar {
    width: 6px;
}

.library-content::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
}

.library-content::-webkit-scrollbar-thumb {
    background: var(--royal-gold);
    border-radius: 3px;
}

.library-content::-webkit-scrollbar-thumb:hover {
    background: var(--royal-gold-light);
}
</style>

<!-- Music Player JavaScript -->
<script>
// ========================================
// MUSIC PLAYER JAVASCRIPT
// ========================================

// Music Library Data
const musicLibrary = [
    {
        id: 1,
        title: "Deep Focus Flow",
        artist: "Productivity Beats",
        category: "Focus",
        duration: "15:00",
        url: "https://www.youtube.com/watch?v=jfKfPfyJRdk",
        tags: ["focus", "concentration", "studying"]
    },
    {
        id: 2,
        title: "Entrepreneurial Ambition",
        artist: "Motivation Sound",
        category: "Motivation",
        duration: "10:30",
        url: "https://www.youtube.com/watch?v=ZXsQAXx_ao0",
        tags: ["motivation", "ambition", "energy"]
    },
    {
        id: 3,
        title: "Morning Mindset Builder",
        artist: "Legacy Sounds",
        category: "Morning",
        duration: "12:45",
        url: "https://www.youtube.com/watch?v=hHW1oY26kxQ",
        tags: ["morning", "mindset", "positive"]
    },
    {
        id: 4,
        title: "Strategic Thinking Session",
        artist: "Study Music",
        category: "Focus",
        duration: "20:00",
        url: "https://www.youtube.com/watch?v=5qap5aO4i9A",
        tags: ["strategy", "thinking", "planning"]
    },
    {
        id: 5,
        title: "Legacy Builder Anthem",
        artist: "Epic Motivation",
        category: "Motivation",
        duration: "8:30",
        url: "https://www.youtube.com/watch?v=g-jwWYX7Jlo",
        tags: ["legacy", "power", "confidence"]
    },
    {
        id: 6,
        title: "Calm Reflection Time",
        artist: "Meditation Beats",
        category: "Reflection",
        duration: "18:00",
        url: "https://www.youtube.com/watch?v=lTRiuFIWV54",
        tags: ["calm", "reflection", "meditation"]
    }
];

// Player State
let currentPlaylist = [];
let currentTrackIndex = 0;
let isPlaying = false;
let currentAudioMode = 'music'; // 'lesson' or 'music'
let shuffleEnabled = false;
let repeatMode = 'off'; // 'off', 'one', 'all'
let musicVolume = 0.6;
let isMuted = false;

// Audio Elements
const audioPlayer = document.getElementById('musicAudioPlayer');
let ytPlayer = null;

// Initialize Music Player
function initializeMusicPlayer() {
    console.log('üéµ Initializing Music Player...');

    // Load saved preferences
    loadMusicPreferences();

    // Populate internal library
    populateInternalLibrary();

    // Auto-populate playlist with all library tracks if playlist is empty
    if (currentPlaylist.length === 0) {
        currentPlaylist = [...musicLibrary];
        console.log('üéµ Auto-loaded', currentPlaylist.length, 'tracks to playlist');
        updatePlaylistDisplay();
    }

    // Load uploaded tracks
    loadUploadedTracks();

    // Load online tracks
    loadOnlineTracks();

    // Setup audio player events
    setupAudioEvents();

    // Load YouTube API
    loadYouTubeAPI();

    console.log('‚úÖ Music Player initialized with', currentPlaylist.length, 'tracks ready to play');
}

// Populate Internal Library
function populateInternalLibrary() {
    const trackList = document.getElementById('trackList');
    trackList.innerHTML = musicLibrary.map(track => `
        <div class="track-item" onclick="addTrackToPlaylist(${track.id})">
            <div class="track-item-info">
                <div class="track-item-title">${track.title}</div>
                <div class="track-item-details">${track.category} ‚Ä¢ ${track.duration}</div>
            </div>
            <div class="track-item-actions">
                <button class="track-action-btn" onclick="playTrackNow(${track.id}); event.stopPropagation();" title="Play Now">
                    <i class="fas fa-play"></i>
                </button>
                <button class="track-action-btn" onclick="addTrackToPlaylist(${track.id}); event.stopPropagation();" title="Add to Playlist">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
    `).join('');
}

// Add track to playlist
function addTrackToPlaylist(trackId) {
    const track = musicLibrary.find(t => t.id === trackId);
    if (track && !currentPlaylist.find(t => t.id === trackId)) {
        currentPlaylist.push(track);
        updatePlaylistDisplay();
        showNotification(`‚úÖ Added: ${track.title}`);
    }
}

// Add all library tracks to playlist
function addAllTracksToPlaylist() {
    let addedCount = 0;
    musicLibrary.forEach(track => {
        if (!currentPlaylist.find(t => t.id === track.id)) {
            currentPlaylist.push(track);
            addedCount++;
        }
    });

    if (addedCount > 0) {
        updatePlaylistDisplay();
        showNotification(`‚úÖ Added ${addedCount} track${addedCount > 1 ? 's' : ''} to playlist`);
    } else {
        showNotification(`‚ÑπÔ∏è All tracks already in playlist`);
    }
}

// Play track immediately
function playTrackNow(trackId) {
    const track = musicLibrary.find(t => t.id === trackId);
    if (track) {
        currentPlaylist = [track, ...currentPlaylist.filter(t => t.id !== trackId)];
        currentTrackIndex = 0;
        playCurrentTrack();
        updatePlaylistDisplay();
    }
}

// Update Playlist Display
function updatePlaylistDisplay() {
    const container = document.getElementById('currentPlaylist');

    // Update playlist count display
    const countDisplay = document.getElementById('playlistCount');
    if (countDisplay) {
        countDisplay.textContent = `${currentPlaylist.length} track${currentPlaylist.length !== 1 ? 's' : ''}`;
    }

    if (currentPlaylist.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 2rem; opacity: 0.5;">
                <i class="fas fa-music" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                <p>No tracks in playlist</p>
                <p style="font-size: 0.85rem;">Click "Re-init" button above to load tracks</p>
            </div>
        `;
        return;
    }

    container.innerHTML = currentPlaylist.map((track, index) => `
        <div class="track-item ${index === currentTrackIndex ? 'playing' : ''}" onclick="playTrackAtIndex(${index})">
            <div class="track-item-info">
                <div class="track-item-title">
                    ${index === currentTrackIndex ? '<i class="fas fa-volume-up"></i> ' : ''}
                    ${track.title}
                </div>
                <div class="track-item-details">${track.artist || track.category}</div>
            </div>
            <div class="track-item-actions">
                <button class="track-action-btn" onclick="removeFromPlaylist(${index}); event.stopPropagation();">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `).join('');
}

// Play track at specific index
function playTrackAtIndex(index) {
    currentTrackIndex = index;
    playCurrentTrack();
}

// Play current track
function playCurrentTrack() {
    if (currentPlaylist.length === 0) return;

    const track = currentPlaylist[currentTrackIndex];
    console.log('üéµ Playing:', track.title);

    // Update UI
    document.getElementById('currentTrackTitle').textContent = track.title;
    document.getElementById('currentTrackArtist').textContent = track.artist || track.category;
    document.getElementById('minimizedTrackTitle').textContent = track.title;

    // Check if YouTube link
    if (track.url && (track.url.includes('youtube.com') || track.url.includes('youtu.be'))) {
        playYouTubeTrack(track.url);
    } else if (track.data) {
        // Play uploaded file
        audioPlayer.src = track.data;
        audioPlayer.play();
        isPlaying = true;
        updatePlayPauseButton();
    }

    // Update playlist display
    updatePlaylistDisplay();

    // Save to preferences
    saveMusicPreferences();
}

// YouTube Player Functions
function loadYouTubeAPI() {
    if (!window.YT) {
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(tag);

        window.onYouTubeIframeAPIReady = function() {
            console.log('‚úÖ YouTube API loaded');
        };
    }
}

function playYouTubeTrack(url) {
    const videoId = extractYouTubeID(url);
    if (!videoId) return;

    if (!ytPlayer) {
        ytPlayer = new YT.Player('ytPlayer', {
            height: '0',
            width: '0',
            videoId: videoId,
            playerVars: {
                autoplay: 1,
                controls: 0,
                modestbranding: 1,
                rel: 0
            },
            events: {
                'onReady': onYTPlayerReady,
                'onStateChange': onYTPlayerStateChange
            }
        });
    } else {
        ytPlayer.loadVideoById(videoId);
        ytPlayer.playVideo();
    }

    isPlaying = true;
    updatePlayPauseButton();
}

function onYTPlayerReady(event) {
    event.target.setVolume(musicVolume * 100);
    event.target.playVideo();
}

function onYTPlayerStateChange(event) {
    if (event.data === YT.PlayerState.ENDED) {
        playNextTrack();
    } else if (event.data === YT.PlayerState.PLAYING) {
        isPlaying = true;
        updatePlayPauseButton();
        startProgressUpdate();
    } else if (event.data === YT.PlayerState.PAUSED) {
        isPlaying = false;
        updatePlayPauseButton();
    }
}

function extractYouTubeID(url) {
    const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
    const match = url.match(regExp);
    return (match && match[7].length === 11) ? match[7] : null;
}

// Playback Controls
function togglePlayPause() {
    if (currentPlaylist.length === 0) {
        showNotification('‚ö†Ô∏è Add tracks to playlist first');
        return;
    }

    if (isPlaying) {
        pauseMusic();
    } else {
        resumeMusic();
    }
}

function pauseMusic() {
    if (ytPlayer && ytPlayer.pauseVideo) {
        ytPlayer.pauseVideo();
    } else if (audioPlayer) {
        audioPlayer.pause();
    }
    isPlaying = false;
    updatePlayPauseButton();
}

function resumeMusic() {
    if (currentPlaylist.length === 0) {
        showNotification('‚ö†Ô∏è Playlist is empty');
        return;
    }

    // If nothing has been played yet, start from the first track
    if (!ytPlayer && (!audioPlayer || !audioPlayer.src)) {
        console.log('üéµ Starting playback from beginning');
        playCurrentTrack();
        return;
    }

    // Resume existing playback
    if (ytPlayer && ytPlayer.playVideo) {
        ytPlayer.playVideo();
        isPlaying = true;
        updatePlayPauseButton();
    } else if (audioPlayer && audioPlayer.src) {
        audioPlayer.play().then(() => {
            isPlaying = true;
            updatePlayPauseButton();
        }).catch(err => {
            console.error('Audio play error:', err);
            // If resume fails, start from beginning
            playCurrentTrack();
        });
    } else {
        // Nothing to resume, start fresh
        playCurrentTrack();
    }
}

function stopMusic() {
    if (ytPlayer && ytPlayer.stopVideo) {
        ytPlayer.stopVideo();
    } else if (audioPlayer) {
        audioPlayer.pause();
        audioPlayer.currentTime = 0;
    }
    isPlaying = false;
    updatePlayPauseButton();
    document.getElementById('musicProgressBar').style.width = '0%';
}

function nextTrack() {
    if (repeatMode === 'one') {
        playCurrentTrack();
    } else if (currentTrackIndex < currentPlaylist.length - 1) {
        currentTrackIndex++;
        playCurrentTrack();
    } else if (repeatMode === 'all') {
        currentTrackIndex = 0;
        playCurrentTrack();
    } else {
        stopMusic();
    }
}

function previousTrack() {
    if (currentTrackIndex > 0) {
        currentTrackIndex--;
        playCurrentTrack();
    } else if (repeatMode === 'all') {
        currentTrackIndex = currentPlaylist.length - 1;
        playCurrentTrack();
    }
}

// Update Play/Pause Button
function updatePlayPauseButton() {
    const icon = isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
    document.getElementById('playPauseBtn').innerHTML = icon;
    document.getElementById('miniPlayBtn').innerHTML = icon;
}

// Toggle Shuffle
function toggleShuffle() {
    shuffleEnabled = !shuffleEnabled;
    document.getElementById('shuffleBtn').classList.toggle('active', shuffleEnabled);

    if (shuffleEnabled) {
        // Shuffle playlist (keeping current track at index 0)
        const currentTrack = currentPlaylist[currentTrackIndex];
        const otherTracks = currentPlaylist.filter((_, i) => i !== currentTrackIndex);
        currentPlaylist = [currentTrack, ...shuffleArray(otherTracks)];
        currentTrackIndex = 0;
    }

    updatePlaylistDisplay();
    showNotification(shuffleEnabled ? 'üîÄ Shuffle ON' : 'üîÄ Shuffle OFF');
}

// Toggle Repeat
function toggleRepeat() {
    const modes = ['off', 'one', 'all'];
    const currentIndex = modes.indexOf(repeatMode);
    repeatMode = modes[(currentIndex + 1) % modes.length];

    const repeatBtn = document.getElementById('repeatBtn');
    repeatBtn.classList.toggle('active', repeatMode !== 'off');

    const messages = {
        'off': 'üîÅ Repeat OFF',
        'one': 'üîÇ Repeat One',
        'all': 'üîÅ Repeat All'
    };

    showNotification(messages[repeatMode]);
}

// Volume Controls
function setVolume(value) {
    musicVolume = value / 100;
    if (ytPlayer && ytPlayer.setVolume) {
        ytPlayer.setVolume(value);
    } else if (audioPlayer) {
        audioPlayer.volume = musicVolume;
    }

    document.getElementById('volumeDisplay').textContent = value + '%';

    // Update icon
    const icon = document.getElementById('volumeIcon');
    if (value == 0) {
        icon.className = 'fas fa-volume-mute';
    } else if (value < 50) {
        icon.className = 'fas fa-volume-down';
    } else {
        icon.className = 'fas fa-volume-up';
    }

    isMuted = false;
}

function toggleMute() {
    if (isMuted) {
        setVolume(musicVolume * 100);
        isMuted = false;
    } else {
        if (ytPlayer && ytPlayer.mute) {
            ytPlayer.mute();
        } else if (audioPlayer) {
            audioPlayer.muted = true;
        }
        document.getElementById('volumeIcon').className = 'fas fa-volume-mute';
        isMuted = true;
    }
}

// Progress Bar
function seekMusic(event) {
    const container = event.currentTarget;
    const clickX = event.offsetX;
    const width = container.offsetWidth;
    const percentage = (clickX / width);

    if (ytPlayer && ytPlayer.getDuration) {
        const duration = ytPlayer.getDuration();
        ytPlayer.seekTo(duration * percentage);
    } else if (audioPlayer) {
        audioPlayer.currentTime = audioPlayer.duration * percentage;
    }
}

// Setup Audio Events
function setupAudioEvents() {
    audioPlayer.addEventListener('timeupdate', () => {
        if (!ytPlayer || !ytPlayer.getCurrentTime) {
            const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            document.getElementById('musicProgressBar').style.width = progress + '%';
            document.getElementById('currentTime').textContent = formatTime(audioPlayer.currentTime);
            document.getElementById('totalTime').textContent = formatTime(audioPlayer.duration);
        }
    });

    audioPlayer.addEventListener('ended', () => {
        nextTrack();
    });

    audioPlayer.addEventListener('loadedmetadata', () => {
        document.getElementById('totalTime').textContent = formatTime(audioPlayer.duration);
    });
}

// Progress Update for YouTube
function startProgressUpdate() {
    if (ytPlayer && ytPlayer.getCurrentTime) {
        const updateInterval = setInterval(() => {
            if (!isPlaying || !ytPlayer) {
                clearInterval(updateInterval);
                return;
            }

            const currentTime = ytPlayer.getCurrentTime();
            const duration = ytPlayer.getDuration();
            const progress = (currentTime / duration) * 100;

            document.getElementById('musicProgressBar').style.width = progress + '%';
            document.getElementById('currentTime').textContent = formatTime(currentTime);
            document.getElementById('totalTime').textContent = formatTime(duration);
        }, 1000);
    }
}

// Format Time
function formatTime(seconds) {
    if (isNaN(seconds)) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

// Upload Music from Device
function handleMusicUpload(event) {
    const files = event.target.files;
    let uploadCount = 0;

    for (let file of files) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const track = {
                id: 'user_' + Date.now() + '_' + uploadCount,
                title: file.name.replace(/\.[^/.]+$/, ""),
                artist: "My Music",
                category: 'Uploaded',
                source: 'device',
                data: e.target.result,
                size: file.size,
                type: file.type
            };

            // Save to localStorage
            let userMusic = JSON.parse(localStorage.getItem('user_music') || '[]');
            userMusic.push(track);
            localStorage.setItem('user_music', JSON.stringify(userMusic));

            loadUploadedTracks();
            showNotification(`‚úÖ Uploaded: ${track.title}`);
            uploadCount++;
        };
        reader.readAsDataURL(file);
    }
}

// Load Uploaded Tracks
function loadUploadedTracks() {
    const userMusic = JSON.parse(localStorage.getItem('user_music') || '[]');
    const container = document.getElementById('uploadedTracksList');

    if (userMusic.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 1rem; opacity: 0.5;">No uploaded tracks yet</div>';
        return;
    }

    container.innerHTML = userMusic.map((track, index) => `
        <div class="track-item" onclick="playUploadedTrack('${track.id}')">
            <div class="track-item-info">
                <div class="track-item-title">${track.title}</div>
                <div class="track-item-details">Uploaded ‚Ä¢ ${formatFileSize(track.size)}</div>
            </div>
            <div class="track-item-actions">
                <button class="track-action-btn" onclick="deleteUploadedTrack('${track.id}'); event.stopPropagation();">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
}

function playUploadedTrack(trackId) {
    const userMusic = JSON.parse(localStorage.getItem('user_music') || '[]');
    const track = userMusic.find(t => t.id === trackId);

    if (track) {
        currentPlaylist = [track, ...currentPlaylist.filter(t => t.id !== trackId)];
        currentTrackIndex = 0;
        playCurrentTrack();
        updatePlaylistDisplay();
    }
}

function deleteUploadedTrack(trackId) {
    if (confirm('Delete this track?')) {
        let userMusic = JSON.parse(localStorage.getItem('user_music') || '[]');
        userMusic = userMusic.filter(t => t.id !== trackId);
        localStorage.setItem('user_music', JSON.stringify(userMusic));
        loadUploadedTracks();
        showNotification('‚úÖ Track deleted');
    }
}

// Add Online Track
function addOnlineTrack() {
    const input = document.getElementById('onlineUrlInput');
    const url = input.value.trim();

    if (!url) {
        showNotification('‚ö†Ô∏è Please enter a URL');
        return;
    }

    if (!url.includes('youtube.com') && !url.includes('youtu.be') && !url.includes('soundcloud.com')) {
        showNotification('‚ö†Ô∏è Only YouTube and SoundCloud links supported');
        return;
    }

    const track = {
        id: 'online_' + Date.now(),
        title: 'Online Track ' + new Date().toLocaleTimeString(),
        artist: 'Online',
        category: 'Online',
        source: 'online',
        url: url
    };

    let onlineTracks = JSON.parse(localStorage.getItem('online_music') || '[]');
    onlineTracks.push(track);
    localStorage.setItem('online_music', JSON.stringify(onlineTracks));

    input.value = '';
    loadOnlineTracks();
    showNotification('‚úÖ Online track added');
}

// Load Online Tracks
function loadOnlineTracks() {
    const onlineTracks = JSON.parse(localStorage.getItem('online_music') || '[]');
    const container = document.getElementById('onlineTracksList');

    if (onlineTracks.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 1rem; opacity: 0.5;">No online tracks added yet</div>';
        return;
    }

    container.innerHTML = onlineTracks.map(track => `
        <div class="track-item" onclick="playOnlineTrack('${track.id}')">
            <div class="track-item-info">
                <div class="track-item-title">${track.title}</div>
                <div class="track-item-details">YouTube/SoundCloud</div>
            </div>
            <div class="track-item-actions">
                <button class="track-action-btn" onclick="deleteOnlineTrack('${track.id}'); event.stopPropagation();">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
}

function playOnlineTrack(trackId) {
    const onlineTracks = JSON.parse(localStorage.getItem('online_music') || '[]');
    const track = onlineTracks.find(t => t.id === trackId);

    if (track) {
        currentPlaylist = [track, ...currentPlaylist.filter(t => t.id !== trackId)];
        currentTrackIndex = 0;
        playCurrentTrack();
        updatePlaylistDisplay();
    }
}

function deleteOnlineTrack(trackId) {
    if (confirm('Remove this track?')) {
        let onlineTracks = JSON.parse(localStorage.getItem('online_music') || '[]');
        onlineTracks = onlineTracks.filter(t => t.id !== trackId);
        localStorage.setItem('online_music', JSON.stringify(onlineTracks));
        loadOnlineTracks();
        showNotification('‚úÖ Track removed');
    }
}

// Clear Playlist
function clearPlaylist() {
    if (confirm('Clear entire playlist?')) {
        currentPlaylist = [];
        currentTrackIndex = 0;
        stopMusic();
        updatePlaylistDisplay();
        showNotification('‚úÖ Playlist cleared');
    }
}

// Remove from Playlist
function removeFromPlaylist(index) {
    currentPlaylist.splice(index, 1);

    if (index === currentTrackIndex) {
        stopMusic();
        if (currentPlaylist.length > 0) {
            currentTrackIndex = Math.min(index, currentPlaylist.length - 1);
        }
    } else if (index < currentTrackIndex) {
        currentTrackIndex--;
    }

    updatePlaylistDisplay();
}

// Library Tab Switching
function showLibraryTab(tab) {
    // Update tabs
    document.querySelectorAll('.lib-tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');

    // Update content
    document.querySelectorAll('.library-tab-content').forEach(c => c.classList.remove('active'));

    const tabMap = {
        'internal': 'internalLibrary',
        'upload': 'uploadLibrary',
        'online': 'onlineLibrary',
        'playlist': 'playlistLibrary'
    };

    document.getElementById(tabMap[tab]).classList.add('active');
}

// Filter Tracks
function filterTracks(query) {
    const trackItems = document.querySelectorAll('#trackList .track-item');
    query = query.toLowerCase();

    trackItems.forEach(item => {
        const title = item.querySelector('.track-item-title').textContent.toLowerCase();
        const details = item.querySelector('.track-item-details').textContent.toLowerCase();
        const matches = title.includes(query) || details.includes(query);
        item.style.display = matches ? 'flex' : 'none';
    });
}

// Get current page content for audio reading
function getCurrentPageContent() {
    // Check if lesson modal is open
    const lessonModal = document.getElementById('lessonModal');
    const isModalOpen = lessonModal && lessonModal.style.display !== 'none' &&
                        window.getComputedStyle(lessonModal).display !== 'none';

    if (isModalOpen) {
        // Read from modal
        const modalTitle = document.getElementById('modalLessonTitle')?.textContent || '';
        const modalContent = document.getElementById('modalLessonContent')?.innerHTML || '';
        const modalActivity = document.getElementById('modalLessonActivity')?.innerHTML || '';
        const modalAssignment = document.getElementById('modalLessonAssignment')?.innerHTML || '';

        return {
            type: 'lesson',
            title: modalTitle,
            content: `${modalContent}\n\nActivity: ${modalActivity}\n\nAssignment: ${modalAssignment}`,
            session: typeof currentSession !== 'undefined' ? currentSession : 'morning'
        };
    }

    // Get current session and lesson card content if visible
    const session = typeof currentSession !== 'undefined' ? currentSession : 'morning';
    const lessonTitle = document.getElementById('lessonTitle')?.textContent || 'Current Lesson';

    // Try to get intro/welcome text if on main page
    const chatMessages = document.querySelectorAll('.chat-message');
    let welcomeContent = '';
    chatMessages.forEach(msg => {
        if (msg.classList.contains('coach') && msg.textContent.includes('Welcome')) {
            welcomeContent += msg.textContent + '\n\n';
        }
    });

    return {
        type: 'introduction',
        title: lessonTitle,
        content: welcomeContent || `You are viewing ${session} session lessons. Please open a specific lesson to hear its audio content.`,
        session: session
    };
}

// Read current page content with Text-to-Speech
function readCurrentPage() {
    console.log('üìñ readCurrentPage called');

    const pageContent = getCurrentPageContent();
    console.log('üéôÔ∏è Reading current page:', pageContent.type);
    console.log('üìÑ Page content:', pageContent);

    // Strip HTML tags from content
    const cleanContent = stripHtmlTags(pageContent.content);
    console.log('üßπ Cleaned content length:', cleanContent.length);

    if (!cleanContent || cleanContent.trim().length === 0) {
        console.warn('‚ö†Ô∏è No content to read');
        showNotification('‚ö†Ô∏è No content available to read');
        return;
    }

    // Build narration
    const fullText = `
        ${pageContent.title}.

        ${cleanContent}
    `.trim();

    console.log('üé§ Full text to read:', fullText.substring(0, 200) + '...');

    // Stop any currently playing music
    stopMusic();

    // Stop any existing TTS
    if (typeof stopAudio === 'function') {
        stopAudio();
    }

    // Wait for voices to load
    const speakText = () => {
        // Create new speech synthesis utterance
        const utterance = new SpeechSynthesisUtterance(fullText);
        utterance.rate = 0.9;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;

        // Get available voices
        const voices = speechSynthesis.getVoices();
        console.log('üé§ Available voices:', voices.length);

        if (voices.length > 0) {
            // Try to use a good English voice
            const preferredVoice =
                voices.find(v => v.name.includes('Luke') && v.lang.startsWith('en')) ||
                voices.find(v => v.lang === 'en-ZA') ||
                voices.find(v => v.lang.startsWith('en-GB')) ||
                voices.find(v => v.lang.startsWith('en'));

            if (preferredVoice) {
                utterance.voice = preferredVoice;
                console.log('üé§ Using voice:', preferredVoice.name);
            }
        }

        // Play the audio
        speechSynthesis.cancel(); // Clear any pending speech

        utterance.onstart = () => {
            console.log('üéôÔ∏è Speech started');
            showNotification(`üéôÔ∏è Now reading: ${pageContent.title}`);
        };

        utterance.onend = () => {
            console.log('‚úÖ Speech finished');
            showNotification('‚úÖ Finished reading page content');
        };

        utterance.onerror = (event) => {
            console.error('üî¥ Speech synthesis error:', event);
            showNotification('‚ö†Ô∏è Error reading page content');
        };

        console.log('‚ñ∂Ô∏è Starting speech synthesis...');
        speechSynthesis.speak(utterance);
    };

    // Ensure voices are loaded before speaking
    if (speechSynthesis.getVoices().length === 0) {
        console.log('‚è≥ Waiting for voices to load...');
        speechSynthesis.addEventListener('voiceschanged', speakText, { once: true });
    } else {
        speakText();
    }
}

// Switch Audio Mode
function switchAudioMode(mode) {
    console.log('üîÑ Switching audio mode to:', mode);
    currentAudioMode = mode;

    document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));

    const lessonInfoPanel = document.getElementById('lessonAudioInfo');

    if (mode === 'lesson') {
        document.getElementById('lessonModeTab').classList.add('active');
        stopMusic();

        // Update Now Playing display
        document.getElementById('currentTrackTitle').textContent = 'Lesson Audio Mode';
        document.getElementById('currentTrackArtist').textContent = 'Preparing to read...';
        document.getElementById('albumArt').innerHTML = '<i class="fas fa-book-reader"></i>';

        // Show lesson audio info panel
        if (lessonInfoPanel) {
            lessonInfoPanel.style.display = 'block';
        }

        console.log('üéôÔ∏è About to call readCurrentPage()');

        // Automatically read current page content
        setTimeout(() => {
            readCurrentPage();
        }, 500); // Small delay to ensure UI updates

        showNotification('üéôÔ∏è Switched to Lesson Audio mode');
    } else {
        document.getElementById('musicModeTab').classList.add('active');

        // Reset Now Playing display
        if (currentPlaylist.length > 0 && currentTrackIndex < currentPlaylist.length) {
            const track = currentPlaylist[currentTrackIndex];
            document.getElementById('currentTrackTitle').textContent = track.title;
            document.getElementById('currentTrackArtist').textContent = track.artist || track.category;
        } else {
            document.getElementById('currentTrackTitle').textContent = 'Select a track to play';
            document.getElementById('currentTrackArtist').textContent = 'Coach Manlaw Library';
        }
        document.getElementById('albumArt').innerHTML = '<i class="fas fa-music"></i>';

        // Hide lesson audio info panel
        if (lessonInfoPanel) {
            lessonInfoPanel.style.display = 'none';
        }

        // Stop lesson TTS
        console.log('üõë Stopping lesson audio');
        if (speechSynthesis.speaking || speechSynthesis.pending) {
            speechSynthesis.cancel();
        }
        if (typeof stopAudio === 'function') {
            stopAudio();
        }

        showNotification('üéµ Switched to Music mode');
    }
}

// Player Visibility
function closeMusicPlayer() {
    document.getElementById('musicPlayerFloat').style.display = 'none';
    if (isPlaying) {
        document.getElementById('musicPlayerMinimized').style.display = 'flex';
    }
}

function minimizeMusicPlayer() {
    document.getElementById('musicPlayerFloat').style.display = 'none';
    document.getElementById('musicPlayerMinimized').style.display = 'flex';
}

function expandMusicPlayer() {
    document.getElementById('musicPlayerFloat').style.display = 'flex';
    document.getElementById('musicPlayerMinimized').style.display = 'none';
}

// Force initialize playlist (manual button)
function forceInitPlaylist() {
    console.log('üîÑ Force initializing playlist...');

    currentPlaylist = [...musicLibrary];
    currentTrackIndex = 0;

    console.log('‚úÖ Force-loaded', currentPlaylist.length, 'tracks from library');

    updatePlaylistDisplay();
    showNotification(`‚úÖ Loaded ${currentPlaylist.length} tracks to playlist!`);

    // Also update count in header
    const countDisplay = document.getElementById('playlistCount');
    if (countDisplay) {
        countDisplay.textContent = `${currentPlaylist.length} tracks`;
    }
}

// Show Player (for button in main interface)
function showMusicPlayer() {
    console.log('üéµ showMusicPlayer called');

    document.getElementById('musicPlayerFloat').style.display = 'flex';
    document.getElementById('musicPlayerMinimized').style.display = 'none';

    // Force re-check playlist on show
    if (currentPlaylist.length === 0) {
        console.log('‚ö†Ô∏è Playlist empty on show, forcing populate...');
        forceInitPlaylist();
    } else {
        console.log('‚úÖ Playlist already has', currentPlaylist.length, 'tracks');
        // Still update display in case UI is out of sync
        updatePlaylistDisplay();
    }
}

// Utility Functions
function shuffleArray(array) {
    const newArray = [...array];
    for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
    }
    return newArray;
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function showNotification(message) {
    // Simple notification (can be enhanced)
    console.log('üì¢', message);

    // Optional: Create toast notification
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 100px;
        right: 20px;
        background: linear-gradient(135deg, rgba(10, 31, 68, 0.98), rgba(3, 11, 31, 0.98));
        color: var(--royal-gold);
        padding: 1rem 1.5rem;
        border-radius: 10px;
        border: 1px solid var(--royal-gold);
        z-index: 10001;
        font-weight: 600;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Save/Load Preferences
function saveMusicPreferences() {
    const prefs = {
        volume: musicVolume,
        repeatMode,
        shuffleEnabled,
        playlist: currentPlaylist.map(t => ({ id: t.id, source: t.source || 'library' })),
        currentTrackIndex
    };
    localStorage.setItem('music_prefs', JSON.stringify(prefs));
}

function loadMusicPreferences() {
    const saved = localStorage.getItem('music_prefs');
    if (saved) {
        const prefs = JSON.parse(saved);
        musicVolume = prefs.volume || 0.6;
        repeatMode = prefs.repeatMode || 'off';
        shuffleEnabled = prefs.shuffleEnabled || false;

        // Restore volume
        document.getElementById('volumeSlider').value = musicVolume * 100;
        setVolume(musicVolume * 100);

        // Restore controls state
        document.getElementById('shuffleBtn').classList.toggle('active', shuffleEnabled);
        document.getElementById('repeatBtn').classList.toggle('active', repeatMode !== 'off');
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('üéµ Music Player DOM Ready');

    // Wait a moment for other scripts to load
    setTimeout(initializeMusicPlayer, 1000);
});

// Export functions to global scope
window.initializeMusicPlayer = initializeMusicPlayer;
window.showMusicPlayer = showMusicPlayer;
window.closeMusicPlayer = closeMusicPlayer;
window.minimizeMusicPlayer = minimizeMusicPlayer;
window.expandMusicPlayer = expandMusicPlayer;
window.switchAudioMode = switchAudioMode;
window.togglePlayPause = togglePlayPause;
window.nextTrack = nextTrack;
window.previousTrack = previousTrack;
window.toggleShuffle = toggleShuffle;
window.toggleRepeat = toggleRepeat;
window.setVolume = setVolume;
window.toggleMute = toggleMute;
window.seekMusic = seekMusic;
window.showLibraryTab = showLibraryTab;
window.filterTracks = filterTracks;
window.handleMusicUpload = handleMusicUpload;
window.addOnlineTrack = addOnlineTrack;
window.clearPlaylist = clearPlaylist;
window.addAllTracksToPlaylist = addAllTracksToPlaylist;
window.getCurrentPageContent = getCurrentPageContent;
window.readCurrentPage = readCurrentPage;
window.forceInitPlaylist = forceInitPlaylist;

console.log('‚úÖ Music Player functions exported to global scope');
</script>
</body>

</html>