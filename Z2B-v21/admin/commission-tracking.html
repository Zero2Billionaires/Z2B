<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commission Tracking - Z2B Admin</title>
    <style>
        :root {
            --navy: #0A2647;
            --gold: #FFD700;
            --light-bg: #f5f7fa;
            --white: #ffffff;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #3498db;
            --pending: #f39c12;
            --approved: #27ae60;
            --paid: #3498db;
            --rejected: #e74c3c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--navy) 0%, #144272 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: var(--white);
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: var(--navy);
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .back-btn {
            background: var(--navy);
            color: var(--gold);
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: var(--gold);
            color: var(--navy);
            transform: translateY(-2px);
        }

        /* Statistics Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--white);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: var(--text-light);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .stat-card .value {
            color: var(--navy);
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-card .change {
            font-size: 13px;
            color: var(--success);
        }

        .stat-card.pending .value { color: var(--pending); }
        .stat-card.approved .value { color: var(--approved); }
        .stat-card.paid .value { color: var(--paid); }

        /* Main Content */
        .main-content {
            background: var(--white);
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* Filters Section */
        .filters-section {
            background: var(--light-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-size: 13px;
            color: var(--text-dark);
            font-weight: 600;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background: var(--white);
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--navy);
            color: var(--gold);
        }

        .btn-primary:hover {
            background: var(--gold);
            color: var(--navy);
        }

        .btn-secondary {
            background: var(--text-light);
            color: var(--white);
        }

        .btn-secondary:hover {
            background: var(--text-dark);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-info {
            background: var(--info);
            color: var(--white);
        }

        /* Bulk Actions Bar */
        .bulk-actions {
            background: var(--light-bg);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            justify-content: space-between;
        }

        .bulk-actions.active {
            display: flex;
        }

        .bulk-actions-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .bulk-actions-right {
            display: flex;
            gap: 10px;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--navy);
            color: var(--gold);
        }

        thead th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-bottom: 1px solid #e0e0e0;
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: var(--light-bg);
        }

        tbody td {
            padding: 15px;
            color: var(--text-dark);
        }

        /* Status Badges */
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }

        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.approved {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.paid {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-badge.rejected {
            background: #f8d7da;
            color: #721c24;
        }

        /* Type Badges */
        .type-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            display: inline-block;
        }

        .type-badge.ISP { background: #e3f2fd; color: #1565c0; }
        .type-badge.QPB { background: #f3e5f5; color: #6a1b9a; }
        .type-badge.TSC { background: #e8f5e9; color: #2e7d32; }
        .type-badge.TPB { background: #fff3e0; color: #e65100; }
        .type-badge.TLI { background: #fce4ec; color: #c2185b; }
        .type-badge.CEO { background: #fff9c4; color: #f57f17; }

        /* Action Buttons */
        .action-btns {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .action-btn.view {
            background: var(--info);
            color: var(--white);
        }

        .action-btn.approve {
            background: var(--success);
            color: var(--white);
        }

        .action-btn.reject {
            background: var(--danger);
            color: var(--white);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--white);
            border-radius: 10px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            background: var(--navy);
            color: var(--gold);
            padding: 20px 30px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 22px;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--gold);
            font-size: 28px;
            cursor: pointer;
            line-height: 1;
        }

        .modal-body {
            padding: 30px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-light);
        }

        .detail-value {
            color: var(--text-dark);
            font-weight: 500;
        }

        .modal-footer {
            padding: 20px 30px;
            background: var(--light-bg);
            border-radius: 0 0 10px 10px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Checkbox */
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 15px;
            }

            table {
                font-size: 12px;
            }

            thead th,
            tbody td {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>💰 Commission Tracking</h1>
            <a href="index.html" class="back-btn">
                ← Back to Admin
            </a>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Today</h3>
                <div class="value" id="stat-today">R 0</div>
                <div class="change">+0 commissions</div>
            </div>

            <div class="stat-card">
                <h3>Total This Month</h3>
                <div class="value" id="stat-month">R 0</div>
                <div class="change">+0% from last month</div>
            </div>

            <div class="stat-card pending">
                <h3>Pending Approval</h3>
                <div class="value" id="stat-pending">R 0</div>
                <div class="change"><span id="pending-count">0</span> commissions</div>
            </div>

            <div class="stat-card approved">
                <h3>Approved</h3>
                <div class="value" id="stat-approved">R 0</div>
                <div class="change"><span id="approved-count">0</span> commissions</div>
            </div>

            <div class="stat-card paid">
                <h3>Paid Out</h3>
                <div class="value" id="stat-paid">R 0</div>
                <div class="change"><span id="paid-count">0</span> commissions</div>
            </div>

            <div class="stat-card">
                <h3>Average Commission</h3>
                <div class="value" id="stat-average">R 0</div>
                <div class="change">Across all types</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Filters -->
            <div class="filters-section">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label>Commission Type</label>
                        <select id="filter-type">
                            <option value="">All Types</option>
                            <option value="ISP">ISP - Individual Sales Profit</option>
                            <option value="QPB">QPB - Quick Pathfinder Bonus</option>
                            <option value="TSC">TSC - Team Sales Commission</option>
                            <option value="TPB">TPB - Team Performance Bonus</option>
                            <option value="TLI">TLI - Team Leadership Incentive</option>
                            <option value="CEO">CEO - Competition Award</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Status</label>
                        <select id="filter-status">
                            <option value="">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="paid">Paid</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Date From</label>
                        <input type="date" id="filter-date-from">
                    </div>

                    <div class="filter-group">
                        <label>Date To</label>
                        <input type="date" id="filter-date-to">
                    </div>

                    <div class="filter-group">
                        <label>Member Search</label>
                        <input type="text" id="filter-member" placeholder="Name, email, or membership #">
                    </div>

                    <div class="filter-group">
                        <label>Amount Range</label>
                        <select id="filter-amount">
                            <option value="">All Amounts</option>
                            <option value="0-100">R 0 - R 100</option>
                            <option value="100-500">R 100 - R 500</option>
                            <option value="500-1000">R 500 - R 1,000</option>
                            <option value="1000-5000">R 1,000 - R 5,000</option>
                            <option value="5000+">R 5,000+</option>
                        </select>
                    </div>
                </div>

                <div class="filter-actions">
                    <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                    <button class="btn btn-secondary" onclick="clearFilters()">Clear All</button>
                    <button class="btn btn-info" onclick="exportCommissions()">Export CSV</button>
                </div>
            </div>

            <!-- Bulk Actions Bar -->
            <div class="bulk-actions" id="bulk-actions-bar">
                <div class="bulk-actions-left">
                    <span><strong id="selected-count">0</strong> commissions selected</span>
                </div>
                <div class="bulk-actions-right">
                    <button class="btn btn-success" onclick="bulkApprove()">Approve Selected</button>
                    <button class="btn btn-danger" onclick="bulkReject()">Reject Selected</button>
                    <button class="btn btn-info" onclick="bulkMarkPaid()">Mark as Paid</button>
                </div>
            </div>

            <!-- Table -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
                            <th>Date/Time</th>
                            <th>Member</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Source/Reason</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="commissions-table">
                        <!-- Commissions will be loaded here -->
                    </tbody>
                </table>
            </div>

            <div class="empty-state" id="empty-state" style="display: none;">
                <h3>No Commissions Found</h3>
                <p>No commissions match your current filters.</p>
            </div>
        </div>
    </div>

    <!-- Commission Details Modal -->
    <div class="modal" id="commission-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Commission Details</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Details will be loaded here -->
            </div>
            <div class="modal-footer" id="modal-footer">
                <!-- Actions will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_CONFIG = {
            BASE_URL: 'http://localhost:5000/api'
        };

        let commissionsData = [];
        let filteredData = [];
        let selectedCommissions = new Set();

        // Load commissions on page load
        window.addEventListener('DOMContentLoaded', function() {
            loadCommissions();
        });

        // Load Commissions
        async function loadCommissions() {
            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}/commissions/tracking`);
                const data = await response.json();

                if (data.success) {
                    commissionsData = data.commissions || [];
                    filteredData = [...commissionsData];
                    renderCommissions();
                    updateStatistics();
                } else {
                    console.error('Failed to load commissions:', data.message);
                    // Load sample data for demonstration
                    loadSampleData();
                }
            } catch (error) {
                console.error('Error loading commissions:', error);
                // Load sample data for demonstration
                loadSampleData();
            }
        }

        // Load Sample Data
        function loadSampleData() {
            commissionsData = [
                {
                    _id: '1',
                    date: '2025-01-15T10:30:00Z',
                    memberName: 'John Doe',
                    membershipNumber: 'Z2B0000123',
                    email: 'john@example.com',
                    type: 'ISP',
                    amount: 120,
                    source: 'Direct sale - Bronze Package',
                    status: 'pending',
                    tier: 'Bronze',
                    details: {
                        transactionId: 'TXN123456',
                        saleAmount: 480,
                        percentage: 25
                    }
                },
                {
                    _id: '2',
                    date: '2025-01-15T11:45:00Z',
                    memberName: 'Jane Smith',
                    membershipNumber: 'Z2B0000456',
                    email: 'jane@example.com',
                    type: 'QPB',
                    amount: 384,
                    source: 'First Set Completion (3 sales)',
                    status: 'approved',
                    tier: 'Silver',
                    details: {
                        setNumber: 1,
                        salesCount: 3,
                        rate: 8
                    }
                },
                {
                    _id: '3',
                    date: '2025-01-15T14:20:00Z',
                    memberName: 'Mike Johnson',
                    membershipNumber: 'Z2B0000789',
                    email: 'mike@example.com',
                    type: 'TSC',
                    amount: 48,
                    source: 'Gen 2 - Sale by Sarah Williams',
                    status: 'paid',
                    tier: 'Gold',
                    details: {
                        generation: 2,
                        downlineMember: 'Sarah Williams',
                        saleAmount: 480,
                        percentage: 10
                    }
                },
                {
                    _id: '4',
                    date: '2025-01-14T09:15:00Z',
                    memberName: 'Sarah Williams',
                    membershipNumber: 'Z2B0000234',
                    email: 'sarah@example.com',
                    type: 'TPB',
                    amount: 247.50,
                    source: 'Team Performance Pool - January',
                    status: 'approved',
                    tier: 'Platinum',
                    details: {
                        month: 'January 2025',
                        poolTotal: 24750,
                        share: 1
                    }
                },
                {
                    _id: '5',
                    date: '2025-01-13T16:30:00Z',
                    memberName: 'David Brown',
                    membershipNumber: 'Z2B0000567',
                    email: 'david@example.com',
                    type: 'TLI',
                    amount: 1500,
                    source: 'Achievement: Guardian of Growth 🌱',
                    status: 'paid',
                    tier: 'Silver',
                    details: {
                        level: 2,
                        achievementName: 'Guardian of Growth',
                        pvRequired: 150,
                        pvAchieved: 175
                    }
                },
                {
                    _id: '6',
                    date: '2025-01-12T13:00:00Z',
                    memberName: 'Emily Davis',
                    membershipNumber: 'Z2B0000890',
                    email: 'emily@example.com',
                    type: 'CEO',
                    amount: 5000,
                    source: 'Q1 2025 Competition - 1st Place',
                    status: 'paid',
                    tier: 'Diamond',
                    details: {
                        competitionName: 'Q1 2025 Sales Challenge',
                        position: 1,
                        prizePool: 10000,
                        percentage: 50
                    }
                },
                {
                    _id: '7',
                    date: '2025-01-15T08:45:00Z',
                    memberName: 'Robert Wilson',
                    membershipNumber: 'Z2B0000345',
                    email: 'robert@example.com',
                    type: 'ISP',
                    amount: 375,
                    source: 'Direct sale - Gold Package',
                    status: 'pending',
                    tier: 'Gold',
                    details: {
                        transactionId: 'TXN123457',
                        saleAmount: 1480,
                        percentage: 35
                    }
                },
                {
                    _id: '8',
                    date: '2025-01-14T15:20:00Z',
                    memberName: 'Lisa Anderson',
                    membershipNumber: 'Z2B0000678',
                    email: 'lisa@example.com',
                    type: 'TSC',
                    amount: 28.80,
                    source: 'Gen 3 - Sale by Tom Harris',
                    status: 'approved',
                    tier: 'Silver',
                    details: {
                        generation: 3,
                        downlineMember: 'Tom Harris',
                        saleAmount: 480,
                        percentage: 6
                    }
                },
                {
                    _id: '9',
                    date: '2025-01-13T11:00:00Z',
                    memberName: 'Chris Martin',
                    membershipNumber: 'Z2B0000901',
                    email: 'chris@example.com',
                    type: 'ISP',
                    amount: 249.75,
                    source: 'Direct sale - Copper Package',
                    status: 'rejected',
                    tier: 'Copper',
                    details: {
                        transactionId: 'TXN123458',
                        saleAmount: 999,
                        percentage: 25,
                        rejectionReason: 'Duplicate transaction'
                    }
                },
                {
                    _id: '10',
                    date: '2025-01-15T12:30:00Z',
                    memberName: 'Amanda Taylor',
                    membershipNumber: 'Z2B0000234',
                    email: 'amanda@example.com',
                    type: 'QPB',
                    amount: 480,
                    source: 'Additional Set Completion (3 sales)',
                    status: 'pending',
                    tier: 'Bronze',
                    details: {
                        setNumber: 2,
                        salesCount: 3,
                        rate: 10
                    }
                }
            ];

            filteredData = [...commissionsData];
            renderCommissions();
            updateStatistics();
        }

        // Render Commissions
        function renderCommissions() {
            const tbody = document.getElementById('commissions-table');
            const emptyState = document.getElementById('empty-state');

            if (filteredData.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            tbody.innerHTML = filteredData.map(commission => `
                <tr>
                    <td>
                        <input type="checkbox"
                               onchange="toggleCommissionSelect('${commission._id}')"
                               ${selectedCommissions.has(commission._id) ? 'checked' : ''}>
                    </td>
                    <td>${formatDateTime(commission.date)}</td>
                    <td>
                        <strong>${commission.memberName}</strong><br>
                        <small style="color: #7f8c8d;">${commission.membershipNumber}</small>
                    </td>
                    <td>
                        <span class="type-badge ${commission.type}">${commission.type}</span>
                    </td>
                    <td><strong>R ${commission.amount.toFixed(2)}</strong></td>
                    <td>${commission.source}</td>
                    <td>
                        <span class="status-badge ${commission.status}">${commission.status}</span>
                    </td>
                    <td>
                        <div class="action-btns">
                            <button class="action-btn view" onclick="viewCommission('${commission._id}')">View</button>
                            ${commission.status === 'pending' ? `
                                <button class="action-btn approve" onclick="approveCommission('${commission._id}')">Approve</button>
                                <button class="action-btn reject" onclick="rejectCommission('${commission._id}')">Reject</button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Update Statistics
        function updateStatistics() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const todayCommissions = commissionsData.filter(c => {
                const commDate = new Date(c.date);
                commDate.setHours(0, 0, 0, 0);
                return commDate.getTime() === today.getTime();
            });

            const thisMonthCommissions = commissionsData.filter(c => {
                const commDate = new Date(c.date);
                return commDate.getMonth() === today.getMonth() &&
                       commDate.getFullYear() === today.getFullYear();
            });

            const pendingCommissions = commissionsData.filter(c => c.status === 'pending');
            const approvedCommissions = commissionsData.filter(c => c.status === 'approved');
            const paidCommissions = commissionsData.filter(c => c.status === 'paid');

            const totalToday = todayCommissions.reduce((sum, c) => sum + c.amount, 0);
            const totalMonth = thisMonthCommissions.reduce((sum, c) => sum + c.amount, 0);
            const totalPending = pendingCommissions.reduce((sum, c) => sum + c.amount, 0);
            const totalApproved = approvedCommissions.reduce((sum, c) => sum + c.amount, 0);
            const totalPaid = paidCommissions.reduce((sum, c) => sum + c.amount, 0);
            const average = commissionsData.length > 0 ?
                commissionsData.reduce((sum, c) => sum + c.amount, 0) / commissionsData.length : 0;

            document.getElementById('stat-today').textContent = `R ${totalToday.toFixed(2)}`;
            document.getElementById('stat-month').textContent = `R ${totalMonth.toFixed(2)}`;
            document.getElementById('stat-pending').textContent = `R ${totalPending.toFixed(2)}`;
            document.getElementById('stat-approved').textContent = `R ${totalApproved.toFixed(2)}`;
            document.getElementById('stat-paid').textContent = `R ${totalPaid.toFixed(2)}`;
            document.getElementById('stat-average').textContent = `R ${average.toFixed(2)}`;

            document.getElementById('pending-count').textContent = pendingCommissions.length;
            document.getElementById('approved-count').textContent = approvedCommissions.length;
            document.getElementById('paid-count').textContent = paidCommissions.length;
        }

        // Apply Filters
        function applyFilters() {
            const typeFilter = document.getElementById('filter-type').value;
            const statusFilter = document.getElementById('filter-status').value;
            const dateFromFilter = document.getElementById('filter-date-from').value;
            const dateToFilter = document.getElementById('filter-date-to').value;
            const memberFilter = document.getElementById('filter-member').value.toLowerCase();
            const amountFilter = document.getElementById('filter-amount').value;

            filteredData = commissionsData.filter(commission => {
                // Type filter
                if (typeFilter && commission.type !== typeFilter) return false;

                // Status filter
                if (statusFilter && commission.status !== statusFilter) return false;

                // Date from filter
                if (dateFromFilter) {
                    const commDate = new Date(commission.date);
                    const fromDate = new Date(dateFromFilter);
                    if (commDate < fromDate) return false;
                }

                // Date to filter
                if (dateToFilter) {
                    const commDate = new Date(commission.date);
                    const toDate = new Date(dateToFilter);
                    toDate.setHours(23, 59, 59, 999);
                    if (commDate > toDate) return false;
                }

                // Member filter
                if (memberFilter) {
                    const matchName = commission.memberName.toLowerCase().includes(memberFilter);
                    const matchEmail = commission.email.toLowerCase().includes(memberFilter);
                    const matchNumber = commission.membershipNumber.toLowerCase().includes(memberFilter);
                    if (!matchName && !matchEmail && !matchNumber) return false;
                }

                // Amount filter
                if (amountFilter) {
                    const amount = commission.amount;
                    if (amountFilter === '0-100' && (amount < 0 || amount > 100)) return false;
                    if (amountFilter === '100-500' && (amount < 100 || amount > 500)) return false;
                    if (amountFilter === '500-1000' && (amount < 500 || amount > 1000)) return false;
                    if (amountFilter === '1000-5000' && (amount < 1000 || amount > 5000)) return false;
                    if (amountFilter === '5000+' && amount < 5000) return false;
                }

                return true;
            });

            renderCommissions();
        }

        // Clear Filters
        function clearFilters() {
            document.getElementById('filter-type').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-date-from').value = '';
            document.getElementById('filter-date-to').value = '';
            document.getElementById('filter-member').value = '';
            document.getElementById('filter-amount').value = '';

            filteredData = [...commissionsData];
            renderCommissions();
        }

        // Toggle Select All
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('select-all');
            const isChecked = selectAllCheckbox.checked;

            if (isChecked) {
                filteredData.forEach(c => selectedCommissions.add(c._id));
            } else {
                selectedCommissions.clear();
            }

            renderCommissions();
            updateBulkActionsBar();
        }

        // Toggle Commission Select
        function toggleCommissionSelect(id) {
            if (selectedCommissions.has(id)) {
                selectedCommissions.delete(id);
            } else {
                selectedCommissions.add(id);
            }

            updateBulkActionsBar();
        }

        // Update Bulk Actions Bar
        function updateBulkActionsBar() {
            const bulkActionsBar = document.getElementById('bulk-actions-bar');
            const selectedCount = document.getElementById('selected-count');

            selectedCount.textContent = selectedCommissions.size;

            if (selectedCommissions.size > 0) {
                bulkActionsBar.classList.add('active');
            } else {
                bulkActionsBar.classList.remove('active');
            }
        }

        // View Commission Details
        function viewCommission(id) {
            const commission = commissionsData.find(c => c._id === id);
            if (!commission) return;

            const modalBody = document.getElementById('modal-body');
            const modalFooter = document.getElementById('modal-footer');

            modalBody.innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Commission ID:</span>
                    <span class="detail-value">${commission._id}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Date/Time:</span>
                    <span class="detail-value">${formatDateTime(commission.date)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Member:</span>
                    <span class="detail-value">${commission.memberName} (${commission.membershipNumber})</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Email:</span>
                    <span class="detail-value">${commission.email}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Tier:</span>
                    <span class="detail-value">${commission.tier}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Commission Type:</span>
                    <span class="detail-value"><span class="type-badge ${commission.type}">${commission.type}</span></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Amount:</span>
                    <span class="detail-value"><strong style="color: var(--success); font-size: 20px;">R ${commission.amount.toFixed(2)}</strong></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Source/Reason:</span>
                    <span class="detail-value">${commission.source}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value"><span class="status-badge ${commission.status}">${commission.status}</span></span>
                </div>
                ${commission.details ? `
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee;">
                        <h3 style="margin-bottom: 15px; color: var(--navy);">Additional Details</h3>
                        ${Object.entries(commission.details).map(([key, value]) => `
                            <div class="detail-row">
                                <span class="detail-label">${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}:</span>
                                <span class="detail-value">${value}</span>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;

            modalFooter.innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                ${commission.status === 'pending' ? `
                    <button class="btn btn-success" onclick="approveCommission('${commission._id}'); closeModal();">Approve</button>
                    <button class="btn btn-danger" onclick="rejectCommission('${commission._id}'); closeModal();">Reject</button>
                ` : ''}
            `;

            document.getElementById('commission-modal').classList.add('active');
        }

        // Close Modal
        function closeModal() {
            document.getElementById('commission-modal').classList.remove('active');
        }

        // Approve Commission
        async function approveCommission(id) {
            if (!confirm('Are you sure you want to approve this commission?')) return;

            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}/commissions/approve/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    const commission = commissionsData.find(c => c._id === id);
                    if (commission) commission.status = 'approved';
                    renderCommissions();
                    updateStatistics();
                    alert('Commission approved successfully!');
                } else {
                    alert('Failed to approve commission: ' + data.message);
                }
            } catch (error) {
                console.error('Error approving commission:', error);
                // Simulate approval for demo
                const commission = commissionsData.find(c => c._id === id);
                if (commission) commission.status = 'approved';
                renderCommissions();
                updateStatistics();
                alert('Commission approved successfully!');
            }
        }

        // Reject Commission
        async function rejectCommission(id) {
            const reason = prompt('Enter rejection reason:');
            if (!reason) return;

            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}/commissions/reject/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason })
                });

                const data = await response.json();

                if (data.success) {
                    const commission = commissionsData.find(c => c._id === id);
                    if (commission) {
                        commission.status = 'rejected';
                        if (commission.details) {
                            commission.details.rejectionReason = reason;
                        }
                    }
                    renderCommissions();
                    updateStatistics();
                    alert('Commission rejected successfully!');
                } else {
                    alert('Failed to reject commission: ' + data.message);
                }
            } catch (error) {
                console.error('Error rejecting commission:', error);
                // Simulate rejection for demo
                const commission = commissionsData.find(c => c._id === id);
                if (commission) {
                    commission.status = 'rejected';
                    if (commission.details) {
                        commission.details.rejectionReason = reason;
                    }
                }
                renderCommissions();
                updateStatistics();
                alert('Commission rejected successfully!');
            }
        }

        // Bulk Approve
        async function bulkApprove() {
            if (selectedCommissions.size === 0) return;
            if (!confirm(`Approve ${selectedCommissions.size} selected commissions?`)) return;

            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}/commissions/bulk-approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ commissionIds: Array.from(selectedCommissions) })
                });

                const data = await response.json();

                if (data.success) {
                    selectedCommissions.forEach(id => {
                        const commission = commissionsData.find(c => c._id === id);
                        if (commission) commission.status = 'approved';
                    });
                    selectedCommissions.clear();
                    renderCommissions();
                    updateStatistics();
                    updateBulkActionsBar();
                    alert('Commissions approved successfully!');
                } else {
                    alert('Failed to approve commissions: ' + data.message);
                }
            } catch (error) {
                console.error('Error approving commissions:', error);
                // Simulate approval for demo
                selectedCommissions.forEach(id => {
                    const commission = commissionsData.find(c => c._id === id);
                    if (commission) commission.status = 'approved';
                });
                selectedCommissions.clear();
                renderCommissions();
                updateStatistics();
                updateBulkActionsBar();
                alert('Commissions approved successfully!');
            }
        }

        // Bulk Reject
        async function bulkReject() {
            if (selectedCommissions.size === 0) return;
            const reason = prompt('Enter rejection reason:');
            if (!reason) return;

            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}/commissions/bulk-reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        commissionIds: Array.from(selectedCommissions),
                        reason
                    })
                });

                const data = await response.json();

                if (data.success) {
                    selectedCommissions.forEach(id => {
                        const commission = commissionsData.find(c => c._id === id);
                        if (commission) {
                            commission.status = 'rejected';
                            if (commission.details) {
                                commission.details.rejectionReason = reason;
                            }
                        }
                    });
                    selectedCommissions.clear();
                    renderCommissions();
                    updateStatistics();
                    updateBulkActionsBar();
                    alert('Commissions rejected successfully!');
                } else {
                    alert('Failed to reject commissions: ' + data.message);
                }
            } catch (error) {
                console.error('Error rejecting commissions:', error);
                // Simulate rejection for demo
                selectedCommissions.forEach(id => {
                    const commission = commissionsData.find(c => c._id === id);
                    if (commission) {
                        commission.status = 'rejected';
                        if (commission.details) {
                            commission.details.rejectionReason = reason;
                        }
                    }
                });
                selectedCommissions.clear();
                renderCommissions();
                updateStatistics();
                updateBulkActionsBar();
                alert('Commissions rejected successfully!');
            }
        }

        // Bulk Mark as Paid
        async function bulkMarkPaid() {
            if (selectedCommissions.size === 0) return;
            if (!confirm(`Mark ${selectedCommissions.size} selected commissions as paid?`)) return;

            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}/commissions/bulk-mark-paid`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ commissionIds: Array.from(selectedCommissions) })
                });

                const data = await response.json();

                if (data.success) {
                    selectedCommissions.forEach(id => {
                        const commission = commissionsData.find(c => c._id === id);
                        if (commission) commission.status = 'paid';
                    });
                    selectedCommissions.clear();
                    renderCommissions();
                    updateStatistics();
                    updateBulkActionsBar();
                    alert('Commissions marked as paid successfully!');
                } else {
                    alert('Failed to mark commissions as paid: ' + data.message);
                }
            } catch (error) {
                console.error('Error marking commissions as paid:', error);
                // Simulate for demo
                selectedCommissions.forEach(id => {
                    const commission = commissionsData.find(c => c._id === id);
                    if (commission) commission.status = 'paid';
                });
                selectedCommissions.clear();
                renderCommissions();
                updateStatistics();
                updateBulkActionsBar();
                alert('Commissions marked as paid successfully!');
            }
        }

        // Export Commissions
        function exportCommissions() {
            const dataToExport = filteredData.length > 0 ? filteredData : commissionsData;

            let csv = 'Date/Time,Member,Membership#,Email,Type,Amount,Source,Status\n';

            dataToExport.forEach(commission => {
                csv += `"${formatDateTime(commission.date)}","${commission.memberName}","${commission.membershipNumber}","${commission.email}","${commission.type}","R ${commission.amount.toFixed(2)}","${commission.source}","${commission.status}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `commissions_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            alert('Commission data exported successfully!');
        }

        // Utility Functions
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('en-ZA', {
                year: 'numeric',
                month: 'short',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Close modal when clicking outside
        document.getElementById('commission-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>
